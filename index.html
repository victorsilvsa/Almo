<!doctype html>
<html lang="pt-BR">
 <head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Sistema de Almoxarifado</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&amp;display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.20.1/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://unpkg.com/html5-qrcode@2.3.8/html5-qrcode.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
  <style>
    body {
      box-sizing: border-box;
    }
    
    *, *::before, *::after {
      box-sizing: inherit;
      margin: 0;
      padding: 0;
    }
    
    :root {
      --primary-start: #0d47a1;
      --primary-mid: #1976d2;
      --primary-end: #42a5f5;
      --primary-gradient: linear-gradient(135deg, #0d47a1, #1976d2, #42a5f5);
      --surface: #ffffff;
      --text-main: #1e293b;
      --text-muted: #64748b;
      --danger: #ef4444;
      --warning: #f59e0b;
      --success: #10b981;
      --info: #3b82f6;
    }
    
    html, body {
      height: 100%;
      width: 100%;
      font-family: 'Inter', sans-serif;
      background: radial-gradient(circle at top right, #f8fafc, #e2e8f0);
      color: var(--text-main);
      overflow-x: hidden;
    }
    
    /* Animaç��es */
    @keyframes slideUp {
      0% {
        opacity: 0;
        transform: translateY(20px);
      }
      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    @keyframes fadeIn {
      from { opacity: 0; }
      to { opacity: 1; }
    }
    
    @keyframes pulse {
      0%, 100% { transform: scale(1); }
      50% { transform: scale(1.05); }
    }
    
    @keyframes scanline {
      0% { top: 0; }
      50% { top: 100%; }
      100% { top: 0; }
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    @keyframes borderBlink {
      0%, 100% { border-color: var(--success); }
      50% { border-color: #34d399; }
    }
    
    .page-enter {
      animation: slideUp 0.4s ease-out;
    }
    
    /* Login Screen */
    .login-container {
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .login-card {
      background: var(--surface);
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0,0,0,0.1);
      overflow: hidden;
      max-width: 900px;
      width: 100%;
      display: grid;
      grid-template-columns: 1fr 1fr;
    }
    
    .login-brand {
      background: var(--primary-gradient);
      padding: 60px 40px;
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      color: white;
    }
    
    .login-brand i {
      font-size: 80px;
      margin-bottom: 20px;
      animation: pulse 2s ease-in-out infinite;
    }
    
    .login-brand h1 {
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .login-brand p {
      opacity: 0.9;
      text-align: center;
    }
    
    .login-form-container {
      padding: 60px 40px;
    }
    
    .login-tabs {
      display: flex;
      gap: 10px;
      margin-bottom: 30px;
    }
    
    .login-tab {
      flex: 1;
      padding: 12px;
      border: none;
      background: #f1f5f9;
      color: var(--text-muted);
      border-radius: 10px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
    }
    
    .login-tab.active {
      background: var(--primary-gradient);
      color: white;
    }
    
    .form-group {
      margin-bottom: 20px;
      position: relative;
    }
    
    .form-group label {
      display: block;
      margin-bottom: 8px;
      font-weight: 600;
      color: var(--text-main);
      font-size: 14px;
    }
    
    .input-with-icon {
      position: relative;
    }
    
    .input-with-icon i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }
    
    .form-group input, .form-group select, .form-group textarea {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
      transition: all 0.3s;
      font-family: 'Inter', sans-serif;
    }
    
    .form-group textarea {
      min-height: 100px;
      resize: vertical;
    }
    
    .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
      outline: none;
      border-color: var(--primary-mid);
      box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
    }
    
    .btn {
      width: 100%;
      padding: 14px;
      border: none;
      border-radius: 12px;
      font-weight: 600;
      font-size: 15px;
      cursor: pointer;
      transition: all 0.3s;
    }
    
    .btn-primary {
      background: var(--primary-gradient);
      color: white;
      box-shadow: 0 4px 14px rgba(25, 118, 210, 0.3);
    }
    
    .btn-primary:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(25, 118, 210, 0.4);
    }
    
    /* Main Layout */
    .main-layout {
      display: flex;
      height: 100%;
      width: 100%;
    }
    
    .sidebar {
      width: 280px;
      background: rgba(255, 255, 255, 0.9);
      backdrop-filter: blur(12px);
      border-right: 1px solid #e2e8f0;
      padding: 30px 0;
      display: flex;
      flex-direction: column;
    }
    
    .sidebar-header {
      padding: 0 30px 30px;
      border-bottom: 1px solid #e2e8f0;
    }
    
    .sidebar-brand {
      display: flex;
      align-items: center;
      gap: 15px;
    }
    
    .sidebar-brand i {
      font-size: 32px;
      background: var(--primary-gradient);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .sidebar-brand h2 {
      font-size: 20px;
      font-weight: 700;
    }
    
    .sidebar-menu {
      flex: 1;
      padding: 20px 0;
      overflow-y: auto;
    }
    
    .menu-item {
      padding: 14px 30px;
      display: flex;
      align-items: center;
      gap: 15px;
      cursor: pointer;
      transition: all 0.3s;
      color: var(--text-main);
      font-weight: 500;
      border-left: 3px solid transparent;
    }
    
    .menu-item:hover {
      background: #f8fafc;
    }
    
    .menu-item.active {
      background: linear-gradient(90deg, rgba(25, 118, 210, 0.1), transparent);
      border-left-color: var(--primary-mid);
      color: var(--primary-mid);
    }
    
    .menu-item i {
      font-size: 18px;
      width: 20px;
    }
    
    .sidebar-footer {
      padding: 20px 30px;
      border-top: 1px solid #e2e8f0;
    }
    
    .user-info {
      display: flex;
      align-items: center;
      gap: 12px;
    }
    
    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: var(--primary-gradient);
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-weight: 700;
    }
    
    .user-details h4 {
      font-size: 14px;
      font-weight: 600;
    }
    
    .user-details p {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .main-content {
      flex: 1;
      overflow-y: auto;
      padding: 30px;
    }
    
    /* Mobile Header */
    .mobile-header {
      display: none;
      position: sticky;
      top: 0;
      background: var(--surface);
      padding: 15px 20px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      z-index: 100;
      justify-content: space-between;
      align-items: center;
    }
    
    .mobile-header h2 {
      font-size: 18px;
      font-weight: 700;
    }
    
    /* Bottom Navigation */
    .bottom-nav {
      display: none;
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      width: 100%;
      background: rgba(255, 255, 255, 0.98);
      backdrop-filter: blur(12px);
      border-top: 1px solid #e2e8f0;
      padding: 8px 15px 8px 15px;
      box-shadow: 0 -2px 20px rgba(0,0,0,0.08);
      z-index: 1000;
    }
    
    .bottom-nav-items {
      display: flex;
      justify-content: space-around;
      align-items: center;
      width: 100%;
      gap: 5px;
    }
    
    .bottom-nav-item {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.3s;
      padding: 6px 8px;
      border-radius: 10px;
      flex: 1;
      max-width: 80px;
    }
    
    .bottom-nav-item i {
      font-size: 22px;
    }
    
    .bottom-nav-item span {
      font-size: 10px;
      font-weight: 600;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      width: 100%;
      text-align: center;
    }
    
    .bottom-nav-item.active {
      background: rgba(30, 64, 175, 0.1);
    }
    
    .bottom-nav-item[data-page="products"].active i,
    .bottom-nav-item[data-page="products"].active span {
      color: #1e40af;
    }
    
    .bottom-nav-item[data-page="scanner"].active i,
    .bottom-nav-item[data-page="scanner"].active span {
      color: #3b82f6;
    }
    
    .bottom-nav-item[data-page="dashboard"].active i,
    .bottom-nav-item[data-page="dashboard"].active span {
      color: #0ea5e9;
    }
    
    .bottom-nav-item[data-page="nfe"].active i,
    .bottom-nav-item[data-page="nfe"].active span {
      color: #0284c7;
    }
    
    .bottom-nav-item[data-page="upload"].active i,
    .bottom-nav-item[data-page="upload"].active span {
      color: #0369a1;
    }
    
    .bottom-nav-item[data-page="users"].active i,
    .bottom-nav-item[data-page="users"].active span {
      color: #475569;
    }
    
    .bottom-nav-item[data-page="reports"].active i,
    .bottom-nav-item[data-page="reports"].active span {
      color: #64748b;
    }
    
    /* Stats Cards */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .stat-card {
      background: var(--surface);
      padding: 24px;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    
    .stat-card:hover {
      transform: translateY(-5px);
      box-shadow: 0 8px 25px rgba(0,0,0,0.1);
    }
    
    .stat-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 15px;
    }
    
    .stat-icon {
      width: 50px;
      height: 50px;
      border-radius: 12px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 24px;
      color: white;
    }
    
    .stat-value {
      font-size: 28px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .stat-label {
      font-size: 14px;
      color: var(--text-muted);
    }
    
    /* Products */
    .products-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 20px;
      flex-wrap: wrap;
      gap: 15px;
    }
    
    .search-box {
      flex: 1;
      min-width: 250px;
      position: relative;
    }
    
    .search-box input {
      width: 100%;
      padding: 12px 15px 12px 45px;
      border: 1.5px solid #e2e8f0;
      border-radius: 10px;
      font-size: 14px;
    }
    
    .search-box i {
      position: absolute;
      left: 15px;
      top: 50%;
      transform: translateY(-50%);
      color: var(--text-muted);
    }
    
    .view-toggle {
      display: flex;
      gap: 5px;
      background: #f1f5f9;
      padding: 5px;
      border-radius: 10px;
    }
    
    .view-btn {
      padding: 8px 15px;
      border: none;
      background: transparent;
      border-radius: 8px;
      cursor: pointer;
      color: var(--text-muted);
      transition: all 0.3s;
    }
    
    .view-btn.active {
      background: var(--surface);
      color: var(--primary-mid);
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    
    .products-grid {
      display: grid;
      grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }
    
    .products-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
      margin-bottom: 30px;
    }
    
    .product-card {
      background: var(--surface);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    
    .product-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    
    .product-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 15px;
    }
    
    .product-code {
      font-size: 12px;
      font-weight: 700;
      color: var(--text-muted);
      background: #f1f5f9;
      padding: 4px 10px;
      border-radius: 6px;
    }
    
    .product-status {
      font-size: 11px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 20px;
    }
    
    .status-normal {
      background: #dcfce7;
      color: #166534;
    }
    
    .status-warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .status-low {
      background: #fed7aa;
      color: #9a3412;
    }
    
    .status-empty {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .product-name {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 15px;
    }
    
    .product-info {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-bottom: 15px;
      padding: 15px;
      background: #f8fafc;
      border-radius: 10px;
    }
    
    .info-item {
      display: flex;
      flex-direction: column;
    }
    
    .info-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 3px;
    }
    
    .info-value {
      font-size: 15px;
      font-weight: 700;
    }
    
    .product-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-small {
      flex: 1;
      min-width: 100px;
      padding: 8px 12px;
      font-size: 12px;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
    }
    
    .btn-success {
      background: var(--success);
      color: white;
    }
    
    .btn-info {
      background: var(--info);
      color: white;
    }
    
    .btn-warning {
      background: var(--warning);
      color: white;
    }
    
    .btn-danger {
      background: var(--danger);
      color: white;
    }
    
    .btn-small:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0,0,0,0.15);
    }
    
    /* List View */
    .product-list-item {
      background: var(--surface);
      padding: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 20px;
      align-items: center;
    }
    
    .product-list-qr {
      width: 80px;
      height: 80px;
      border-radius: 8px;
      overflow: hidden;
      background: #f8fafc;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .product-list-qr img {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    
    .product-list-details {
      flex: 1;
    }
    
    .product-list-header {
      display: flex;
      align-items: center;
      gap: 15px;
      margin-bottom: 10px;
    }
    
    .product-list-info {
      display: flex;
      gap: 30px;
      margin-top: 10px;
    }
    
    /* Pagination com números */
    .pagination {
      display: flex;
      justify-content: center;
      align-items: center;
      gap: 5px;
      margin-top: 30px;
      flex-wrap: wrap;
    }
    
    .pagination button {
      min-width: 40px;
      height: 40px;
      padding: 0 12px;
      border: 1.5px solid #e2e8f0;
      background: var(--surface);
      border-radius: 8px;
      cursor: pointer;
      font-weight: 600;
      transition: all 0.3s;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    
    .pagination button:hover:not(:disabled):not(.active) {
      border-color: var(--primary-mid);
      color: var(--primary-mid);
      transform: translateY(-2px);
    }
    
    .pagination button:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    .pagination button.active {
      background: var(--primary-gradient);
      color: white;
      border-color: transparent;
      box-shadow: 0 4px 12px rgba(25, 118, 210, 0.3);
    }
    
    .pagination .page-dots {
      color: var(--text-muted);
      font-weight: 700;
      padding: 0 5px;
    }
    
    /* Modal */
    .modal-backdrop {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.5);
      backdrop-filter: blur(5px);
      z-index: 2000;
      align-items: center;
      justify-content: center;
      padding: 20px;
    }
    
    .modal-backdrop.active {
      display: flex;
    }
    
    .modal-content {
      background: var(--surface);
      border-radius: 20px;
      max-width: 500px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      animation: slideUp 0.3s ease-out;
    }
    
    .modal-header {
      padding: 25px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .modal-header h3 {
      font-size: 20px;
      font-weight: 700;
    }
    
    .modal-close {
      width: 35px;
      height: 35px;
      border: none;
      background: #f1f5f9;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.3s;
    }
    
    .modal-close:hover {
      background: #e2e8f0;
    }
    
    .modal-body {
      padding: 25px;
    }
    
    .modal-footer {
      padding: 20px 25px;
      border-top: 1px solid #e2e8f0;
      display: flex;
      gap: 10px;
      justify-content: flex-end;
    }
    
    /* Scanner & NFe Camera */
    .camera-container {
      position: relative;
      width: 100%;
      max-width: 500px;
      margin: 0 auto 30px;
      border-radius: 16px;
      overflow: hidden;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      border: 4px solid #cbd5e1;
      transition: border-color 0.3s;
    }
    
    .camera-container.success {
      border-color: var(--success);
      animation: borderBlink 0.5s ease-in-out 3;
    }
    
    #reader, #nfeReader, #barcodeReader {
      width: 100%;
    }
    
    .scanner-overlay {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      pointer-events: none;
    }
    
    .scanner-corners {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
      width: 200px;
      height: 200px;
      border: 3px solid var(--primary-end);
      border-radius: 20px;
    }
    
    .scanner-corners::before,
    .scanner-corners::after {
      content: '';
      position: absolute;
      width: 30px;
      height: 30px;
      border: 4px solid white;
    }
    
    .scanner-corners::before {
      top: -4px;
      left: -4px;
      border-right: none;
      border-bottom: none;
    }
    
    .scanner-corners::after {
      top: -4px;
      right: -4px;
      border-left: none;
      border-bottom: none;
    }
    
    .scanner-line {
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      width: 200px;
      height: 2px;
      background: var(--primary-end);
      box-shadow: 0 0 10px var(--primary-end);
      animation: scanline 2s ease-in-out infinite;
    }
    
    .scanner-history {
      background: var(--surface);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    
    .scanner-history h3 {
      font-size: 16px;
      font-weight: 700;
      margin-bottom: 15px;
    }
    
    .history-item {
      padding: 12px;
      background: #f8fafc;
      border-radius: 10px;
      margin-bottom: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .history-code {
      font-weight: 700;
      color: var(--primary-mid);
    }
    
    .history-time {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    /* NFe List */
    .nfe-list {
      display: flex;
      flex-direction: column;
      gap: 15px;
    }
    
    .nfe-card {
      background: var(--surface);
      padding: 20px;
      border-radius: 16px;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
      transition: all 0.3s;
    }
    
    .nfe-card:hover {
      transform: translateY(-3px);
      box-shadow: 0 6px 20px rgba(0,0,0,0.1);
    }
    
    .nfe-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 15px;
    }
    
    .nfe-number {
      font-size: 14px;
      font-weight: 700;
      color: var(--primary-mid);
    }
    
    .nfe-date {
      font-size: 12px;
      color: var(--text-muted);
    }
    
    .nfe-details {
      background: #f8fafc;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    
    .nfe-detail-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 8px;
    }
    
    .nfe-detail-item:last-child {
      margin-bottom: 0;
    }
    
    .nfe-actions {
      display: flex;
      gap: 8px;
    }
    
    /* Toast */
    .toast-container {
      position: fixed;
      z-index: 3000;
      pointer-events: none;
    }
    
    .toast-container.desktop {
      top: 20px;
      right: 20px;
    }
    
    .toast-container.mobile {
      top: 80px;
      left: 50%;
      transform: translateX(-50%);
    }
    
    .toast {
      background: var(--surface);
      padding: 16px 20px;
      border-radius: 12px;
      box-shadow: 0 8px 30px rgba(0,0,0,0.15);
      margin-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 12px;
      pointer-events: all;
      animation: slideUp 0.3s ease-out;
      min-width: 300px;
    }
    
    .toast i {
      font-size: 20px;
    }
    
    .toast-success {
      border-left: 4px solid var(--success);
    }
    
    .toast-success i {
      color: var(--success);
    }
    
    .toast-error {
      border-left: 4px solid var(--danger);
    }
    
    .toast-error i {
      color: var(--danger);
    }
    
    .toast-info {
      border-left: 4px solid var(--info);
    }
    
    .toast-info i {
      color: var(--info);
    }
    
    /* Loading Overlay */
    .loading-overlay {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: rgba(0,0,0,0.7);
      backdrop-filter: blur(5px);
      z-index: 4000;
      align-items: center;
      justify-content: center;
    }
    
    .loading-overlay.active {
      display: flex;
    }
    
    .loading-content {
      text-align: center;
      color: white;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255,255,255,0.3);
      border-top-color: white;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 0 auto 20px;
    }
    
    .loading-text {
      font-size: 18px;
      font-weight: 600;
      margin-bottom: 10px;
    }
    
    .loading-subtext {
      font-size: 14px;
      opacity: 0.8;
    }
    
    /* Progress Bar */
    .progress-container {
      width: 300px;
      margin: 20px auto 0;
    }
    
    .progress-bar {
      width: 100%;
      height: 8px;
      background: rgba(255,255,255,0.2);
      border-radius: 10px;
      overflow: hidden;
    }
    
    .progress-fill {
      height: 100%;
      background: white;
      border-radius: 10px;
      transition: width 0.3s ease;
    }
    
    .progress-text {
      text-align: center;
      margin-top: 10px;
      font-size: 14px;
      opacity: 0.9;
    }
    
    /* Upload Zone */
    .upload-zone {
      border: 2px dashed #cbd5e1;
      border-radius: 16px;
      padding: 60px 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s;
      background: #f8fafc;
    }
    
    .upload-zone:hover {
      border-color: var(--primary-mid);
      background: rgba(25, 118, 210, 0.05);
    }
    
    .upload-zone i {
      font-size: 60px;
      color: var(--primary-mid);
      margin-bottom: 20px;
      display: block;
    }
    
    .upload-zone h3 {
      font-size: 20px;
      font-weight: 700;
      margin-bottom: 10px;
    }
    
    .upload-zone p {
      color: var(--text-muted);
    }
    
    .upload-result {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
      margin-top: 30px;
    }
    
    .result-card {
      padding: 20px;
      border-radius: 12px;
      text-align: center;
    }
    
    .result-card.success {
      background: #dcfce7;
      color: #166534;
    }
    
    .result-card.warning {
      background: #fef3c7;
      color: #92400e;
    }
    
    .result-card.error {
      background: #fee2e2;
      color: #991b1b;
    }
    
    .result-card i {
      font-size: 32px;
      margin-bottom: 10px;
    }
    
    .result-number {
      font-size: 36px;
      font-weight: 700;
      margin-bottom: 5px;
    }
    
    .result-label {
      font-size: 14px;
      font-weight: 600;
    }
    
    /* Table */
    .data-table {
      width: 100%;
      background: var(--surface);
      border-radius: 20px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.08);
      overflow: hidden;
      border: 2px solid #e2e8f0;
    }
    
    .data-table-wrapper {
      width: 100%;
      overflow-x: visible;
    }
    
    .data-table table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
      table-layout: auto;
    }
    
    .data-table thead {
      background: linear-gradient(135deg, #1e40af, #1e3a8a, #1d4ed8);
      position: relative;
    }
    
    .data-table thead::after {
      content: '';
      position: absolute;
      bottom: 0;
      left: 0;
      right: 0;
      height: 3px;
      background: linear-gradient(90deg, #60a5fa, #3b82f6, #2563eb, #1d4ed8);
    }
    
    .data-table th {
      padding: 20px 18px;
      text-align: left;
      font-weight: 700;
      font-size: 13px;
      color: #ffffff;
      text-transform: uppercase;
      letter-spacing: 1px;
      white-space: nowrap;
      border-right: 1px solid rgba(255, 255, 255, 0.1);
      position: relative;
    }
    
    .data-table th:last-child {
      border-right: none;
    }
    
    .data-table th i {
      margin-right: 8px;
      opacity: 0.9;
    }
    
    .data-table tbody tr {
      transition: all 0.3s;
      border-bottom: 2px solid #f1f5f9;
      background: var(--surface);
    }
    
    .data-table tbody tr:last-child {
      border-bottom: none;
    }
    
    .data-table tbody tr:nth-child(even) {
      background: #f8fafc;
    }
    
    .data-table tbody tr:hover {
      background: linear-gradient(90deg, #eff6ff, #dbeafe);
      transform: translateX(4px);
      box-shadow: -4px 0 0 0 #3b82f6, 0 4px 12px rgba(59, 130, 246, 0.15);
    }
    
    .data-table td {
      padding: 20px 18px;
      font-size: 14px;
      vertical-align: middle;
      border-right: 1px solid #f1f5f9;
      color: var(--text-main);
    }
    
    .data-table td:last-child {
      border-right: none;
    }
    
    .table-badge {
      display: inline-block;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .badge-admin {
      background: linear-gradient(135deg, #dcfce7, #bbf7d0);
      color: #166534;
    }
    
    .badge-user {
      background: linear-gradient(135deg, #fef3c7, #fde68a);
      color: #92400e;
    }
    
    .table-actions {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .table-code {
      font-family: 'Courier New', monospace;
      font-weight: 700;
      color: var(--primary-mid);
      background: #eff6ff;
      padding: 4px 8px;
      border-radius: 6px;
      font-size: 13px;
    }
    
    .table-value {
      font-weight: 700;
      color: #059669;
      font-size: 15px;
    }
    
    /* Responsive */
    @media (max-width: 768px) {
      .login-card {
        grid-template-columns: 1fr;
      }
      
      .login-brand {
        padding: 40px 30px;
      }
      
      .login-brand i {
        font-size: 60px;
      }
      
      .login-brand h1 {
        font-size: 24px;
      }
      
      .login-form-container {
        padding: 40px 30px;
      }
      
      .sidebar {
        display: none;
      }
      
      .mobile-header {
        display: flex;
      }
      
      .bottom-nav {
        display: block;
      }
      
      .main-content {
        padding: 20px;
        padding-bottom: 80px;
      }
      
      .products-grid {
        grid-template-columns: 1fr;
      }
      
      .stats-grid {
        grid-template-columns: 1fr;
      }
      
      .toast-container.desktop {
        display: none;
      }
      
      .product-list-item {
        grid-template-columns: 1fr;
        gap: 15px;
      }
      
      .product-list-qr {
        width: 100%;
        height: 120px;
      }
      
      .product-list-info {
        flex-direction: column;
        gap: 10px;
      }
      
      .bottom-nav {
        padding: 6px 10px 6px 10px;
      }
      
      .bottom-nav-items {
        gap: 2px;
      }
      
      .bottom-nav-item {
        min-width: 45px;
        max-width: 70px;
        padding: 5px 6px;
      }
      
      .bottom-nav-item i {
        font-size: 20px;
      }
      
      .bottom-nav-item span {
        font-size: 9px;
      }
      
      /* Tabelas Responsivas Mobile */
      .data-table {
        border-radius: 12px;
      }
      
      .data-table table {
        display: block;
      }
      
      .data-table thead {
        display: none;
      }
      
      .data-table tbody {
        display: block;
      }
      
      .data-table tr {
        display: block;
        margin-bottom: 15px;
        background: var(--surface);
        border-radius: 12px;
        padding: 15px;
        box-shadow: 0 2px 8px rgba(0,0,0,0.05);
      }
      
      .data-table td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 10px 0;
        border: none;
        border-bottom: 1px solid #f1f5f9;
      }
      
      .data-table td:last-child {
        border-bottom: none;
        padding-bottom: 0;
      }
      
      .data-table td:first-child {
        padding-top: 0;
      }
      
      .data-table td::before {
        content: attr(data-label);
        font-weight: 700;
        text-transform: uppercase;
        font-size: 11px;
        color: var(--text-muted);
        letter-spacing: 0.5px;
      }
      
      .table-actions {
        justify-content: flex-end;
        width: 100%;
      }
      
      .btn-small {
        min-width: 80px;
      }
    }
    
    @media (min-width: 769px) {
      .toast-container.mobile {
        display: none;
      }
    }
    
    .hidden {
      display: none !important;
    }
  </style>
  <script src="https://cdn.tailwindcss.com" type="text/javascript"></script>
 </head>
 <body><!-- Toast Container Desktop -->
  <div class="toast-container desktop" id="toastContainerDesktop"></div><!-- Toast Container Mobile -->
  <div class="toast-container mobile" id="toastContainerMobile"></div><!-- Loading Overlay -->
  <div class="loading-overlay" id="loadingOverlay">
   <div class="loading-content">
    <div class="spinner"></div>
    <div class="loading-text" id="loadingText">
     Carregando...
    </div>
    <div class="loading-subtext" id="loadingSubtext"></div>
    <div class="progress-container" id="progressContainer" style="display: none;">
     <div class="progress-bar">
      <div class="progress-fill" id="progressFill" style="width: 0%"></div>
     </div>
     <div class="progress-text" id="progressText">
      0%
     </div>
    </div>
   </div>
  </div><!-- Login Screen -->
  <div id="loginScreen" class="login-container">
   <div class="login-card">
    <div class="login-brand"><i class="fas fa-warehouse"></i>
     <h1>Almoxarifado</h1>
     <p>Sistema de Gestão de Estoque</p>
    </div>
    <div class="login-form-container">
     <div class="login-tabs"><button class="login-tab active" onclick="switchTab('login')">Entrar</button> <button class="login-tab" onclick="switchTab('register')">Cadastrar</button>
     </div>
     <form id="loginForm">
      <div class="form-group"><label>Usuário</label>
       <div class="input-with-icon"><i class="fas fa-user"></i> <input type="text" id="loginUsername" placeholder="Digite seu usuário" required>
       </div>
      </div>
      <div class="form-group"><label>Senha</label>
       <div class="input-with-icon"><i class="fas fa-lock"></i> <input type="password" id="loginPassword" placeholder="Digite sua senha" required>
       </div>
      </div><button type="submit" class="btn btn-primary">Entrar</button>
     </form>
     <form id="registerForm" class="hidden">
      <div class="form-group"><label>Nome Completo</label>
       <div class="input-with-icon"><i class="fas fa-id-card"></i> <input type="text" id="registerName" placeholder="Digite seu nome" required>
       </div>
      </div>
      <div class="form-group"><label>Usuário</label>
       <div class="input-with-icon"><i class="fas fa-user"></i> <input type="text" id="registerUsername" placeholder="Escolha um usuário" required>
       </div>
      </div>
      <div class="form-group"><label>Senha</label>
       <div class="input-with-icon"><i class="fas fa-lock"></i> <input type="password" id="registerPassword" placeholder="Escolha uma senha" required>
       </div>
      </div><button type="submit" class="btn btn-primary">Cadastrar</button>
     </form>
    </div>
   </div>
  </div><!-- Main App -->
  <div id="mainApp" class="hidden">
   <div class="main-layout"><!-- Sidebar Desktop -->
    <div class="sidebar" id="sidebar">
     <div class="sidebar-header">
      <div class="sidebar-brand"><i class="fas fa-warehouse"></i>
       <h2>Almoxarifado</h2>
      </div>
     </div>
     <div class="sidebar-menu" id="sidebarMenu"></div>
     <div class="sidebar-footer">
      <div class="user-info">
       <div class="user-avatar" id="userAvatar"></div>
       <div class="user-details">
        <h4 id="userName"></h4>
        <p id="userRole"></p>
       </div>
      </div>
     </div>
    </div>
    <div style="flex: 1; display: flex; flex-direction: column; overflow: hidden;"><!-- Mobile Header -->
     <div class="mobile-header">
      <h2 id="mobileTitle">Produtos</h2>
      <div class="user-avatar" id="userAvatarMobile"></div>
     </div><!-- Main Content -->
     <div class="main-content"><!-- Dashboard Page -->
      <div id="dashboardPage" class="page-enter hidden">
       <h1 style="margin-bottom: 30px; font-size: 28px;">Dashboard</h1>
       <div class="stats-grid" id="statsGrid"></div>
       <div class="data-table">
        <table>
         <thead>
          <tr>
           <th><i class="fas fa-barcode"></i>Código</th>
           <th><i class="fas fa-box"></i>Produto</th>
           <th><i class="fas fa-sort-numeric-down"></i>Quantidade</th>
           <th><i class="fas fa-dollar-sign"></i>Valor</th>
           <th><i class="fas fa-user"></i>Usuário</th>
           <th><i class="fas fa-calendar-alt"></i>Data</th>
          </tr>
         </thead>
         <tbody id="retiradaTable"></tbody>
        </table>
       </div>
       <div class="pagination" id="dashboardPagination"></div>
      </div><!-- Products Page -->
      <div id="productsPage" class="page-enter">
       <div class="products-header">
        <h1 style="font-size: 28px;">Produtos</h1>
        <div class="search-box"><i class="fas fa-search"></i> <input type="text" id="searchInput" placeholder="Buscar por código ou nome...">
        </div>
        <div class="view-toggle"><button class="view-btn active" onclick="setView('grid')"> <i class="fas fa-th"></i> </button> <button class="view-btn" onclick="setView('list')"> <i class="fas fa-list"></i> </button>
        </div><button class="btn btn-primary" onclick="openAddProductModal()" id="btnAddProduct"> <i class="fas fa-plus"></i> Adicionar </button> <button class="btn btn-info" onclick="generateAllQRCodes()" id="btnGenerateAllQR"> <i class="fas fa-qrcode"></i> Gerar Todos QR </button>
       </div>
       <div class="products-grid" id="productsGrid"></div>
       <div class="products-list hidden" id="productsList"></div>
       <div class="pagination" id="productsPagination"></div>
      </div><!-- Scanner Page -->
      <div id="scannerPage" class="page-enter hidden">
       <h1 style="margin-bottom: 30px; font-size: 28px;">Scanner de QR Code</h1>
       <div class="camera-container" id="scannerCamera">
        <div id="reader"></div>
       </div>
       <div class="scanner-history">
        <h3>Últimas Leituras</h3>
        <div id="scannerHistory"></div>
       </div>
      </div><!-- NFe Page -->
      <div id="nfePage" class="page-enter hidden">
       <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; flex-wrap: wrap; gap: 15px;">
        <h1 style="font-size: 28px;">Notas Fiscais</h1>
        <div style="display: flex; gap: 10px; flex-wrap: wrap;"><button class="btn btn-success" onclick="openNFeManualForm()"> <i class="fas fa-plus"></i> Cadastrar NFe </button> <button class="btn btn-primary" onclick="openNFeScanModal()"> <i class="fas fa-camera"></i> Escanear Código </button>
        </div>
       </div>
       <div class="nfe-list" id="nfeList"></div>
       <div class="pagination" id="nfePagination"></div>
      </div><!-- Upload Page -->
      <div id="uploadPage" class="page-enter hidden">
       <h1 style="margin-bottom: 30px; font-size: 28px;">Upload de Excel</h1>
       <div class="upload-zone" onclick="document.getElementById('fileInput').click()"><i class="fas fa-cloud-upload-alt"></i>
        <h3>Arraste um arquivo ou clique para selecionar</h3>
        <p>Suporta arquivos .xls, .xlsx e .csv</p><input type="file" id="fileInput" accept=".xls,.xlsx,.csv" style="display: none;">
       </div>
       <div class="upload-result" id="uploadResult"></div>
      </div><!-- Users Page -->
      <div id="usersPage" class="page-enter hidden">
       <h1 style="margin-bottom: 30px; font-size: 28px;">Gerenciar Usuários</h1>
       <h3 style="margin-bottom: 15px; font-size: 18px; font-weight: 700; color: var(--primary-mid);"><i class="fas fa-clock"></i> Usuários Pendentes</h3>
       <div class="data-table" style="margin-bottom: 30px;">
        <table>
         <thead>
          <tr>
           <th><i class="fas fa-id-card"></i>Nome</th>
           <th><i class="fas fa-user"></i>Usuário</th>
           <th><i class="fas fa-calendar-plus"></i>Data</th>
           <th><i class="fas fa-cogs"></i>Ações</th>
          </tr>
         </thead>
         <tbody id="pendingUsersTable"></tbody>
        </table>
       </div>
       <h3 style="margin-bottom: 15px; font-size: 18px; font-weight: 700; color: var(--success);"><i class="fas fa-check-circle"></i> Usuários Aprovados</h3>
       <div class="data-table">
        <table>
         <thead>
          <tr>
           <th><i class="fas fa-id-card"></i>Nome</th>
           <th><i class="fas fa-user"></i>Usuário</th>
           <th><i class="fas fa-shield-alt"></i>Tipo</th>
           <th><i class="fas fa-calendar-check"></i>Data</th>
          </tr>
         </thead>
         <tbody id="approvedUsersTable"></tbody>
        </table>
       </div>
       <div class="pagination" id="usersPagination"></div>
      </div><!-- Reports Page -->
      <div id="reportsPage" class="page-enter hidden">
       <h1 style="margin-bottom: 30px; font-size: 28px;">Relatórios</h1>
       <div style="background: var(--surface); padding: 30px; border-radius: 16px; box-shadow: 0 2px 10px rgba(0,0,0,0.05);">
        <h3 style="margin-bottom: 20px;">Gerar Relatório de Retiradas</h3>
        <div style="display: flex; gap: 15px; margin-bottom: 20px; flex-wrap: wrap;">
         <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;"><label>Mês</label> <select id="reportMonth" style="width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px;"> <option value="01">Janeiro</option> <option value="02">Fevereiro</option> <option value="03">Março</option> <option value="04">Abril</option> <option value="05">Maio</option> <option value="06">Junho</option> <option value="07">Julho</option> <option value="08">Agosto</option> <option value="09">Setembro</option> <option value="10">Outubro</option> <option value="11">Novembro</option> <option value="12">Dezembro</option> </select>
         </div>
         <div class="form-group" style="flex: 1; min-width: 200px; margin-bottom: 0;"><label>Ano</label> <input type="number" id="reportYear" value="2026" style="width: 100%; padding: 12px; border: 1.5px solid #e2e8f0; border-radius: 10px;">
         </div>
        </div><button class="btn btn-primary" onclick="generateReport()"> <i class="fas fa-file-pdf"></i> Gerar PDF </button>
       </div>
      </div>
     </div>
    </div>
   </div><!-- Bottom Navigation Mobile -->
   <div class="bottom-nav">
    <div class="bottom-nav-items" id="bottomNavItems"></div>
   </div>
  </div><!-- Modal -->
  <div class="modal-backdrop" id="modalBackdrop">
   <div class="modal-content">
    <div class="modal-header">
     <h3 id="modalTitle">Modal</h3><button class="modal-close" onclick="closeModal()"> <i class="fas fa-times"></i> </button>
    </div>
    <div class="modal-body" id="modalBody"></div>
    <div class="modal-footer" id="modalFooter"></div>
   </div>
  </div>
  <script>
    // Firebase Config
    const firebaseConfig = {
      apiKey: "AIzaSyCYYZ5sM3LcBGl4CAOoBrkWdxxq-pcsePM",
      authDomain: "almoxarifado-576b5.firebaseapp.com",
      databaseURL: "https://almoxarifado-576b5-default-rtdb.firebaseio.com",
      projectId: "almoxarifado-576b5"
    };
    
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    
    // Global State
    let currentUser = null;
    let allProducts = [];
    let filteredProducts = [];
    let allRetiradas = [];
    let allNFes = [];
    let currentView = 'grid';
    let currentPage = 1;
    const itemsPerPage = 12;
    let scannerHistory = [];
    let html5QrCode = null;
    let lastScannedCode = '';
    let lastScanTime = 0;
    const SCAN_COOLDOWN = 3000;
    let quaggaInstance = null;
    
    // Utility Functions
    function formatMoney(value) {
      const num = parseFloat(value) || 0;
      return num.toLocaleString('pt-BR', { 
        style: 'currency', 
        currency: 'BRL',
        minimumFractionDigits: 2,
        maximumFractionDigits: 2
      });
    }
    
    function formatNumber(value) {
      const num = parseInt(value) || 0;
      return num.toString();
    }
    
    function formatDate(timestamp) {
      const date = new Date(timestamp);
      return date.toLocaleString('pt-BR');
    }
    
    function showToast(message, type = 'success') {
      const isMobile = window.innerWidth <= 768;
      const container = isMobile ? 
        document.getElementById('toastContainerMobile') : 
        document.getElementById('toastContainerDesktop');
      
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;
      
      const icon = type === 'success' ? 'check-circle' : 
                   type === 'error' ? 'exclamation-circle' : 
                   'info-circle';
      
      toast.innerHTML = `
        <i class="fas fa-${icon}"></i>
        <span>${message}</span>
      `;
      
      container.appendChild(toast);
      
      setTimeout(() => {
        toast.style.opacity = '0';
        setTimeout(() => toast.remove(), 300);
      }, 3000);
    }
    
    function showLoading(text = 'Carregando...', subtext = '', showProgress = false) {
      const overlay = document.getElementById('loadingOverlay');
      const loadingText = document.getElementById('loadingText');
      const loadingSubtext = document.getElementById('loadingSubtext');
      const progressContainer = document.getElementById('progressContainer');
      
      loadingText.textContent = text;
      loadingSubtext.textContent = subtext;
      progressContainer.style.display = showProgress ? 'block' : 'none';
      overlay.classList.add('active');
    }
    
    function updateProgress(percent, text = '') {
      const progressFill = document.getElementById('progressFill');
      const progressText = document.getElementById('progressText');
      
      progressFill.style.width = `${percent}%`;
      progressText.textContent = text || `${Math.round(percent)}%`;
    }
    
    function hideLoading() {
      document.getElementById('loadingOverlay').classList.remove('active');
    }
    
    function openModal(title, bodyHTML, footerHTML = '') {
      document.getElementById('modalTitle').textContent = title;
      document.getElementById('modalBody').innerHTML = bodyHTML;
      document.getElementById('modalFooter').innerHTML = footerHTML;
      document.getElementById('modalBackdrop').classList.add('active');
    }
    
    function closeModal() {
      document.getElementById('modalBackdrop').classList.remove('active');
      if (quaggaInstance) {
        Quagga.stop();
        quaggaInstance = null;
      }
    }
    
    // Session Management
    function saveSession() {
      if (currentUser) {
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        localStorage.setItem('lastPage', getCurrentPage());
      }
    }
    
    function getCurrentPage() {
      const pages = ['dashboard', 'products', 'scanner', 'nfe', 'upload', 'users', 'reports'];
      for (let page of pages) {
        const el = document.getElementById(`${page}Page`);
        if (el && !el.classList.contains('hidden')) {
          return page;
        }
      }
      return 'products';
    }
    
    // Auto-save session
    window.addEventListener('beforeunload', () => {
      saveSession();
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
      }
      if (quaggaInstance) {
        Quagga.stop();
      }
    });
    setInterval(saveSession, 5000);
    
    // Auth Functions
    function switchTab(tab) {
      const loginForm = document.getElementById('loginForm');
      const registerForm = document.getElementById('registerForm');
      const tabs = document.querySelectorAll('.login-tab');
      
      tabs.forEach(t => t.classList.remove('active'));
      event.target.classList.add('active');
      
      if (tab === 'login') {
        loginForm.classList.remove('hidden');
        registerForm.classList.add('hidden');
      } else {
        loginForm.classList.add('hidden');
        registerForm.classList.remove('hidden');
      }
    }
    
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('loginUsername').value;
      const password = document.getElementById('loginPassword').value;
      
      showLoading('Entrando...');
      
      try {
        const snapshot = await db.ref('usuarios').orderByChild('username').equalTo(username).once('value');
        const users = snapshot.val();
        
        if (!users) {
          hideLoading();
          showToast('Usuário não encontrado', 'error');
          return;
        }
        
        const userId = Object.keys(users)[0];
        const user = users[userId];
        
        if (user.password !== password) {
          hideLoading();
          showToast('Senha incorreta', 'error');
          return;
        }
        
        if (!user.approved) {
          hideLoading();
          showToast('Seu cadastro está pendente de aprovação', 'error');
          return;
        }
        
        currentUser = { id: userId, ...user };
        localStorage.setItem('currentUser', JSON.stringify(currentUser));
        
        hideLoading();
        showApp();
      } catch (error) {
        hideLoading();
        showToast('Erro ao fazer login', 'error');
      }
    });
    
    document.getElementById('registerForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const name = document.getElementById('registerName').value;
      const username = document.getElementById('registerUsername').value;
      const password = document.getElementById('registerPassword').value;
      
      showLoading('Criando conta...');
      
      try {
        const snapshot = await db.ref('usuarios').orderByChild('username').equalTo(username).once('value');
        
        if (snapshot.exists()) {
          hideLoading();
          showToast('Usuário já existe', 'error');
          return;
        }
        
        await db.ref('usuarios').push({
          name,
          username,
          password,
          role: 'user',
          approved: false,
          createdAt: Date.now()
        });
        
        hideLoading();
        showToast('Cadastro criado! Aguarde aprovação do administrador', 'success');
        switchTab('login');
        document.getElementById('registerForm').reset();
      } catch (error) {
        hideLoading();
        showToast('Erro ao criar cadastro', 'error');
      }
    });
    
    // App Functions
    function showApp() {
      document.getElementById('loginScreen').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      
      updateUserInfo();
      renderMenu();
      loadProducts();
      
      if (currentUser.role === 'admin') {
        loadRetiradas();
        loadUsers();
        loadNFes();
      }
      
      const lastPage = localStorage.getItem('lastPage') || 'products';
      setTimeout(() => navigateTo(lastPage), 100);
    }
    
    function updateUserInfo() {
      const initials = currentUser.name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();
      const roleText = currentUser.role === 'admin' ? 'Administrador' : 'Usuário';
      
      document.getElementById('userAvatar').textContent = initials;
      document.getElementById('userAvatarMobile').textContent = initials;
      document.getElementById('userName').textContent = currentUser.name;
      document.getElementById('userRole').textContent = roleText;
    }
    
    function renderMenu() {
      const isAdmin = currentUser.role === 'admin';
      const isMobile = window.innerWidth <= 768;
      
      const menuItems = [
        { id: 'products', icon: 'box', label: 'Produtos', color: '#1e40af', admin: false },
        { id: 'scanner', icon: 'qrcode', label: 'Scanner', color: '#3b82f6', admin: false },
      ];
      
      const adminItems = [
        { id: 'dashboard', icon: 'chart-line', label: 'Dashboard', color: '#0ea5e9', admin: true },
        { id: 'nfe', icon: 'file-invoice', label: 'Notas Fiscais', color: '#0284c7', admin: true },
        { id: 'upload', icon: 'file-excel', label: 'Upload Excel', color: '#0369a1', admin: true },
        { id: 'users', icon: 'users', label: 'Usuários', color: '#475569', admin: true },
        { id: 'reports', icon: 'file-pdf', label: 'Relatórios', color: '#64748b', admin: true },
      ];
      
      let items = [...menuItems];
      if (isAdmin) {
        items = [adminItems[0], ...items, ...adminItems.slice(1)];
      }
      
      // Desktop Sidebar
      const sidebarMenu = document.getElementById('sidebarMenu');
      sidebarMenu.innerHTML = items.map(item => `
        <div class="menu-item ${item.id === 'products' ? 'active' : ''}" onclick="navigateTo('${item.id}')">
          <i class="fas fa-${item.icon}" style="color: ${item.color}"></i>
          <span>${item.label}</span>
        </div>
      `).join('') + `
        <div class="menu-item" onclick="logout()">
          <i class="fas fa-sign-out-alt" style="color: #64748b"></i>
          <span>Sair</span>
        </div>
      `;
      
      // Mobile Bottom Nav
      const bottomNavItems = document.getElementById('bottomNavItems');
      let mobileItems = [];
      
      if (isMobile && isAdmin) {
        mobileItems = [
          { id: 'dashboard', icon: 'chart-line', label: 'Dashboard' },
          { id: 'products', icon: 'box', label: 'Produtos' },
          { id: 'scanner', icon: 'qrcode', label: 'Scanner' },
          { id: 'nfe', icon: 'file-invoice', label: 'NFe' },
          { id: 'more', icon: 'ellipsis-h', label: 'Mais' }
        ];
      } else if (isMobile) {
        mobileItems = [
          { id: 'products', icon: 'box', label: 'Produtos' },
          { id: 'scanner', icon: 'qrcode', label: 'Scanner' },
          { id: 'logout', icon: 'sign-out-alt', label: 'Sair' }
        ];
      }
      
      bottomNavItems.innerHTML = mobileItems.map(item => `
        <div class="bottom-nav-item ${item.id === 'products' ? 'active' : ''}" data-page="${item.id}" onclick="handleBottomNav('${item.id}')">
          <i class="fas fa-${item.icon}"></i>
          <span>${item.label}</span>
        </div>
      `).join('');
    }
    
    function handleBottomNav(id) {
      if (id === 'more') {
        showMoreMenu();
      } else if (id === 'logout') {
        logout();
      } else {
        navigateTo(id);
      }
    }
    
    function showMoreMenu() {
      const bodyHTML = `
        <div style="display: flex; flex-direction: column; gap: 10px;">
          <button class="btn" onclick="navigateTo('upload'); closeModal();" style="width: 100%; background: #f59e0b; color: white;">
            <i class="fas fa-file-excel"></i> Upload Excel
          </button>
          <button class="btn" onclick="navigateTo('users'); closeModal();" style="width: 100%; background: #64748b; color: white;">
            <i class="fas fa-users"></i> Usuários
          </button>
          <button class="btn" onclick="navigateTo('reports'); closeModal();" style="width: 100%; background: #475569; color: white;">
            <i class="fas fa-file-pdf"></i> Relatórios
          </button>
          <button class="btn" onclick="logout();" style="width: 100%; background: #94a3b8; color: white;">
            <i class="fas fa-sign-out-alt"></i> Sair
          </button>
        </div>
      `;
      openModal('Mais Opções', bodyHTML);
    }
    
    function navigateTo(page) {
      const pages = ['dashboard', 'products', 'scanner', 'nfe', 'upload', 'users', 'reports'];
      pages.forEach(p => {
        const el = document.getElementById(`${p}Page`);
        if (el) el.classList.add('hidden');
      });
      
      const targetPage = document.getElementById(`${page}Page`);
      if (targetPage) {
        targetPage.classList.remove('hidden');
        targetPage.classList.add('page-enter');
      }
      
      document.querySelectorAll('.menu-item, .bottom-nav-item').forEach(item => {
        item.classList.remove('active');
      });
      
      document.querySelectorAll(`[onclick*="'${page}'"]`).forEach(item => {
        item.classList.add('active');
      });
      
      document.querySelectorAll(`.bottom-nav-item[data-page="${page}"]`).forEach(item => {
        item.classList.add('active');
      });
      
      const titles = {
        dashboard: 'Dashboard',
        products: 'Produtos',
        scanner: 'Scanner',
        nfe: 'Notas Fiscais',
        upload: 'Upload Excel',
        users: 'Usuários',
        reports: 'Relatórios'
      };
      
      document.getElementById('mobileTitle').textContent = titles[page] || 'Produtos';
      
      if (page === 'scanner' && !html5QrCode) {
        setTimeout(() => initScanner(), 300);
      }
      
      saveSession();
    }
    
    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('lastPage');
      currentUser = null;
      allProducts = [];
      filteredProducts = [];
      
      if (html5QrCode) {
        html5QrCode.stop().catch(() => {});
        html5QrCode = null;
      }
      
      if (quaggaInstance) {
        Quagga.stop();
        quaggaInstance = null;
      }
      
      document.getElementById('mainApp').classList.add('hidden');
      document.getElementById('loginScreen').classList.remove('hidden');
      showToast('Você saiu da conta', 'info');
    }
    
    // Products Functions
    async function loadProducts() {
      showLoading('Carregando produtos...');
      
      try {
        const snapshot = await db.ref('produtos').once('value');
        const produtos = snapshot.val() || {};
        
        allProducts = Object.keys(produtos).map(key => ({
          id: key,
          ...produtos[key]
        }));
        
        filteredProducts = [...allProducts];
        renderProducts();
        hideLoading();
      } catch (error) {
        hideLoading();
        showToast('Erro ao carregar produtos', 'error');
      }
    }
    
    function renderProducts() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      filteredProducts = allProducts.filter(p => 
        p.codigo.toLowerCase().includes(searchTerm) || 
        p.nome.toLowerCase().includes(searchTerm)
      );
      
      const totalPages = Math.ceil(filteredProducts.length / itemsPerPage);
      currentPage = Math.min(currentPage, Math.max(1, totalPages));
      
      const start = (currentPage - 1) * itemsPerPage;
      const end = start + itemsPerPage;
      const pageProducts = filteredProducts.slice(start, end);
      
      if (currentView === 'grid') {
        renderProductsGrid(pageProducts);
      } else {
        renderProductsList(pageProducts);
      }
      
      renderProductsPagination(totalPages);
    }
    
    function renderProductsGrid(products) {
      const grid = document.getElementById('productsGrid');
      const list = document.getElementById('productsList');
      
      grid.classList.remove('hidden');
      list.classList.add('hidden');
      
      if (products.length === 0) {
        grid.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhum produto encontrado</p>';
        return;
      }
      
      grid.innerHTML = products.map(product => {
        const status = getStockStatus(product.quantidade);
        const hasQR = product.qrCodeUrl && product.qrCodeUrl.trim() !== '';
        
        return `
          <div class="product-card">
            <div class="product-header">
              <span class="product-code">${product.codigo}</span>
              <span class="product-status status-${status.class}">${status.text}</span>
            </div>
            <h3 class="product-name">${product.nome}</h3>
            <div class="product-info">
              <div class="info-item">
                <span class="info-label">Estoque</span>
                <span class="info-value">${formatNumber(product.quantidade)}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Custo</span>
                <span class="info-value">${formatMoney(product.custoUnitario)}</span>
              </div>
              <div class="info-item">
                <span class="info-label">Total</span>
                <span class="info-value">${formatMoney(product.quantidade * product.custoUnitario)}</span>
              </div>
            </div>
            <div class="product-actions">
              ${currentUser.role === 'admin' ? `
                <button class="btn-small btn-success" onclick="openAddStockModal('${product.id}')">
                  <i class="fas fa-plus"></i> Adicionar
                </button>
                ${!hasQR ? `
                  <button class="btn-small btn-info" onclick="generateSingleQR('${product.id}')">
                    <i class="fas fa-qrcode"></i> QR Code
                  </button>
                ` : ''}
              ` : ''}
              <button class="btn-small btn-warning" onclick="openRetirarModal('${product.id}')">
                <i class="fas fa-minus"></i> Retirar
              </button>
              ${currentUser.role === 'admin' ? `
                <button class="btn-small btn-danger" onclick="deleteProduct('${product.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderProductsList(products) {
      const grid = document.getElementById('productsGrid');
      const list = document.getElementById('productsList');
      
      grid.classList.add('hidden');
      list.classList.remove('hidden');
      
      if (products.length === 0) {
        list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhum produto encontrado</p>';
        return;
      }
      
      list.innerHTML = products.map(product => {
        const status = getStockStatus(product.quantidade);
        const hasQR = product.qrCodeUrl && product.qrCodeUrl.trim() !== '';
        
        return `
          <div class="product-list-item">
            <div class="product-list-qr">
              ${hasQR ? `
                <img src="${product.qrCodeUrl}" alt="QR Code" loading="lazy" onerror="this.src=''; this.alt='Erro ao carregar QR'; this.style.display='none';">
              ` : `
                <i class="fas fa-qrcode" style="font-size: 32px; color: var(--text-muted);"></i>
              `}
            </div>
            <div class="product-list-details">
              <div class="product-list-header">
                <span class="product-code">${product.codigo}</span>
                <h3 style="font-size: 18px; font-weight: 600; margin: 0;">${product.nome}</h3>
                <span class="product-status status-${status.class}">${status.text}</span>
              </div>
              <div class="product-list-info">
                <div>
                  <span class="info-label">Estoque:</span>
                  <span class="info-value">${formatNumber(product.quantidade)}</span>
                </div>
                <div>
                  <span class="info-label">Custo:</span>
                  <span class="info-value">${formatMoney(product.custoUnitario)}</span>
                </div>
                <div>
                  <span class="info-label">Total:</span>
                  <span class="info-value">${formatMoney(product.quantidade * product.custoUnitario)}</span>
                </div>
              </div>
            </div>
            <div style="display: flex; flex-direction: column; gap: 8px;">
              ${currentUser.role === 'admin' ? `
                <button class="btn-small btn-success" onclick="openAddStockModal('${product.id}')">
                  <i class="fas fa-plus"></i> Adicionar
                </button>
                ${!hasQR ? `
                  <button class="btn-small btn-info" onclick="generateSingleQR('${product.id}')">
                    <i class="fas fa-qrcode"></i> QR
                  </button>
                ` : ''}
              ` : ''}
              <button class="btn-small btn-warning" onclick="openRetirarModal('${product.id}')">
                <i class="fas fa-minus"></i> Retirar
              </button>
              ${currentUser.role === 'admin' ? `
                <button class="btn-small btn-danger" onclick="deleteProduct('${product.id}')">
                  <i class="fas fa-trash"></i>
                </button>
              ` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderProductsPagination(totalPages) {
      const pagination = document.getElementById('productsPagination');
      
      if (totalPages <= 1) {
        pagination.innerHTML = '';
        return;
      }
      
      let paginationHTML = '';
      
      // Botão Anterior
      paginationHTML += `
        <button ${currentPage === 1 ? 'disabled' : ''} onclick="changePage(${currentPage - 1})">
          <i class="fas fa-chevron-left"></i>
        </button>
      `;
      
      // Lógica dos números de página
      const maxVisible = 7; // Número máximo de botões visíveis
      let startPage = 1;
      let endPage = totalPages;
      
      if (totalPages > maxVisible) {
        if (currentPage <= 4) {
          endPage = maxVisible - 1;
        } else if (currentPage >= totalPages - 3) {
          startPage = totalPages - (maxVisible - 2);
        } else {
          startPage = currentPage - 2;
          endPage = currentPage + 2;
        }
      }
      
      // Primeira página
      if (startPage > 1) {
        paginationHTML += `<button onclick="changePage(1)">1</button>`;
        if (startPage > 2) {
          paginationHTML += `<span class="page-dots">...</span>`;
        }
      }
      
      // Páginas intermediárias
      for (let i = startPage; i <= endPage; i++) {
        paginationHTML += `
          <button class="${i === currentPage ? 'active' : ''}" onclick="changePage(${i})">${i}</button>
        `;
      }
      
      // Última página
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          paginationHTML += `<span class="page-dots">...</span>`;
        }
        paginationHTML += `<button onclick="changePage(${totalPages})">${totalPages}</button>`;
      }
      
      // Botão Próxima
      paginationHTML += `
        <button ${currentPage === totalPages ? 'disabled' : ''} onclick="changePage(${currentPage + 1})">
          <i class="fas fa-chevron-right"></i>
        </button>
      `;
      
      pagination.innerHTML = paginationHTML;
    }
    
    function changePage(page) {
      currentPage = page;
      renderProducts();
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }
    
    function setView(view) {
      currentView = view;
      document.querySelectorAll('.view-btn').forEach(btn => btn.classList.remove('active'));
      event.target.closest('.view-btn').classList.add('active');
      renderProducts();
    }
    
    function getStockStatus(quantidade) {
      if (quantidade === 0) return { class: 'empty', text: 'Esgotado' };
      if (quantidade < 10) return { class: 'low', text: 'Baixo' };
      if (quantidade < 30) return { class: 'warning', text: 'Atenção' };
      return { class: 'normal', text: 'Normal' };
    }
    
    function openAddProductModal() {
      const bodyHTML = `
        <form id="addProductForm">
          <div class="form-group">
            <label>Código</label>
            <input type="text" id="newProductCode" required style="padding-left: 15px;">
          </div>
          <div class="form-group">
            <label>Nome</label>
            <input type="text" id="newProductName" required style="padding-left: 15px;">
          </div>
          <div class="form-group">
            <label>Custo Unitário</label>
            <input type="number" step="0.01" id="newProductCost" required style="padding-left: 15px;">
          </div>
          <div class="form-group">
            <label>Quantidade</label>
            <input type="number" id="newProductQty" required style="padding-left: 15px;">
          </div>
        </form>
      `;
      
      const footerHTML = `
        <button class="btn" onclick="closeModal()" style="background: #64748b; color: white;">Cancelar</button>
        <button class="btn btn-primary" onclick="addProduct()">Adicionar Produto</button>
      `;
      
      openModal('Adicionar Produto', bodyHTML, footerHTML);
    }
    
    async function addProduct() {
      const codigo = document.getElementById('newProductCode').value;
      const nome = document.getElementById('newProductName').value;
      const custoUnitario = parseFloat(document.getElementById('newProductCost').value);
      const quantidade = parseInt(document.getElementById('newProductQty').value);
      
      if (!codigo || !nome || isNaN(custoUnitario) || isNaN(quantidade)) {
        showToast('Preencha todos os campos', 'error');
        return;
      }
      
      showLoading('Adicionando produto...');
      
      try {
        await db.ref('produtos').push({
          codigo,
          nome,
          custoUnitario,
          quantidade,
          qrCode: '',
          qrCodeUrl: '',
          ultimaAtualizacao: Date.now()
        });
        
        closeModal();
        await loadProducts();
        hideLoading();
        showToast('Produto adicionado com sucesso!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao adicionar produto', 'error');
      }
    }
    
    function openAddStockModal(productId) {
      const product = allProducts.find(p => p.id === productId);
      
      const bodyHTML = `
        <p style="margin-bottom: 20px;"><strong>${product.nome}</strong></p>
        <div class="form-group">
          <label>Quantidade a adicionar</label>
          <input type="number" id="addStockQty" min="1" value="1" style="padding-left: 15px;">
        </div>
      `;
      
      const footerHTML = `
        <button class="btn" onclick="closeModal()" style="background: #64748b; color: white;">Cancelar</button>
        <button class="btn btn-success" onclick="addStock('${productId}')">Adicionar ao Estoque</button>
      `;
      
      openModal('Adicionar ao Estoque', bodyHTML, footerHTML);
    }
    
    async function addStock(productId) {
      const qty = parseInt(document.getElementById('addStockQty').value);
      
      if (isNaN(qty) || qty <= 0) {
        showToast('Quantidade inválida', 'error');
        return;
      }
      
      showLoading('Adicionando ao estoque...');
      
      try {
        const product = allProducts.find(p => p.id === productId);
        const newQty = product.quantidade + qty;
        
        await db.ref(`produtos/${productId}`).update({
          quantidade: newQty,
          ultimaAtualizacao: Date.now()
        });
        
        closeModal();
        await loadProducts();
        hideLoading();
        showToast(`${qty} unidades adicionadas!`, 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao adicionar estoque', 'error');
      }
    }
    
    function openRetirarModal(productId) {
      const product = allProducts.find(p => p.id === productId);
      
      const bodyHTML = `
        <p style="margin-bottom: 20px;"><strong>${product.nome}</strong></p>
        <p style="margin-bottom: 20px; color: var(--text-muted);">Estoque disponível: ${formatNumber(product.quantidade)}</p>
        <div class="form-group">
          <label>Quantidade a retirar</label>
          <input type="number" id="retirarQty" min="1" max="${product.quantidade}" value="1" oninput="updateRetirarTotal('${productId}')" style="padding-left: 15px;">
        </div>
        <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-top: 15px;">
          <p style="margin-bottom: 5px; color: var(--text-muted);">Valor unitário: ${formatMoney(product.custoUnitario)}</p>
          <p style="font-size: 20px; font-weight: 700; color: var(--primary-mid);" id="retirarTotal">${formatMoney(product.custoUnitario)}</p>
        </div>
      `;
      
      const footerHTML = `
        <button class="btn" onclick="closeModal()" style="background: #64748b; color: white;">Cancelar</button>
        <button class="btn btn-warning" onclick="retirarProduto('${productId}')">Retirar</button>
      `;
      
      openModal('Retirar Produto', bodyHTML, footerHTML);
    }
    
    function updateRetirarTotal(productId) {
      const product = allProducts.find(p => p.id === productId);
      const qty = parseInt(document.getElementById('retirarQty').value) || 0;
      const total = qty * product.custoUnitario;
      document.getElementById('retirarTotal').textContent = formatMoney(total);
    }
    
    async function retirarProduto(productId) {
      const product = allProducts.find(p => p.id === productId);
      const qty = parseInt(document.getElementById('retirarQty').value);
      
      if (isNaN(qty) || qty <= 0 || qty > product.quantidade) {
        showToast('Quantidade inválida', 'error');
        return;
      }
      
      showLoading('Processando retirada...');
      
      try {
        const newQty = product.quantidade - qty;
        const valorTotal = qty * product.custoUnitario;
        
        await db.ref(`produtos/${productId}`).update({
          quantidade: newQty,
          ultimaAtualizacao: Date.now()
        });
        
        await db.ref('retiradas').push({
          codigo: product.codigo,
          nome: product.nome,
          quantidade: qty,
          valorUnitario: product.custoUnitario,
          valorTotal,
          usuario: currentUser.name,
          dataHora: Date.now()
        });
        
        closeModal();
        await loadProducts();
        if (currentUser.role === 'admin') {
          await loadRetiradas();
        }
        hideLoading();
        showToast('Retirada registrada com sucesso!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao processar retirada', 'error');
      }
    }
    
    async function deleteProduct(productId) {
      if (!window.confirm('Tem certeza que deseja excluir este produto?')) return;
      
      showLoading('Excluindo produto...');
      
      try {
        await db.ref(`produtos/${productId}`).remove();
        await loadProducts();
        hideLoading();
        showToast('Produto excluído!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao excluir produto', 'error');
      }
    }
    
    // QR Code Functions
    async function generateSingleQR(productId) {
      const product = allProducts.find(p => p.id === productId);
      
      showLoading('Gerando QR Code...');
      
      try {
        const tempDiv = document.createElement('div');
        tempDiv.style.display = 'none';
        document.body.appendChild(tempDiv);
        
        const qr = new QRCode(tempDiv, {
          text: product.codigo,
          width: 200,
          height: 200
        });
        
        await new Promise(resolve => setTimeout(resolve, 100));
        
        const canvas = tempDiv.querySelector('canvas');
        const qrCodeUrl = canvas.toDataURL('image/png');
        
        await db.ref(`produtos/${productId}`).update({
          qrCode: product.codigo,
          qrCodeUrl: qrCodeUrl,
          ultimaAtualizacao: Date.now()
        });
        
        document.body.removeChild(tempDiv);
        
        await loadProducts();
        hideLoading();
        showToast('QR Code gerado!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao gerar QR Code', 'error');
      }
    }
    
    async function generateAllQRCodes() {
      const productsWithoutQR = allProducts.filter(p => !p.qrCodeUrl || p.qrCodeUrl.trim() === '');
      
      if (productsWithoutQR.length === 0) {
        showToast('Todos os produtos já possuem QR Code!', 'info');
        return;
      }
      
      showLoading('Gerando QR Codes...', `0 de ${productsWithoutQR.length}`, true);
      
      try {
        for (let i = 0; i < productsWithoutQR.length; i++) {
          const product = productsWithoutQR[i];
          
          const tempDiv = document.createElement('div');
          tempDiv.style.display = 'none';
          document.body.appendChild(tempDiv);
          
          const qr = new QRCode(tempDiv, {
            text: product.codigo,
            width: 200,
            height: 200
          });
          
          await new Promise(resolve => setTimeout(resolve, 100));
          
          const canvas = tempDiv.querySelector('canvas');
          const qrCodeUrl = canvas.toDataURL('image/png');
          
          await db.ref(`produtos/${product.id}`).update({
            qrCode: product.codigo,
            qrCodeUrl: qrCodeUrl,
            ultimaAtualizacao: Date.now()
          });
          
          document.body.removeChild(tempDiv);
          
          const progress = ((i + 1) / productsWithoutQR.length) * 100;
          updateProgress(progress, `${i + 1} de ${productsWithoutQR.length}`);
          
          await new Promise(resolve => setTimeout(resolve, 50));
        }
        
        await loadProducts();
        hideLoading();
        showToast(`${productsWithoutQR.length} QR Codes gerados com sucesso!`, 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao gerar QR Codes', 'error');
      }
    }
    
    // Scanner Functions with Cooldown
    function initScanner() {
      if (html5QrCode) return;
      
      html5QrCode = new Html5Qrcode("reader");
      
      const config = { 
        fps: 10, 
        qrbox: { width: 250, height: 250 },
        aspectRatio: 1.0
      };
      
      html5QrCode.start(
        { facingMode: "environment" },
        config,
        onScanSuccess,
        onScanError
      ).catch(err => {
        console.log('Câmera não disponível ou permissão negada');
      });
    }
    
    function onScanSuccess(decodedText, decodedResult) {
      const now = Date.now();
      
      if (decodedText === lastScannedCode && (now - lastScanTime) < SCAN_COOLDOWN) {
        return;
      }
      
      lastScannedCode = decodedText;
      lastScanTime = now;
      
      const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZPQ0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=');
      beep.play();
      
      const scannerCamera = document.getElementById('scannerCamera');
      scannerCamera.classList.add('success');
      setTimeout(() => scannerCamera.classList.remove('success'), 1500);
      
      const product = allProducts.find(p => p.codigo === decodedText);
      
      if (product) {
        scannerHistory.unshift({ code: decodedText, time: now });
        scannerHistory = scannerHistory.slice(0, 5);
        renderScannerHistory();
        showProductModal(product);
      } else {
        showToast('Produto não encontrado!', 'error');
      }
    }
    
    function onScanError(errorMessage) {
      // Ignore scan errors
    }
    
    function renderScannerHistory() {
      const container = document.getElementById('scannerHistory');
      
      if (scannerHistory.length === 0) {
        container.innerHTML = '<p style="text-align: center; color: var(--text-muted);">Nenhuma leitura ainda</p>';
        return;
      }
      
      container.innerHTML = scannerHistory.map(item => `
        <div class="history-item">
          <span class="history-code">${item.code}</span>
          <span class="history-time">${formatDate(item.time)}</span>
        </div>
      `).join('');
    }
    
    function showProductModal(product) {
      const status = getStockStatus(product.quantidade);
      
      const bodyHTML = `
        <div style="text-align: center; margin-bottom: 20px;">
          ${product.qrCodeUrl ? `
            <img src="${product.qrCodeUrl}" alt="QR Code" style="width: 150px; height: 150px; margin: 0 auto 15px; display: block;" loading="lazy" onerror="this.style.display='none';">
          ` : ''}
          <span class="product-code" style="display: inline-block; margin-bottom: 10px;">${product.codigo}</span>
          <h2 style="font-size: 22px; font-weight: 700; margin-bottom: 10px;">${product.nome}</h2>
          <span class="product-status status-${status.class}">${status.text}</span>
        </div>
        <div style="background: #f8fafc; padding: 20px; border-radius: 12px; margin-bottom: 20px;">
          <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
            <div>
              <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 5px;">Estoque</p>
              <p style="font-size: 20px; font-weight: 700;">${formatNumber(product.quantidade)}</p>
            </div>
            <div>
              <p style="color: var(--text-muted); font-size: 12px; margin-bottom: 5px;">Custo</p>
              <p style="font-size: 20px; font-weight: 700;">${formatMoney(product.custoUnitario)}</p>
            </div>
          </div>
        </div>
      `;
      
      let footerHTML = `
        <button class="btn" onclick="closeModal()" style="background: #64748b; color: white;">Fechar</button>
        <button class="btn btn-warning" onclick="closeModal(); openRetirarModal('${product.id}')">
          <i class="fas fa-minus"></i> Retirar
        </button>
      `;
      
      if (currentUser.role === 'admin') {
        footerHTML = `
          <button class="btn" onclick="closeModal()" style="background: #64748b; color: white;">Fechar</button>
          <button class="btn btn-success" onclick="closeModal(); openAddStockModal('${product.id}')">
            <i class="fas fa-plus"></i> Adicionar
          </button>
          <button class="btn btn-warning" onclick="closeModal(); openRetirarModal('${product.id}')">
            <i class="fas fa-minus"></i> Retirar
          </button>
          <button class="btn btn-danger" onclick="closeModal(); deleteProduct('${product.id}')">
            <i class="fas fa-trash"></i> Excluir
          </button>
        `;
      }
      
      openModal('Produto Encontrado', bodyHTML, footerHTML);
    }
    
  // NFe Functions - REAL BARCODE SCANNING com Quagga.js
let barcodeScanner = null;
let isScanning = false;

async function loadNFes() {
  try {
    const snapshot = await db.ref('nfes').once('value');
    const nfes = snapshot.val() || {};
    
    allNFes = Object.keys(nfes).map(key => ({
      id: key,
      ...nfes[key]
    })).sort((a, b) => new Date(b.dataHora) - new Date(a.dataHora));
    
    renderNFes();
  } catch (error) {
    console.error('Erro ao carregar NFes:', error);
    showToast('Erro ao carregar notas fiscais', 'error');
  }
}

function renderNFes() {
  const list = document.getElementById('nfeList');
  
  if (!list) return;
  
  if (allNFes.length === 0) {
    list.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhuma nota fiscal cadastrada</p>';
    return;
  }
  
  list.innerHTML = allNFes.map(nfe => `
    <div class="nfe-card">
      <div class="nfe-header">
        <span class="nfe-number">NF-e: ${nfe.numero}</span>
        <span class="nfe-date">${formatDate(nfe.dataHora)}</span>
      </div>
      <div class="nfe-details">
        <div class="nfe-detail-item">
          <span style="color: var(--text-muted);">Fornecedor:</span>
          <span style="font-weight: 600;">${nfe.fornecedor}</span>
        </div>
        <div class="nfe-detail-item">
          <span style="color: var(--text-muted);">Valor Total:</span>
          <span style="font-weight: 700; color: var(--primary-mid);">${formatMoney(nfe.valorTotal)}</span>
        </div>
        <div class="nfe-detail-item">
          <span style="color: var(--text-muted);">Itens:</span>
          <span style="font-weight: 600;">${nfe.itens ? nfe.itens.length : 0} produtos</span>
        </div>
      </div>
      <div class="nfe-actions">
        <button class="btn-small btn-info" onclick="viewNFeDetails('${nfe.id}')">
          <i class="fas fa-eye"></i> Ver Detalhes
        </button>
        <button class="btn-small btn-warning" onclick="editNFe('${nfe.id}')">
          <i class="fas fa-edit"></i> Editar
        </button>
        <button class="btn-small btn-danger" onclick="deleteNFe('${nfe.id}')">
          <i class="fas fa-trash"></i> Excluir
        </button>
      </div>
    </div>
  `).join('');
}

function openNFeScanModal() {
  const bodyHTML = `
    <div style="background: #eff6ff; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #3b82f6;">
      <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #1e40af;">
        <i class="fas fa-info-circle"></i> Como usar?
      </h4>
      <p style="font-size: 13px; color: #475569; margin-bottom: 8px;">
        • Aponte a câmera para o <strong>código de barras</strong> da chave NFe (44 dígitos)
      </p>
      <p style="font-size: 13px; color: #475569; margin-bottom: 8px;">
        • O código será detectado <strong>automaticamente</strong>
      </p>
      <p style="font-size: 13px; color: #475569;">
        • Você poderá <strong>editar os dados antes de salvar</strong>
      </p>
    </div>
    <div class="camera-container" style="width: 100%; position: relative;">
      <video id="nfeVideo" style="width: 100%; max-width: 500px; height: 400px; background: #000; border-radius: 8px; display: block; margin: 0 auto;"></video>
      <canvas id="nfeCanvas" style="display: none;"></canvas>
    </div>
    <div id="barcodeResult" style="margin-top: 20px; text-align: center; min-height: 50px; font-size: 14px; color: #64748b;">
      Aguardando leitura...
    </div>
  `;
  
  const footerHTML = `
    <button class="btn" onclick="stopNFeScanner(); closeModal();" style="background: #64748b; color: white;">Cancelar</button>
  `;
  
  openModal('Escanear Código de Barras NFe', bodyHTML, footerHTML);
  
  setTimeout(() => startNFeScanner(), 500);
}

function startNFeScanner() {
  if (isScanning) return;
  isScanning = true;
  
  const video = document.getElementById('nfeVideo');
  const canvas = document.getElementById('nfeCanvas');
  const resultDiv = document.getElementById('barcodeResult');
  
  if (!video || !canvas) {
    console.error('Elementos de vídeo não encontrados');
    return;
  }
  
  const constraints = {
    video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } },
    audio: false
  };
  
  navigator.mediaDevices.getUserMedia(constraints)
    .then(stream => {
      video.srcObject = stream;
      video.play();
      
      resultDiv.innerHTML = '<span style="color: #059669;">✓ Câmera ativada - Posicione o código de barras</span>';
      
      const ctx = canvas.getContext('2d');
      let detectedCodes = new Set();
      
      const scanFrame = () => {
        if (!isScanning) return;
        
        try {
          canvas.width = video.videoWidth;
          canvas.height = video.videoHeight;
          ctx.drawImage(video, 0, 0);
          
          // Usar Quagga para detectar código de barras
          if (window.Quagga) {
            Quagga.decodeSingle({
              src: canvas.toDataURL('image/png'),
              numOfWorkers: 0,
              inputStream: { type: 'ImageData' },
              decoder: {
                readers: ['code_128_reader', 'ean_reader', 'ean_8_reader']
              }
            }, (result) => {
              if (result && result.codeResult && result.codeResult.code) {
                const code = result.codeResult.code;
                
                // Validar se é uma chave NFe (44 dígitos)
                if (code.length === 44 && /^\d+$/.test(code)) {
                  if (!detectedCodes.has(code)) {
                    detectedCodes.add(code);
                    resultDiv.innerHTML = `<span style="color: #059669; font-weight: bold;">✓ Código detectado: ${code}</span>`;
                    
                    // Parar scanner e processar
                    stopNFeScanner();
                    processNFeBarcode(code);
                  }
                }
              }
            });
          }
        } catch (err) {
          console.error('Erro ao escanear:', err);
        }
        
        requestAnimationFrame(scanFrame);
      };
      
      scanFrame();
    })
    .catch(err => {
      console.error('Erro ao acessar câmera:', err);
      resultDiv.innerHTML = `<span style="color: #dc2626;">✗ Erro ao acessar câmera: ${err.message}</span>`;
      isScanning = false;
    });
}

function stopNFeScanner() {
  isScanning = false;
  const video = document.getElementById('nfeVideo');
  
  if (video && video.srcObject) {
    video.srcObject.getTracks().forEach(track => track.stop());
  }
}

function processNFeBarcode(code) {
  // Extrair informações da chave NFe
  const uf = code.substring(0, 2);
  const aaaa = code.substring(2, 6);
  const mm = code.substring(6, 8);
  const dd = code.substring(8, 10);
  const cnpj = code.substring(10, 24);
  const numero = code.substring(25, 34);
  
  // Criar modal para edição
  const bodyHTML = `
    <div style="background: #f0fdf4; padding: 15px; border-radius: 8px; margin-bottom: 15px; border-left: 4px solid #16a34a;">
      <p style="font-size: 12px; color: #166534;"><strong>Chave NFe:</strong> ${code}</p>
    </div>
    
    <div class="form-group">
      <label>Número NFe</label>
      <input type="text" id="nfeNumero" value="${numero}" class="form-input" placeholder="Número da NF-e">
    </div>
    
    <div class="form-group">
      <label>CNPJ Fornecedor</label>
      <input type="text" id="nfeCNPJ" value="${cnpj}" class="form-input" placeholder="CNPJ do fornecedor">
    </div>
    
    <div class="form-group">
      <label>Nome do Fornecedor</label>
      <input type="text" id="nfeFornecedor" value="" class="form-input" placeholder="Nome do fornecedor">
    </div>
    
    <div class="form-group">
      <label>Valor Total</label>
      <input type="number" id="nfeValor" value="0" step="0.01" class="form-input" placeholder="0.00">
    </div>
    
    <div class="form-group">
      <label>Data Emissão</label>
      <input type="date" id="nfeData" value="${aaaa}-${mm}-${dd}" class="form-input">
    </div>
  `;
  
  const footerHTML = `
    <button class="btn" onclick="cancelNFeForm();" style="background: #64748b; color: white;">Cancelar</button>
    <button class="btn" onclick="saveNFeFromBarcode('${code}');" style="background: #3b82f6; color: white;">Salvar</button>
  `;
  
  openModal('Dados da NFe - Confirme as informações', bodyHTML, footerHTML);
}

function cancelNFeForm() {
  closeModal();
}

async function saveNFeFromBarcode(chaveNFe) {
  const numero = document.getElementById('nfeNumero').value;
  const cnpj = document.getElementById('nfeCNPJ').value;
  const fornecedor = document.getElementById('nfeFornecedor').value;
  const valor = parseFloat(document.getElementById('nfeValor').value) || 0;
  const data = document.getElementById('nfeData').value;
  
  if (!numero || !fornecedor || !data) {
    showToast('Preencha todos os campos obrigatórios', 'error');
    return;
  }
  
  try {
    const nfeData = {
      numero,
      chaveNFe,
      cnpj,
      fornecedor,
      valorTotal: valor,
      dataHora: new Date(data).toISOString(),
      itens: [],
      createdAt: new Date().toISOString()
    };
    
    await db.ref('nfes').push().set(nfeData);
    
    showToast('NFe salva com sucesso!', 'success');
    closeModal();
    loadNFes();
  } catch (error) {
    console.error('Erro ao salvar NFe:', error);
    showToast('Erro ao salvar NFe', 'error');
  }
}

function viewNFeDetails(nfeId) {
  const nfe = allNFes.find(n => n.id === nfeId);
  
  if (!nfe) {
    showToast('NFe não encontrada', 'error');
    return;
  }
  
  const bodyHTML = `
    <div style="background: #f8fafc; padding: 15px; border-radius: 8px; margin-bottom: 15px;">
      <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
        <div>
          <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Número NFe</p>
          <p style="font-weight: 700; font-size: 14px;">${nfe.numero}</p>
        </div>
        <div>
          <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Chave NFe</p>
          <p style="font-weight: 600; font-size: 13px; word-break: break-all;">${nfe.chaveNFe || 'N/A'}</p>
        </div>
        <div>
          <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Fornecedor</p>
          <p style="font-weight: 600; font-size: 14px;">${nfe.fornecedor}</p>
        </div>
        <div>
          <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">CNPJ</p>
          <p style="font-weight: 600; font-size: 14px;">${nfe.cnpj || 'N/A'}</p>
        </div>
        <div>
          <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Valor Total</p>
          <p style="font-weight: 700; font-size: 16px; color: var(--primary-mid);">${formatMoney(nfe.valorTotal)}</p>
        </div>
        <div>
          <p style="font-size: 12px; color: var(--text-muted); margin-bottom: 5px;">Data Emissão</p>
          <p style="font-weight: 600; font-size: 14px;">${formatDate(nfe.dataHora)}</p>
        </div>
      </div>
    </div>
    
    <div>
      <h4 style="margin: 20px 0 10px 0; font-size: 14px; font-weight: 700;">Itens (${nfe.itens ? nfe.itens.length : 0})</h4>
      ${nfe.itens && nfe.itens.length > 0 ? `
        <div style="max-height: 300px; overflow-y: auto;">
          ${nfe.itens.map((item, idx) => `
            <div style="padding: 10px; background: #f1f5f9; border-radius: 5px; margin-bottom: 8px; font-size: 13px;">
              <p style="margin: 0; font-weight: 600;">${idx + 1}. ${item.descricao}</p>
              <p style="margin: 5px 0 0 0; color: var(--text-muted);">Qtd: ${item.quantidade} | Valor: ${formatMoney(item.valor)}</p>
            </div>
          `).join('')}
        </div>
      ` : '<p style="color: var(--text-muted); font-size: 13px;">Nenhum item cadastrado</p>'}
    </div>
  `;
  
  const footerHTML = `
    <button class="btn" onclick="closeModal();" style="background: #64748b; color: white;">Fechar</button>
  `;
  
  openModal(`Detalhes NFe #${nfe.numero}`, bodyHTML, footerHTML);
}

async function editNFe(nfeId) {
  const nfe = allNFes.find(n => n.id === nfeId);
  
  if (!nfe) {
    showToast('NFe não encontrada', 'error');
    return;
  }
  
  const bodyHTML = `
    <div class="form-group">
      <label>Número NFe</label>
      <input type="text" id="editNumero" value="${nfe.numero}" class="form-input">
    </div>
    
    <div class="form-group">
      <label>Fornecedor</label>
      <input type="text" id="editFornecedor" value="${nfe.fornecedor}" class="form-input">
    </div>
    
    <div class="form-group">
      <label>CNPJ</label>
      <input type="text" id="editCNPJ" value="${nfe.cnpj || ''}" class="form-input">
    </div>
    
    <div class="form-group">
      <label>Valor Total</label>
      <input type="number" id="editValor" value="${nfe.valorTotal}" step="0.01" class="form-input">
    </div>
    
    <div class="form-group">
      <label>Data</label>
      <input type="date" id="editData" value="${nfe.dataHora.split('T')[0]}" class="form-input">
    </div>
  `;
  
  const footerHTML = `
    <button class="btn" onclick="closeModal();" style="background: #64748b; color: white;">Cancelar</button>
    <button class="btn" onclick="updateNFe('${nfeId}');" style="background: #3b82f6; color: white;">Atualizar</button>
  `;
  
  openModal(`Editar NFe #${nfe.numero}`, bodyHTML, footerHTML);
}

async function updateNFe(nfeId) {
  const numero = document.getElementById('editNumero').value;
  const fornecedor = document.getElementById('editFornecedor').value;
  const cnpj = document.getElementById('editCNPJ').value;
  const valor = parseFloat(document.getElementById('editValor').value);
  const data = document.getElementById('editData').value;
  
  if (!numero || !fornecedor || !data) {
    showToast('Preencha todos os campos', 'error');
    return;
  }
  
  try {
    await db.ref('nfes/' + nfeId).update({
      numero,
      fornecedor,
      cnpj,
      valorTotal: valor,
      dataHora: new Date(data).toISOString()
    });
    
    showToast('NFe atualizada com sucesso!', 'success');
    closeModal();
    loadNFes();
  } catch (error) {
    console.error('Erro ao atualizar NFe:', error);
    showToast('Erro ao atualizar NFe', 'error');
  }
}

async function deleteNFe(nfeId) {
  if (!confirm('Tem certeza que deseja excluir esta NFe?')) return;
  
  try {
    await db.ref('nfes/' + nfeId).remove();
    showToast('NFe excluída com sucesso!', 'success');
    loadNFes();
  } catch (error) {
    console.error('Erro ao deletar NFe:', error);
    showToast('Erro ao excluir NFe', 'error');
  }
}

// Funções auxiliares
function formatDate(dateString) {
  try {
    const date = new Date(dateString);
    return date.toLocaleDateString('pt-BR');
  } catch {
    return 'Data inválida';
  }
}

function formatMoney(value) {
  return new Intl.NumberFormat('pt-BR', {
    style: 'currency',
    currency: 'BRL'
  }).format(value || 0);
}

function showToast(message, type = 'info') {
  const toast = document.createElement('div');
  toast.style.cssText = `
    position: fixed;
    bottom: 20px;
    right: 20px;
    padding: 12px 16px;
    border-radius: 6px;
    background: ${type === 'error' ? '#dc2626' : type === 'success' ? '#16a34a' : '#3b82f6'};
    color: white;
    z-index: 9999;
    font-size: 14px;
    animation: slideIn 0.3s ease-out;
  `;
  toast.textContent = message;
  document.body.appendChild(toast);
  
  setTimeout(() => toast.remove(), 3000);
}

// Carregar NFes quando página carrega
document.addEventListener('DOMContentLoaded', () => {
  setTimeout(loadNFes, 1000);
});


    
    function startBarcodeScanner() {
      quaggaInstance = true;
      
      Quagga.init({
        inputStream: {
          type: "LiveStream",
          target: document.querySelector('#barcodeReader'),
          constraints: {
            facingMode: "environment",
            width: 640,
            height: 480
          }
        },
        decoder: {
          readers: [
            "code_128_reader",
            "ean_reader",
            "ean_8_reader",
            "code_39_reader",
            "code_39_vin_reader",
            "codabar_reader",
            "upc_reader",
            "upc_e_reader",
            "i2of5_reader"
          ]
        },
        locate: true,
        locator: {
          patchSize: "medium",
          halfSample: true
        }
      }, function(err) {
        if (err) {
          showToast('Erro ao iniciar scanner de código de barras', 'error');
          console.error(err);
          return;
        }
        Quagga.start();
      });
      
      let lastDetectedCode = '';
      let lastDetectionTime = 0;
      
      Quagga.onDetected(function(result) {
        const code = result.codeResult.code;
        const now = Date.now();
        
        if (code === lastDetectedCode && (now - lastDetectionTime) < 3000) {
          return;
        }
        
        lastDetectedCode = code;
        lastDetectionTime = now;
        
        const beep = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJivrJBhNjVgodDbq2EcBj+a2/LDciUFLIHO8tiJNwgZaLvt559NEAxQp+PwtmMcBjiR1/LMeSwFJHfH8N2QQAoUXrTp66hVFApGn+DyvmwhBTGH0fPTgjMGHm7A7+OZPQ0AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA=');
        beep.play();
        
        document.getElementById('barcodeResult').innerHTML = `
          <div style="padding: 15px; background: #dcfce7; border-radius: 10px; color: #166534;">
            <i class="fas fa-check-circle" style="font-size: 24px; margin-bottom: 10px;"></i>
            <p style="font-weight: 700; margin-bottom: 5px;">Código Detectado!</p>
            <p style="font-family: monospace; font-size: 14px;">${code}</p>
          </div>
        `;
        
        setTimeout(() => {
          stopBarcodeScanner();
          processNFeBarcode(code);
        }, 1500);
      });
    }
    
    function stopBarcodeScanner() {
      if (quaggaInstance) {
        Quagga.stop();
        quaggaInstance = null;
      }
    }
    
    async function processNFeBarcode(barcode) {
      closeModal();
      
      if (barcode.length !== 44) {
        showToast('Código de barras inválido! A chave NFe deve ter 44 dígitos.', 'error');
        return;
      }
      
      // Extrair dados codificados na chave NFe
      const dadosExtraidos = extractNFeData(barcode);
      
      // Abrir formulário com dados pré-preenchidos
      openNFeManualForm(barcode, dadosExtraidos);
    }
    
    function extractNFeData(chave) {
      // Estrutura da Chave de Acesso NFe (44 dígitos):
      // Posições 0-1: UF (Código do Estado)
      // Posições 2-7: AAMM (Ano e Mês de emissão)
      // Posições 8-21: CNPJ do Emissor
      // Posições 22-23: Modelo (55 = NFe, 65 = NFCe)
      // Posições 24-26: Série
      // Posições 27-35: Número da NFe
      // Posições 36-43: Código Numérico
      // Posição 44: Dígito Verificador
      
      const uf = chave.substring(0, 2);
      const aamm = chave.substring(2, 6);
      const ano = '20' + aamm.substring(0, 2);
      const mes = aamm.substring(2, 4);
      const cnpj = chave.substring(6, 20);
      const modelo = chave.substring(20, 22);
      const serie = chave.substring(22, 25);
      const numero = chave.substring(25, 34);
      
      // Formatar CNPJ: 00.000.000/0000-00
      const cnpjFormatado = cnpj.replace(/^(\d{2})(\d{3})(\d{3})(\d{4})(\d{2})$/, '$1.$2.$3/$4-$5');
      
      // Mapa de UF
      const ufs = {
        '11': 'RO', '12': 'AC', '13': 'AM', '14': 'RR', '15': 'PA', '16': 'AP', '17': 'TO',
        '21': 'MA', '22': 'PI', '23': 'CE', '24': 'RN', '25': 'PB', '26': 'PE', '27': 'AL',
        '28': 'SE', '29': 'BA', '31': 'MG', '32': 'ES', '33': 'RJ', '35': 'SP', '41': 'PR',
        '42': 'SC', '43': 'RS', '50': 'MS', '51': 'MT', '52': 'GO', '53': 'DF'
      };
      
      const estadoUF = ufs[uf] || 'Desconhecido';
      const tipoNota = modelo === '55' ? 'NFe' : modelo === '65' ? 'NFCe' : 'Nota';
      
      return {
        numero: parseInt(numero).toString(), // Remove zeros à esquerda
        cnpj: cnpjFormatado,
        serie: parseInt(serie).toString(),
        modelo: tipoNota,
        uf: estadoUF,
        dataEmissao: `${mes}/${ano}`,
        mesAno: `${ano}-${mes}`
      };
    }
    
    function openNFeManualForm(chaveAcesso = '', dadosExtraidos = null) {
      const bodyHTML = `
        <form id="nfeManualForm">
          ${dadosExtraidos ? `
            <div style="background: #dcfce7; padding: 15px; border-radius: 10px; margin-bottom: 20px; border-left: 4px solid #10b981;">
              <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #166534;">
                <i class="fas fa-check-circle"></i> Dados Extraídos Automaticamente
              </h4>
              <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; font-size: 13px; color: #166534;">
                <div><strong>Tipo:</strong> ${dadosExtraidos.modelo}</div>
                <div><strong>Série:</strong> ${dadosExtraidos.serie}</div>
                <div><strong>UF:</strong> ${dadosExtraidos.uf}</div>
                <div><strong>Emissão:</strong> ${dadosExtraidos.dataEmissao}</div>
              </div>
            </div>
          ` : ''}
          <div class="form-group">
            <label>Chave de Acesso (44 dígitos) <span style="color: #64748b; font-size: 12px;">(Opcional)</span></label>
            <input type="text" id="nfeChave" value="${chaveAcesso}" maxlength="44" style="padding-left: 15px; font-family: monospace;" ${dadosExtraidos ? 'readonly' : ''} placeholder="Deixe em branco se não tiver">
          </div>
          <div class="form-group">
            <label>Número da NF-e</label>
            <input type="text" id="nfeNumeroManual" value="${dadosExtraidos ? dadosExtraidos.numero : ''}" required style="padding-left: 15px;" placeholder="Ex: 123456">
          </div>
          <div class="form-group">
            <label>Fornecedor</label>
            <input type="text" id="nfeFornecedorManual" required style="padding-left: 15px;" placeholder="Nome do fornecedor">
          </div>
          <div class="form-group">
            <label>CNPJ do Fornecedor <span style="color: #64748b; font-size: 12px;">(Opcional)</span></label>
            <input type="text" id="nfeCnpj" value="${dadosExtraidos ? dadosExtraidos.cnpj : ''}" maxlength="18" placeholder="00.000.000/0000-00" style="padding-left: 15px;">
          </div>
          <div style="background: #eff6ff; padding: 15px; border-radius: 10px; margin-top: 15px; border-left: 4px solid #3b82f6;">
            <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 8px; color: #1e40af;">
              <i class="fas fa-info-circle"></i> Próximo passo
            </h4>
            <p style="font-size: 13px; color: #475569;">
              Após salvar a NFe, você poderá adicionar os produtos. Eles serão automaticamente adicionados ao estoque!
            </p>
          </div>
        </form>
      `;
      
      const footerHTML = `
        <button class="btn" onclick="closeModal()" style="background: #64748b; color: white;">Cancelar</button>
        <button class="btn btn-primary" onclick="saveNFeManual()">Salvar e Adicionar Produtos</button>
      `;
      
      openModal('Cadastrar Nota Fiscal', bodyHTML, footerHTML);
    }
    
    async function saveNFeManual() {
      const chaveAcesso = document.getElementById('nfeChave').value.trim();
      const numero = document.getElementById('nfeNumeroManual').value.trim();
      const fornecedor = document.getElementById('nfeFornecedorManual').value.trim();
      const cnpj = document.getElementById('nfeCnpj').value.trim();
      
      if (!numero || !fornecedor) {
        showToast('Preencha o número da NFe e o fornecedor', 'error');
        return;
      }
      
      showLoading('Salvando nota fiscal...');
      
      try {
        const nfeRef = await db.ref('nfes').push({
          numero: numero,
          chaveAcesso: chaveAcesso || '',
          fornecedor: fornecedor,
          cnpjFornecedor: cnpj || '',
          valorTotal: 0,
          itens: [],
          dataHora: Date.now()
        });
        
        closeModal();
        await loadNFes();
        hideLoading();
        showToast('NFe cadastrada! Agora adicione os produtos.', 'success');
        
        // Abrir modal para adicionar produtos
        setTimeout(() => {
          openAddProductToNFe(nfeRef.key, numero);
        }, 500);
        
      } catch (error) {
        hideLoading();
        showToast('Erro ao salvar nota fiscal', 'error');
      }
    }
    
    function openAddProductToNFe(nfeId, nfeNumero) {
      const bodyHTML = `
        <div style="background: #f8fafc; padding: 15px; border-radius: 10px; margin-bottom: 20px;">
          <p style="font-weight: 700; color: var(--primary-mid);">NF-e: ${nfeNumero}</p>
          <p style="font-size: 13px; color: var(--text-muted); margin-top: 5px;">Adicione os produtos desta nota fiscal</p>
        </div>
        <form id="addProductToNFeForm">
          <div class="form-group">
            <label>Código do Produto</label>
            <input type="text" id="produtoCodigo" required style="padding-left: 15px;">
          </div>
          <div class="form-group">
            <label>Nome do Produto</label>
            <input type="text" id="produtoNome" required style="padding-left: 15px;">
          </div>
          <div class="form-group">
            <label>Quantidade</label>
            <input type="number" id="produtoQuantidade" min="1" required style="padding-left: 15px;">
          </div>
          <div class="form-group">
            <label>Valor Unitário</label>
            <input type="number" step="0.01" id="produtoValorUnitario" required style="padding-left: 15px;">
          </div>
        </form>
        <div id="produtosAdicionados" style="margin-top: 20px;"></div>
      `;
      
      const footerHTML = `
        <button class="btn" onclick="closeModal()" style="background: #64748b; color: white;">Finalizar</button>
        <button class="btn btn-success" onclick="addProductToNFe('${nfeId}', '${nfeNumero}')">
          <i class="fas fa-plus"></i> Adicionar Produto
        </button>
      `;
      
      openModal('Adicionar Produtos à NFe', bodyHTML, footerHTML);
      renderNFeProdutosAdicionados(nfeId);
    }
    
    async function renderNFeProdutosAdicionados(nfeId) {
      try {
        const snapshot = await db.ref(`nfes/${nfeId}`).once('value');
        const nfe = snapshot.val();
        
        const container = document.getElementById('produtosAdicionados');
        
        if (!nfe || !nfe.itens || nfe.itens.length === 0) {
          container.innerHTML = '<p style="text-align: center; color: var(--text-muted); padding: 20px;">Nenhum produto adicionado ainda</p>';
          return;
        }
        
        container.innerHTML = `
          <h4 style="font-size: 14px; font-weight: 700; margin-bottom: 10px;">Produtos Adicionados (${nfe.itens.length})</h4>
          ${nfe.itens.map((item, index) => `
            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
              <div style="display: flex; justify-content: space-between; align-items: start;">
                <div>
                  <p style="font-weight: 600; margin-bottom: 5px;">${item.nome}</p>
                  <p style="font-size: 12px; color: var(--text-muted);">
                    ${item.codigo} | Qtd: ${item.quantidade} | ${formatMoney(item.valorUnitario)}
                  </p>
                </div>
                <button class="btn-small btn-danger" onclick="removeProductFromNFe('${nfeId}', ${index})" style="padding: 6px 10px;">
                  <i class="fas fa-trash"></i>
                </button>
              </div>
            </div>
          `).join('')}
          <div style="background: #eff6ff; padding: 12px; border-radius: 8px; margin-top: 10px;">
            <p style="font-weight: 700; color: var(--primary-mid);">
              Total de Produtos: ${nfe.itens.reduce((sum, item) => sum + (item.quantidade * item.valorUnitario), 0).toLocaleString('pt-BR', { style: 'currency', currency: 'BRL' })}
            </p>
          </div>
        `;
      } catch (error) {
        console.error('Erro ao renderizar produtos:', error);
      }
    }
    
    async function addProductToNFe(nfeId, nfeNumero) {
      const codigo = document.getElementById('produtoCodigo').value.trim();
      const nome = document.getElementById('produtoNome').value.trim();
      const quantidade = parseInt(document.getElementById('produtoQuantidade').value);
      const valorUnitario = parseFloat(document.getElementById('produtoValorUnitario').value);
      
      if (!codigo || !nome || isNaN(quantidade) || isNaN(valorUnitario)) {
        showToast('Preencha todos os campos', 'error');
        return;
      }
      
      showLoading('Verificando produto no estoque...');
      
      try {
        // Verificar se produto JÁ EXISTE no estoque (por código OU nome)
        const snapshotCodigo = await db.ref('produtos').orderByChild('codigo').equalTo(codigo).once('value');
        const produtosPorCodigo = snapshotCodigo.val();
        
        const snapshotNome = await db.ref('produtos').orderByChild('nome').equalTo(nome).once('value');
        const produtosPorNome = snapshotNome.val();
        
        let productId = null;
        let existingProduct = null;
        
        // Prioridade: buscar por código primeiro
        if (produtosPorCodigo) {
          productId = Object.keys(produtosPorCodigo)[0];
          existingProduct = produtosPorCodigo[productId];
        } 
        // Se não encontrar por código, buscar por nome
        else if (produtosPorNome) {
          productId = Object.keys(produtosPorNome)[0];
          existingProduct = produtosPorNome[productId];
        }
        
        // Buscar NFe atual
        const snapshot = await db.ref(`nfes/${nfeId}`).once('value');
        const nfe = snapshot.val();
        
        // Adicionar produto à lista da NFe
        const itens = nfe.itens || [];
        itens.push({
          codigo,
          nome,
          quantidade,
          valorUnitario
        });
        
        // Calcular novo valor total da NFe
        const novoValorTotal = itens.reduce((sum, item) => sum + (item.quantidade * item.valorUnitario), 0);
        
        // Atualizar NFe com novo produto e valor total
        await db.ref(`nfes/${nfeId}`).update({
          itens: itens,
          valorTotal: novoValorTotal
        });
        
        if (existingProduct && productId) {
          // ✅ PRODUTO JÁ EXISTE - SOMAR quantidade ao estoque
          const novaQuantidade = existingProduct.quantidade + quantidade;
          
          await db.ref(`produtos/${productId}`).update({
            quantidade: novaQuantidade,
            nome: nome, // Atualizar nome caso tenha mudado
            custoUnitario: valorUnitario,
            ultimaAtualizacao: Date.now()
          });
          
          showToast(`Produto encontrado! ${quantidade} unidades adicionadas ao estoque existente`, 'success');
        } else {
          // ✅ PRODUTO NOVO - Criar no estoque
          await db.ref('produtos').push({
            codigo,
            nome,
            custoUnitario: valorUnitario,
            quantidade,
            qrCode: '',
            qrCodeUrl: '',
            ultimaAtualizacao: Date.now()
          });
          
          showToast('Produto novo criado no estoque!', 'success');
        }
        
        // Limpar formulário
        document.getElementById('produtoCodigo').value = '';
        document.getElementById('produtoNome').value = '';
        document.getElementById('produtoQuantidade').value = '';
        document.getElementById('produtoValorUnitario').value = '';
        
        // Recarregar lista de produtos adicionados
        await renderNFeProdutosAdicionados(nfeId);
        
        // Recarregar produtos e NFes
        await loadProducts();
        await loadNFes();
        
        hideLoading();
        
      } catch (error) {
        hideLoading();
        showToast('Erro ao adicionar produto', 'error');
        console.error(error);
      }
    }
    
    async function removeProductFromNFe(nfeId, index) {
      if (!window.confirm('Remover este produto da NFe?')) return;
      
      showLoading('Removendo produto...');
      
      try {
        const snapshot = await db.ref(`nfes/${nfeId}`).once('value');
        const nfe = snapshot.val();
        
        const itens = nfe.itens || [];
        itens.splice(index, 1);
        
        // Recalcular valor total da NFe
        const novoValorTotal = itens.reduce((sum, item) => sum + (item.quantidade * item.valorUnitario), 0);
        
        await db.ref(`nfes/${nfeId}`).update({
          itens: itens,
          valorTotal: novoValorTotal
        });
        
        await renderNFeProdutosAdicionados(nfeId);
        await loadNFes();
        hideLoading();
        showToast('Produto removido da NFe', 'success');
        
      } catch (error) {
        hideLoading();
        showToast('Erro ao remover produto', 'error');
      }
    }
    

    function viewNFeDetails(nfeId) {
      const nfe = allNFes.find(n => n.id === nfeId);
      
      const bodyHTML = `
        <div style="margin-bottom: 20px;">
          <h4 style="margin-bottom: 10px;">Informações da Nota</h4>
          <div style="background: #f8fafc; padding: 15px; border-radius: 10px;">
            <p style="margin-bottom: 8px;"><strong>Número:</strong> ${nfe.numero}</p>
            <p style="margin-bottom: 8px;"><strong>Fornecedor:</strong> ${nfe.fornecedor}</p>
            <p style="margin-bottom: 8px;"><strong>Valor Total:</strong> ${formatMoney(nfe.valorTotal)}</p>
            <p><strong>Data:</strong> ${formatDate(nfe.dataHora)}</p>
          </div>
        </div>
        <div>
          <h4 style="margin-bottom: 10px;">Itens (${nfe.itens.length})</h4>
          ${nfe.itens.map(item => `
            <div style="background: #f8fafc; padding: 12px; border-radius: 8px; margin-bottom: 8px;">
              <p style="font-weight: 600; margin-bottom: 5px;">${item.nome}</p>
              <div style="display: flex; justify-content: space-between; font-size: 14px; color: var(--text-muted);">
                <span>Código: ${item.codigo}</span>
                <span>Qtd: ${item.quantidade}</span>
                <span>${formatMoney(item.valorUnitario)}</span>
              </div>
            </div>
          `).join('')}
        </div>
      `;
      
      const footerHTML = `
        <button class="btn btn-primary" onclick="closeModal()">Fechar</button>
      `;
      
      openModal('Detalhes da Nota Fiscal', bodyHTML, footerHTML);
    }
    
    function editNFe(nfeId) {
      const nfe = allNFes.find(n => n.id === nfeId);
      openAddProductToNFe(nfeId, nfe.numero);
    }
    
    async function deleteNFe(nfeId) {
      if (!window.confirm('Tem certeza que deseja excluir esta nota fiscal?')) return;
      
      showLoading('Excluindo nota fiscal...');
      
      try {
        await db.ref(`nfes/${nfeId}`).remove();
        await loadNFes();
        hideLoading();
        showToast('Nota fiscal excluída!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao excluir nota fiscal', 'error');
      }
    }
    
    // Upload Functions
    document.getElementById('fileInput').addEventListener('change', handleFileUpload);
    
    async function handleFileUpload(e) {
      const file = e.target.files[0];
      if (!file) return;
      
      showLoading('Processando arquivo...', 'Lendo dados...', true);
      
      try {
        const data = await file.arrayBuffer();
        const workbook = XLSX.read(data);
        const sheetName = workbook.SheetNames[0];
        const worksheet = workbook.Sheets[sheetName];
        const jsonData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
        
        await processExcelData(jsonData);
        
        e.target.value = '';
      } catch (error) {
        hideLoading();
        showToast('Erro ao processar arquivo', 'error');
      }
    }
    
    async function processExcelData(data) {
      const columns = detectColumns(data);
      
      if (!columns.codigo || !columns.nome) {
        hideLoading();
        showToast('Não foi possível detectar as colunas necessárias', 'error');
        return;
      }
      
      let novos = 0, atualizados = 0, ignorados = 0, erros = 0;
      const processedCodes = new Set();
      
      const validRows = data.slice(columns.headerRow + 1).filter(row => {
        if (!row || row.length === 0) return false;
        const codigo = row[columns.codigo];
        return codigo && String(codigo).trim() !== '';
      });
      
      for (let i = 0; i < validRows.length; i++) {
        const row = validRows[i];
        
        try {
          const codigo = String(row[columns.codigo]).trim();
          const nome = String(row[columns.nome]).trim();
          
          if (!codigo || !nome || processedCodes.has(codigo)) {
            ignorados++;
            continue;
          }
          
          processedCodes.add(codigo);
          
          const custoUnitario = columns.custo !== -1 ? parseFloat(row[columns.custo]) || 0 : 0;
          const quantidade = columns.quantidade !== -1 ? parseInt(row[columns.quantidade]) || 0 : 0;
          
          const snapshot = await db.ref('produtos').orderByChild('codigo').equalTo(codigo).once('value');
          
          if (snapshot.exists()) {
            const productId = Object.keys(snapshot.val())[0];
            await db.ref(`produtos/${productId}`).update({
              nome,
              custoUnitario,
              quantidade,
              ultimaAtualizacao: Date.now()
            });
            atualizados++;
          } else {
            await db.ref('produtos').push({
              codigo,
              nome,
              custoUnitario,
              quantidade,
              qrCode: '',
              qrCodeUrl: '',
              ultimaAtualizacao: Date.now()
            });
            novos++;
          }
          
          const progress = ((i + 1) / validRows.length) * 100;
          updateProgress(progress, `${i + 1} de ${validRows.length}`);
          
        } catch (error) {
          erros++;
        }
      }
      
      await loadProducts();
      hideLoading();
      
      showUploadResult(novos, atualizados, ignorados, erros);
    }
    
    function detectColumns(data) {
      const result = {
        codigo: -1,
        nome: -1,
        custo: -1,
        quantidade: -1,
        headerRow: -1
      };
      
      for (let i = 0; i < Math.min(20, data.length); i++) {
        const row = data[i];
        if (!row) continue;
        
        for (let j = 0; j < row.length; j++) {
          const cell = String(row[j]).toLowerCase().trim();
          
          if (cell.includes('cod') && result.codigo === -1) {
            result.codigo = j;
            result.headerRow = i;
          }
          if (cell.includes('nome') && result.nome === -1) {
            result.nome = j;
            result.headerRow = i;
          }
          if ((cell.includes('custo') || cell.includes('preço') || cell.includes('valor')) && result.custo === -1) {
            result.custo = j;
          }
          if ((cell.includes('quantidade') || cell.includes('qtd') || cell.includes('estoque')) && result.quantidade === -1) {
            result.quantidade = j;
          }
        }
        
        if (result.codigo !== -1 && result.nome !== -1) break;
      }
      
      return result;
    }
    
    function showUploadResult(novos, atualizados, ignorados, erros) {
      const container = document.getElementById('uploadResult');
      
      container.innerHTML = `
        <div class="result-card success">
          <i class="fas fa-check-circle"></i>
          <div class="result-number">${novos}</div>
          <div class="result-label">Novos</div>
        </div>
        <div class="result-card success">
          <i class="fas fa-sync-alt"></i>
          <div class="result-number">${atualizados}</div>
          <div class="result-label">Atualizados</div>
        </div>
        <div class="result-card warning">
          <i class="fas fa-exclamation-triangle"></i>
          <div class="result-number">${ignorados}</div>
          <div class="result-label">Ignorados</div>
        </div>
        ${erros > 0 ? `
          <div class="result-card error">
            <i class="fas fa-times-circle"></i>
            <div class="result-number">${erros}</div>
            <div class="result-label">Erros</div>
          </div>
        ` : ''}
      `;
      
      showToast(`Upload concluído! ${novos} novos, ${atualizados} atualizados`, 'success');
    }
    
    // Dashboard Functions
    async function loadRetiradas() {
      try {
        const snapshot = await db.ref('retiradas').once('value');
        const retiradas = snapshot.val() || {};
        
        allRetiradas = Object.keys(retiradas).map(key => ({
          id: key,
          ...retiradas[key]
        })).sort((a, b) => b.dataHora - a.dataHora);
        
        renderDashboard();
      } catch (error) {
        showToast('Erro ao carregar retiradas', 'error');
      }
    }
    
    function renderDashboard() {
      const totalProdutos = allProducts.length;
      const estoqueBaixo = allProducts.filter(p => p.quantidade < 10).length;
      
      const now = new Date();
      const firstDayOfMonth = new Date(now.getFullYear(), now.getMonth(), 1).getTime();
      const retiradasMes = allRetiradas.filter(r => r.dataHora >= firstDayOfMonth);
      
      const valorTotal = allProducts.reduce((sum, p) => sum + (p.quantidade * p.custoUnitario), 0);
      
      const statsGrid = document.getElementById('statsGrid');
      statsGrid.innerHTML = `
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #1e40af, #1e3a8a);">
              <i class="fas fa-box"></i>
            </div>
          </div>
          <div class="stat-value">${formatNumber(totalProdutos)}</div>
          <div class="stat-label">Total de Produtos</div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #0ea5e9, #0284c7);">
              <i class="fas fa-arrow-down"></i>
            </div>
          </div>
          <div class="stat-value">${formatNumber(retiradasMes.length)}</div>
          <div class="stat-label">Retiradas do Mês</div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #0369a1, #075985);">
              <i class="fas fa-dollar-sign"></i>
            </div>
          </div>
          <div class="stat-value">${formatMoney(valorTotal)}</div>
          <div class="stat-label">Valor Total Estoque</div>
        </div>
        <div class="stat-card">
          <div class="stat-header">
            <div class="stat-icon" style="background: linear-gradient(135deg, #64748b, #475569);">
              <i class="fas fa-exclamation-triangle"></i>
            </div>
          </div>
          <div class="stat-value">${formatNumber(estoqueBaixo)}</div>
          <div class="stat-label">Estoque Baixo</div>
        </div>
      `;
      
      renderRetiradaTable();
    }
    
    function renderRetiradaTable() {
      const table = document.getElementById('retiradaTable');
      const recentRetiradas = allRetiradas.slice(0, 10);
      
      if (recentRetiradas.length === 0) {
        table.innerHTML = '<tr><td colspan="6" style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhuma retirada registrada</td></tr>';
        return;
      }
      
      table.innerHTML = recentRetiradas.map(r => `
        <tr>
          <td data-label="Código"><span class="table-code">${r.codigo}</span></td>
          <td data-label="Produto"><strong>${r.nome}</strong></td>
          <td data-label="Quantidade"><strong>${formatNumber(r.quantidade)}</strong></td>
          <td data-label="Valor"><span class="table-value">${formatMoney(r.valorTotal)}</span></td>
          <td data-label="Usuário">${r.usuario}</td>
          <td data-label="Data">${formatDate(r.dataHora)}</td>
        </tr>
      `).join('');
    }
    
    // Users Functions
    async function loadUsers() {
      try {
        const snapshot = await db.ref('usuarios').once('value');
        const usuarios = snapshot.val() || {};
        
        const pendingUsers = [];
        const approvedUsers = [];
        
        Object.keys(usuarios).forEach(key => {
          const user = { id: key, ...usuarios[key] };
          if (user.approved) {
            approvedUsers.push(user);
          } else {
            pendingUsers.push(user);
          }
        });
        
        renderPendingUsers(pendingUsers);
        renderApprovedUsers(approvedUsers);
      } catch (error) {
        showToast('Erro ao carregar usuários', 'error');
      }
    }
    
    function renderPendingUsers(users) {
      const table = document.getElementById('pendingUsersTable');
      
      if (users.length === 0) {
        table.innerHTML = '<tr><td colspan="4" style="text-align: center; color: var(--text-muted); padding: 40px;">Nenhum usuário pendente</td></tr>';
        return;
      }
      
      table.innerHTML = users.map(user => `
        <tr>
          <td data-label="Nome"><strong>${user.name}</strong></td>
          <td data-label="Usuário">${user.username}</td>
          <td data-label="Data">${formatDate(user.createdAt)}</td>
          <td data-label="Ações">
            <div class="table-actions">
              <button class="btn-small btn-success" onclick="approveUser('${user.id}')">
                <i class="fas fa-check"></i> Aprovar
              </button>
              <button class="btn-small btn-danger" onclick="rejectUser('${user.id}')">
                <i class="fas fa-times"></i> Rejeitar
              </button>
            </div>
          </td>
        </tr>
      `).join('');
    }
    
    function renderApprovedUsers(users) {
      const table = document.getElementById('approvedUsersTable');
      
      table.innerHTML = users.map(user => `
        <tr>
          <td data-label="Nome"><strong>${user.name}</strong></td>
          <td data-label="Usuário">${user.username}</td>
          <td data-label="Tipo"><span class="table-badge ${user.role === 'admin' ? 'badge-admin' : 'badge-user'}">${user.role === 'admin' ? 'Admin' : 'Usuário'}</span></td>
          <td data-label="Data">${formatDate(user.createdAt)}</td>
        </tr>
      `).join('');
    }
    
    async function approveUser(userId) {
      showLoading('Aprovando usuário...');
      
      try {
        await db.ref(`usuarios/${userId}`).update({ approved: true });
        await loadUsers();
        hideLoading();
        showToast('Usuário aprovado!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao aprovar usuário', 'error');
      }
    }
    
    async function rejectUser(userId) {
      if (!window.confirm('Tem certeza que deseja rejeitar este usuário?')) return;
      
      showLoading('Rejeitando usuário...');
      
      try {
        await db.ref(`usuarios/${userId}`).remove();
        await loadUsers();
        hideLoading();
        showToast('Usuário rejeitado!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao rejeitar usuário', 'error');
      }
    }
    
    // Reports Functions
    async function generateReport() {
      const month = document.getElementById('reportMonth').value;
      const year = document.getElementById('reportYear').value;
      
      showLoading('Gerando relatório...');
      
      try {
        const startDate = new Date(year, parseInt(month) - 1, 1).getTime();
        const endDate = new Date(year, parseInt(month), 0, 23, 59, 59).getTime();
        
        const retiradas = allRetiradas.filter(r => 
          r.dataHora >= startDate && r.dataHora <= endDate
        );
        
        if (retiradas.length === 0) {
          hideLoading();
          showToast('Nenhuma retirada encontrada no período', 'info');
          return;
        }
        
        const { jsPDF } = window.jspdf;
        const doc = new jsPDF();
        
        doc.setFontSize(18);
        doc.text('Relatório de Retiradas', 14, 20);
        
        doc.setFontSize(12);
        doc.text(`Período: ${month}/${year}`, 14, 30);
        
        let y = 45;
        const pageHeight = doc.internal.pageSize.height;
        
        retiradas.forEach((r, index) => {
          if (y > pageHeight - 20) {
            doc.addPage();
            y = 20;
          }
          
          doc.setFontSize(10);
          doc.text(`${index + 1}. ${r.nome}`, 14, y);
          doc.text(`Código: ${r.codigo}`, 14, y + 5);
          doc.text(`Qtd: ${formatNumber(r.quantidade)}`, 14, y + 10);
          doc.text(`Valor: ${formatMoney(r.valorTotal)}`, 14, y + 15);
          doc.text(`Usuário: ${r.usuario}`, 14, y + 20);
          doc.text(`Data: ${formatDate(r.dataHora)}`, 14, y + 25);
          
          y += 35;
        });
        
        const totalValue = retiradas.reduce((sum, r) => sum + r.valorTotal, 0);
        if (y > pageHeight - 30) {
          doc.addPage();
          y = 20;
        }
        doc.setFontSize(14);
        doc.text(`Total: ${formatMoney(totalValue)}`, 14, y);
        
        doc.save(`relatorio-${month}-${year}.pdf`);
        
        hideLoading();
        showToast('Relatório gerado com sucesso!', 'success');
      } catch (error) {
        hideLoading();
        showToast('Erro ao gerar relatório', 'error');
      }
    }
    
    // Search
    document.getElementById('searchInput').addEventListener('input', () => {
      currentPage = 1;
      renderProducts();
    });
    
    // Initialize
    window.addEventListener('DOMContentLoaded', async () => {
      const savedUser = localStorage.getItem('currentUser');
      
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showApp();
      }
      
      try {
        const snapshot = await db.ref('usuarios').orderByChild('username').equalTo('admin').once('value');
        if (!snapshot.exists()) {
          await db.ref('usuarios').push({
            name: 'Administrador',
            username: 'admin',
            password: 'admin123',
            role: 'admin',
            approved: true,
            createdAt: Date.now()
          });
        }
      } catch (error) {
        console.error('Error creating default admin');
      }
    });
  </script>
 <script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'9beea8fa3540f1dd',t:'MTc2ODU3NzQ4OS4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
