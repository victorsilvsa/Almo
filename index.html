<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema de Almoxarifado</title>
    
    <!-- External Libraries -->
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- QR Code Library - Using qrious for better compatibility -->
    <script src="https://cdn.jsdelivr.net/npm/qrious@4.0.2/dist/qrious.min.js"></script>
    
    <!-- jsQR Library for QR Code scanning -->
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.js"></script>
    
    <!-- html2pdf.js for PDF generation -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2pdf.js/0.10.1/html2pdf.bundle.min.js"></script>
    
    <style>
        body {
            box-sizing: border-box;
        }

        /* ===== CSS VARIABLES ===== */
        :root {
            --primary-gradient: linear-gradient(135deg, #0d47a1, #1976d2, #42a5f5);
            --secondary-gradient: linear-gradient(180deg, #0d47a1, #1e88e5);
            --dark-gradient: linear-gradient(135deg, #263238, #37474f, #455a64);
            --accent-gradient: linear-gradient(45deg, #1565c0, #1976d2);
            --success-color: #2e7d32;
            --warning-color: #f57c00;
            --error-color: #d32f2f;
            --info-color: #0288d1;
            --text-primary: #212121;
            --text-secondary: #757575;
            --surface: #ffffff;
            --background: #f8fafc;
            --border-color: #e0e7ff;
            --shadow-sm: 0 1px 3px rgba(0,0,0,0.12), 0 1px 2px rgba(0,0,0,0.24);
            --shadow-md: 0 4px 6px rgba(0,0,0,0.07), 0 2px 4px rgba(0,0,0,0.06);
            --shadow-lg: 0 10px 15px rgba(0,0,0,0.1), 0 4px 6px rgba(0,0,0,0.05);
            --shadow-xl: 0 20px 25px rgba(0,0,0,0.15), 0 10px 10px rgba(0,0,0,0.04);
        }

        /* ===== GLOBAL STYLES ===== */
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: var(--primary-gradient);
            color: var(--text-primary);
            line-height: 1.6;
            min-height: 100%;
            overflow-x: hidden;
            position: relative;
        }

        /* ===== BACKGROUND ANIMATION ===== */
        body::before {
            content: '';
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: 
                radial-gradient(circle at 20% 80%, rgba(66, 165, 245, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 80% 20%, rgba(25, 118, 210, 0.1) 0%, transparent 50%),
                radial-gradient(circle at 40% 40%, rgba(13, 71, 161, 0.05) 0%, transparent 50%);
            z-index: -1;
            animation: backgroundFloat 20s ease-in-out infinite;
        }

        @keyframes backgroundFloat {
            0%, 100% { transform: translateY(0px) rotate(0deg); }
            50% { transform: translateY(-20px) rotate(1deg); }
        }

        /* ===== MAIN CONTAINER ===== */
        .auth-container {
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
            position: relative;
        }

        .auth-card {
            background: var(--surface);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            width: 100%;
            max-width: 900px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            min-height: 600px;
            position: relative;
            backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        /* ===== LEFT PANEL - BRANDING ===== */
        .auth-brand {
            background: var(--secondary-gradient);
            color: white;
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            text-align: center;
            position: relative;
            overflow: hidden;
        }

        .auth-brand::before {
            content: '';
            position: absolute;
            top: -50%;
            left: -50%;
            width: 200%;
            height: 200%;
            background: 
                radial-gradient(circle, rgba(255,255,255,0.1) 1px, transparent 1px);
            background-size: 30px 30px;
            animation: floatPattern 30s linear infinite;
        }

        @keyframes floatPattern {
            0% { transform: translate(0, 0); }
            100% { transform: translate(30px, 30px); }
        }

        .brand-logo {
            font-size: 64px;
            margin-bottom: 24px;
            background: linear-gradient(45deg, #ffffff, #e3f2fd);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            position: relative;
            z-index: 1;
        }

        .brand-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 16px;
            position: relative;
            z-index: 1;
            letter-spacing: -0.025em;
        }

        .brand-subtitle {
            font-size: 18px;
            opacity: 0.9;
            font-weight: 400;
            position: relative;
            z-index: 1;
            line-height: 1.5;
        }

        .brand-features {
            margin-top: 40px;
            position: relative;
            z-index: 1;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            font-size: 14px;
            opacity: 0.9;
        }

        .feature-icon {
            width: 24px;
            height: 24px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
        }

        /* ===== RIGHT PANEL - FORMS ===== */
        .auth-form-container {
            padding: 60px 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            position: relative;
        }

        .form-header {
            text-align: center;
            margin-bottom: 40px;
        }

        .form-title {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
            letter-spacing: -0.025em;
        }

        .form-subtitle {
            color: var(--text-secondary);
            font-size: 16px;
            font-weight: 400;
        }

        /* ===== FORM STYLES ===== */
        .auth-form {
            width: 100%;
            transition: all 0.5s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .form-group {
            margin-bottom: 24px;
            position: relative;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
            font-size: 14px;
            letter-spacing: 0.025em;
        }

        .form-control {
            width: 100%;
            padding: 16px 20px;
            border: 2px solid var(--border-color);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 400;
            background: var(--surface);
            color: var(--text-primary);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
        }

        .form-control:focus {
            outline: none;
            border-color: #1976d2;
            box-shadow: 0 0 0 3px rgba(25, 118, 210, 0.1);
            transform: translateY(-1px);
        }

        .form-control.error {
            border-color: var(--error-color);
            box-shadow: 0 0 0 3px rgba(211, 47, 47, 0.1);
        }

        .input-icon {
            position: absolute;
            right: 16px;
            top: 50%;
            transform: translateY(-50%);
            color: var(--text-secondary);
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .input-icon:hover {
            color: var(--text-primary);
        }

        .error-message {
            color: var(--error-color);
            font-size: 12px;
            margin-top: 6px;
            display: none;
            font-weight: 500;
        }

        .error-message.show {
            display: block;
            animation: slideDown 0.3s ease;
        }

        @keyframes slideDown {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ===== CHECKBOX STYLES ===== */
        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }

        .custom-checkbox {
            position: relative;
            display: inline-block;
        }

        .custom-checkbox input {
            opacity: 0;
            position: absolute;
        }

        .checkmark {
            width: 20px;
            height: 20px;
            border: 2px solid var(--border-color);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .custom-checkbox input:checked + .checkmark {
            background: var(--primary-gradient);
            border-color: #1976d2;
        }

        .custom-checkbox input:checked + .checkmark::after {
            content: '\f00c';
            font-family: 'Font Awesome 6 Free';
            font-weight: 900;
            color: white;
            font-size: 12px;
        }

        .checkbox-label {
            font-size: 14px;
            color: var(--text-secondary);
            cursor: pointer;
            user-select: none;
        }

        /* ===== BUTTON STYLES ===== */
        .btn-primary {
            width: 100%;
            padding: 16px 24px;
            background: var(--primary-gradient);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
            letter-spacing: 0.025em;
        }

        .btn-primary::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .btn-primary:hover::before {
            left: 100%;
        }

        .btn-primary:active {
            transform: translateY(0);
        }

        .btn-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }

        .btn-loading {
            position: relative;
            color: transparent;
        }

        .btn-loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 20px;
            height: 20px;
            border: 2px solid rgba(255,255,255,0.3);
            border-top: 2px solid white;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translate(-50%, -50%) rotate(0deg); }
            100% { transform: translate(-50%, -50%) rotate(360deg); }
        }

        /* ===== FORM TOGGLE ===== */
        .form-toggle {
            text-align: center;
            margin-top: 32px;
            padding-top: 24px;
            border-top: 1px solid var(--border-color);
        }

        .toggle-text {
            color: var(--text-secondary);
            font-size: 14px;
            margin-bottom: 12px;
        }

        .toggle-link {
            color: #1976d2;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
            transition: color 0.3s ease;
        }

        .toggle-link:hover {
            color: #0d47a1;
            text-decoration: underline;
        }

        .form-container {
            position: relative;
            overflow: hidden;
        }

        .auth-form.slide-out-left {
            transform: translateX(-100%);
            opacity: 0;
        }

        .auth-form.slide-in-right {
            transform: translateX(0);
            opacity: 1;
        }

        .auth-form.slide-out-right {
            transform: translateX(100%);
            opacity: 0;
        }

        .auth-form.slide-in-left {
            transform: translateX(0);
            opacity: 1;
        }

        .auth-form.hidden {
            display: none;
        }

        .success-message {
            background: linear-gradient(135deg, #2e7d32, #4caf50);
            color: white;
            padding: 16px 20px;
            border-radius: 12px;
            margin-bottom: 24px;
            display: none;
            align-items: center;
            gap: 12px;
            font-weight: 500;
        }

        .success-message.show {
            display: flex;
            animation: slideDown 0.5s ease;
        }

        /* ===== MAIN SYSTEM STYLES ===== */
        .main-system {
            display: none;
            min-height: 100vh;
            background: var(--background);
        }

        .main-system.active {
            display: block;
        }

        /* ===== SIDEBAR STYLES ===== */
        .sidebar {
            width: 280px;
            background: var(--surface);
            box-shadow: var(--shadow-md);
            position: fixed;
            top: 0;
            left: 0;
            height: 100vh;
            z-index: 1000;
            transition: transform 0.3s ease;
            overflow-y: auto;
        }

        .sidebar.collapsed {
            transform: translateX(-100%);
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-gradient);
            color: white;
        }

        .sidebar-brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 20px;
            font-weight: 700;
        }

        .sidebar-nav {
            padding: 20px 0;
        }

        .nav-item {
            margin-bottom: 4px;
        }

        .nav-link {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            color: var(--text-secondary);
            text-decoration: none;
            transition: all 0.3s ease;
            border-left: 3px solid transparent;
        }

        .nav-link:hover {
            background: rgba(25, 118, 210, 0.1);
            color: #1976d2;
            border-left-color: #1976d2;
        }

        .nav-link.active {
            background: rgba(25, 118, 210, 0.15);
            color: #1976d2;
            border-left-color: #1976d2;
            font-weight: 600;
        }

        .nav-icon {
            width: 20px;
            text-align: center;
        }

        /* ===== MAIN CONTENT STYLES ===== */
        .main-content {
            margin-left: 280px;
            min-height: 100vh;
            transition: margin-left 0.3s ease;
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* ===== HEADER STYLES ===== */
        .main-header {
            background: var(--surface);
            box-shadow: var(--shadow-sm);
            padding: 16px 24px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .menu-toggle {
            background: none;
            border: none;
            font-size: 20px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 8px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        .menu-toggle:hover {
            background: var(--border-color);
            color: var(--text-primary);
        }

        .page-title {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.3s ease;
        }

        .user-avatar:hover {
            transform: scale(1.05);
        }

        /* ===== CONTENT AREA STYLES ===== */
        .content-area {
            padding: 24px;
            position: relative;
            overflow: hidden;
            min-height: calc(100vh - 80px);
        }

        .page-content {
            animation: fadeIn 0.3s ease;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            min-height: 400px;
            z-index: 1;
            opacity: 0;
            visibility: hidden;
            transform: translateY(20px);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .page-content.active {
            position: relative;
            opacity: 1;
            visibility: visible;
            transform: translateY(0);
            z-index: 10;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* ===== CARD STYLES ===== */
        .card {
            background: var(--surface);
            border-radius: 16px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 24px;
            display: flex;
            flex-direction: column;
        }

        .card:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .card-header {
            padding: 20px 24px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(25, 118, 210, 0.02);
            display: flex;
            align-items: center;
            justify-content: space-between;
            flex-shrink: 0;
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .card-body {
            padding: 24px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        /* ===== STATS GRID ===== */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 32px;
        }

        .stat-card {
            background: var(--surface);
            border-radius: 16px;
            padding: 24px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-md);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 4px;
            background: var(--primary-gradient);
        }

        .stat-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        .stat-icon {
            width: 48px;
            height: 48px;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            color: white;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
        }

        .stat-label {
            color: var(--text-secondary);
            font-size: 14px;
            font-weight: 500;
        }

        /* ===== TABLE STYLES ===== */
        .table-container {
            background: var(--surface);
            border-radius: 16px;
            overflow: hidden;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
        }

        .data-table th {
            background: rgba(25, 118, 210, 0.05);
            padding: 16px;
            text-align: left;
            font-weight: 600;
            color: var(--text-primary);
            border-bottom: 1px solid var(--border-color);
        }

        .data-table td {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .data-table tr:hover {
            background: rgba(25, 118, 210, 0.02);
        }

        /* ===== EMPTY STATE ===== */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 64px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-state-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-text {
            font-size: 14px;
            margin-bottom: 24px;
        }

        /* ===== PRODUCTS GRID ===== */
        .products-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
            gap: 24px;
            margin-top: 24px;
        }

        .product-card {
            background: var(--surface);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-color);
            overflow: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 380px;
        }

        .product-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
            border-color: rgba(25, 118, 210, 0.3);
        }

        .product-card-header {
            padding: 20px 20px 16px 20px;
            border-bottom: 1px solid var(--border-color);
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.02), rgba(25, 118, 210, 0.05));
            position: relative;
        }

        .product-card-code {
            font-size: 14px;
            font-weight: 700;
            color: #1976d2;
            background: rgba(25, 118, 210, 0.1);
            padding: 6px 12px;
            border-radius: 20px;
            display: inline-block;
            margin-bottom: 12px;
            letter-spacing: 0.5px;
        }

        .product-card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
            line-height: 1.3;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
            word-break: break-word;
            min-height: 48px;
            max-height: 48px;
        }

        .product-card-category {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            background: rgba(108, 117, 125, 0.1);
            padding: 4px 10px;
            border-radius: 12px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-card-body {
            padding: 20px;
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .product-card-description {
            font-size: 14px;
            color: var(--text-secondary);
            line-height: 1.5;
            margin-bottom: 16px;
            display: -webkit-box;
            -webkit-line-clamp: 3;
            -webkit-box-orient: vertical;
            overflow: hidden;
            text-overflow: ellipsis;
            word-wrap: break-word;
            word-break: break-word;
            min-height: 63px;
            max-height: 63px;
            flex: 1;
        }

        .product-card-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 16px;
            margin-bottom: 20px;
        }

        .product-stat {
            text-align: center;
            padding: 12px;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 12px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .product-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 4px;
            display: block;
        }

        .product-stat-label {
            font-size: 11px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .product-card-stock {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 12px 16px;
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.8), rgba(241, 245, 249, 0.8));
            border-radius: 12px;
            margin-bottom: 16px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .product-stock-info {
            display: flex;
            flex-direction: column;
        }

        .product-stock-current {
            font-size: 16px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
        }

        .product-stock-min {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 500;
        }

        .product-stock-badge {
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .stock-normal {
            background: rgba(46, 125, 50, 0.1);
            color: var(--success-color);
        }

        .stock-warning {
            background: rgba(2, 136, 209, 0.1);
            color: var(--info-color);
        }

        .stock-low {
            background: rgba(245, 124, 0, 0.1);
            color: var(--warning-color);
        }

        .stock-out {
            background: rgba(211, 47, 47, 0.1);
            color: var(--error-color);
        }

        .product-card-footer {
            padding: 16px 20px 20px 20px;
            border-top: 1px solid var(--border-color);
            background: rgba(248, 250, 252, 0.5);
        }

        .product-card-actions {
            display: flex;
            gap: 8px;
            margin-bottom: 12px;
        }

        .product-action-btn {
            flex: 1;
            padding: 10px 16px;
            border: 1px solid var(--border-color);
            border-radius: 10px;
            background: var(--surface);
            color: var(--text-primary);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            text-decoration: none;
        }

        .product-action-btn:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-sm);
        }

        .product-action-btn.primary {
            background: var(--primary-gradient);
            color: white;
            border-color: #1976d2;
        }

        .product-action-btn.primary:hover {
            background: linear-gradient(135deg, #0d47a1, #1565c0);
            color: white;
        }

        .product-action-btn.secondary {
            background: rgba(108, 117, 125, 0.1);
            color: var(--text-secondary);
            border-color: rgba(108, 117, 125, 0.2);
        }

        .product-action-btn.secondary:hover {
            background: rgba(108, 117, 125, 0.15);
            color: var(--text-primary);
        }

        /* ===== MODAL STYLES ===== */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.65);
            backdrop-filter: blur(8px);
            z-index: 1050;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            padding: 16px;
            box-sizing: border-box;
            overflow-y: auto;
        }

        .modal.show {
            opacity: 1;
            visibility: visible;
        }

        .modal-dialog {
            background: var(--surface);
            border-radius: 24px;
            box-shadow: var(--shadow-xl);
            width: 100%;
            max-width: 600px;
            min-height: auto;
            max-height: calc(100vh - 32px);
            overflow: hidden;
            transform: scale(0.92) translateY(24px);
            transition: all 0.4s cubic-bezier(0.34, 1.56, 0.64, 1);
            position: relative;
            margin: auto;
            display: flex;
            flex-direction: column;
        }

        .modal.show .modal-dialog {
            transform: scale(1) translateY(0);
        }

        .modal-content {
            border: none;
            border-radius: 24px;
            overflow: hidden;
            display: flex;
            flex-direction: column;
            height: 100%;
            min-height: 0;
            max-height: calc(100vh - 32px);
            background: linear-gradient(145deg, #ffffff 0%, #fafbfc 100%);
        }

        .modal-header {
            padding: 20px 24px 16px 24px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.08);
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: linear-gradient(135deg, rgba(25, 118, 210, 0.03), rgba(25, 118, 210, 0.08));
            flex-shrink: 0;
        }

        .modal-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0;
            display: flex;
            align-items: center;
            gap: 10px;
            line-height: 1.3;
        }

        .modal-title i {
            color: #1976d2;
            font-size: 16px;
            flex-shrink: 0;
            width: 20px;
            text-align: center;
        }

        .btn-close {
            background: rgba(0, 0, 0, 0.06);
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            color: var(--text-secondary);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            font-size: 16px;
            flex-shrink: 0;
        }

        .btn-close:hover {
            background: rgba(211, 47, 47, 0.12);
            color: #d32f2f;
            transform: scale(1.05);
        }

        .btn-close::before {
            content: 'Ã—';
            font-weight: 400;
            font-size: 20px;
            line-height: 1;
        }

        .modal-body {
            padding: 24px;
            overflow-y: auto;
            overflow-x: hidden;
            flex: 1;
            min-height: 0;
        }

        .modal-footer {
            padding: 16px 24px 20px 24px;
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            border-top: 1px solid rgba(0, 0, 0, 0.08);
            background: linear-gradient(135deg, rgba(248, 250, 252, 0.95), rgba(241, 245, 249, 0.95));
            flex-shrink: 0;
        }

        /* ===== BUTTON STYLES ===== */
        .btn {
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            transition: all 0.3s ease;
            border: 1px solid transparent;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .btn-sm {
            padding: 6px 12px;
            font-size: 12px;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
            border-color: var(--success-color);
        }

        .btn-success:hover {
            background: #1b5e20;
            color: white;
        }

        .btn-secondary {
            background: #6c757d;
            color: white;
            border-color: #6c757d;
        }

        .btn-secondary:hover {
            background: #5c636a;
            color: white;
        }

        .btn-outline-primary {
            color: #1976d2;
            border-color: #1976d2;
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: #1976d2;
            color: white;
        }

        /* ===== NOTIFICATION SYSTEM ===== */
        .notification-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 2000;
            max-width: 400px;
            width: 100%;
        }

        .notification {
            background: var(--surface);
            border-radius: 12px;
            box-shadow: var(--shadow-lg);
            border-left: 4px solid;
            padding: 16px 20px;
            margin-bottom: 12px;
            display: flex;
            align-items: flex-start;
            gap: 12px;
            transform: translateX(100%);
            opacity: 0;
            transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1);
            position: relative;
            overflow: hidden;
        }

        .notification.show {
            transform: translateX(0);
            opacity: 1;
        }

        .notification.success {
            border-left-color: var(--success-color);
        }

        .notification.error {
            border-left-color: var(--error-color);
        }

        .notification.warning {
            border-left-color: var(--warning-color);
        }

        .notification.info {
            border-left-color: var(--info-color);
        }

        .notification-icon {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 12px;
            color: white;
            flex-shrink: 0;
            margin-top: 2px;
        }

        .notification.success .notification-icon {
            background: var(--success-color);
        }

        .notification.error .notification-icon {
            background: var(--error-color);
        }

        .notification.warning .notification-icon {
            background: var(--warning-color);
        }

        .notification.info .notification-icon {
            background: var(--info-color);
        }

        .notification-content {
            flex: 1;
            min-width: 0;
        }

        .notification-title {
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            font-size: 14px;
        }

        .notification-message {
            color: var(--text-secondary);
            font-size: 13px;
            line-height: 1.4;
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: all 0.3s ease;
            flex-shrink: 0;
        }

        .notification-close:hover {
            background: rgba(0, 0, 0, 0.1);
            color: var(--text-primary);
        }

        .notification-progress {
            position: absolute;
            bottom: 0;
            left: 0;
            height: 3px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 0 0 12px 12px;
            animation: notificationProgress 5s linear forwards;
        }

        .notification.success .notification-progress {
            background: var(--success-color);
        }

        .notification.error .notification-progress {
            background: var(--error-color);
        }

        .notification.warning .notification-progress {
            background: var(--warning-color);
        }

        .notification.info .notification-progress {
            background: var(--info-color);
        }

        @keyframes notificationProgress {
            from { width: 100%; }
            to { width: 0%; }
        }

        /* ===== LOADING OVERLAY ===== */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(4px);
            z-index: 1500;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .loading-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .loading-content {
            background: var(--surface);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            box-shadow: var(--shadow-xl);
            max-width: 300px;
            width: 90%;
        }

        .loading-spinner {
            width: 48px;
            height: 48px;
            border: 4px solid rgba(25, 118, 210, 0.2);
            border-top: 4px solid #1976d2;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px auto;
        }

        .loading-text {
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 8px;
        }

        .loading-subtext {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* ===== BATCH QR STYLES ===== */
        .batch-qr-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .batch-qr-item {
            background: var(--surface);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            text-align: center;
            transition: all 0.3s ease;
        }

        .batch-qr-item:hover {
            box-shadow: var(--shadow-md);
            transform: translateY(-2px);
        }

        .batch-qr-code {
            margin-bottom: 12px;
        }

        .batch-qr-info {
            font-size: 12px;
            color: var(--text-secondary);
            font-weight: 600;
        }

        .batch-qr-name {
            font-size: 14px;
            color: var(--text-primary);
            font-weight: 600;
            margin-bottom: 4px;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        /* ===== QR SCANNER STYLES ===== */
        .scanner-container {
            position: relative;
            width: 100%;
            min-height: 400px;
            border-radius: 16px;
            overflow: hidden;
            background: #000;
        }

        .scanner-placeholder {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 2px dashed var(--border-color);
            border-radius: 16px;
        }

        .scanner-placeholder-content {
            text-align: center;
            padding: 40px 20px;
            max-width: 400px;
        }

        .scanner-placeholder-icon {
            font-size: 64px;
            color: var(--text-secondary);
            margin-bottom: 20px;
            opacity: 0.6;
        }

        .scanner-placeholder-content h4 {
            color: var(--text-primary);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .scanner-placeholder-content p {
            color: var(--text-secondary);
            margin-bottom: 24px;
            line-height: 1.5;
        }

        .scanner-features {
            display: flex;
            flex-direction: column;
            gap: 12px;
            margin-top: 24px;
        }

        .scanner-feature {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px 16px;
            background: rgba(25, 118, 210, 0.05);
            border-radius: 8px;
            font-size: 14px;
            color: var(--text-secondary);
        }

        .scanner-feature i {
            color: #1976d2;
            width: 16px;
            text-align: center;
        }

        .scanner-video-container {
            position: relative;
            width: 100%;
            height: 400px;
            background: #000;
            border-radius: 16px;
            overflow: hidden;
        }

        .scanner-video {
            width: 100%;
            height: 100%;
            object-fit: cover;
            border-radius: 16px;
        }

        .scanner-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            pointer-events: none;
        }

        .scanner-target {
            position: relative;
            width: 200px;
            height: 200px;
            margin-bottom: 40px;
        }

        .scanner-corners {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .corner {
            position: absolute;
            width: 30px;
            height: 30px;
            border: 3px solid #00ff00;
            border-radius: 4px;
        }

        .corner.top-left {
            top: 0;
            left: 0;
            border-right: none;
            border-bottom: none;
        }

        .corner.top-right {
            top: 0;
            right: 0;
            border-left: none;
            border-bottom: none;
        }

        .corner.bottom-left {
            bottom: 0;
            left: 0;
            border-right: none;
            border-top: none;
        }

        .corner.bottom-right {
            bottom: 0;
            right: 0;
            border-left: none;
            border-top: none;
        }

        .scanner-line {
            position: absolute;
            top: 50%;
            left: 0;
            width: 100%;
            height: 2px;
            background: linear-gradient(90deg, transparent, #00ff00, transparent);
            transform: translateY(-50%);
            animation: scannerLine 2s ease-in-out infinite;
        }

        @keyframes scannerLine {
            0%, 100% {
                opacity: 0;
                transform: translateY(-50%) scaleX(0.5);
            }
            50% {
                opacity: 1;
                transform: translateY(-50%) scaleX(1);
            }
        }

        .scanner-instructions {
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 12px 20px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
            text-align: center;
            backdrop-filter: blur(4px);
        }

        .scanner-error {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 400px;
            background: linear-gradient(135deg, #ffebee, #ffcdd2);
            border-radius: 16px;
        }

        .scanner-error-content {
            text-align: center;
            padding: 40px 20px;
            max-width: 400px;
        }

        .scanner-error-content i {
            font-size: 48px;
            color: var(--error-color);
            margin-bottom: 16px;
        }

        .scanner-error-content h4 {
            color: var(--error-color);
            margin-bottom: 12px;
            font-weight: 600;
        }

        .scanner-error-content p {
            color: var(--text-secondary);
            margin-bottom: 20px;
        }

        /* ===== SCAN HISTORY STYLES ===== */
        .empty-state-small {
            text-align: center;
            padding: 30px 15px;
        }

        .empty-state-icon-small {
            font-size: 32px;
            margin-bottom: 12px;
            opacity: 0.3;
            color: var(--text-secondary);
        }

        .empty-state-title-small {
            font-size: 14px;
            font-weight: 600;
            margin-bottom: 6px;
            color: var(--text-primary);
        }

        .empty-state-text-small {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .scan-history-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            margin-bottom: 8px;
            transition: all 0.3s ease;
            cursor: pointer;
        }

        .scan-history-item:hover {
            background: rgba(25, 118, 210, 0.05);
            border-color: rgba(25, 118, 210, 0.2);
        }

        .scan-history-item:last-child {
            margin-bottom: 0;
        }

        .scan-history-icon {
            width: 32px;
            height: 32px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            flex-shrink: 0;
        }

        .scan-history-info {
            flex: 1;
            min-width: 0;
        }

        .scan-history-name {
            font-size: 13px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scan-history-code {
            font-size: 11px;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        .scan-history-time {
            font-size: 10px;
            color: var(--text-secondary);
            text-align: right;
            flex-shrink: 0;
        }

        /* ===== SCANNED PRODUCT CARD ===== */
        .scanned-product-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 16px;
            padding: 12px;
            background: rgba(46, 125, 50, 0.1);
            border: 1px solid rgba(46, 125, 50, 0.2);
            border-radius: 8px;
        }

        .scanned-product-icon {
            width: 40px;
            height: 40px;
            background: var(--success-color);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 18px;
            flex-shrink: 0;
        }

        .scanned-product-details {
            flex: 1;
            min-width: 0;
        }

        .scanned-product-name {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .scanned-product-code {
            font-size: 12px;
            color: var(--text-secondary);
            font-family: 'Courier New', monospace;
        }

        .scanned-product-stats {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-bottom: 16px;
        }

        .scanned-product-stat {
            text-align: center;
            padding: 8px;
            background: rgba(248, 250, 252, 0.8);
            border-radius: 6px;
            border: 1px solid rgba(0, 0, 0, 0.05);
        }

        .scanned-product-stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 2px;
            display: block;
        }

        .scanned-product-stat-label {
            font-size: 10px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        /* ===== SCAN SUCCESS ANIMATION ===== */
        .scan-success-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(46, 125, 50, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 16px;
            z-index: 10;
            opacity: 0;
            visibility: hidden;
            transition: all 0.3s ease;
        }

        .scan-success-overlay.show {
            opacity: 1;
            visibility: visible;
        }

        .scan-success-content {
            text-align: center;
            color: white;
        }

        .scan-success-icon {
            font-size: 64px;
            margin-bottom: 16px;
            animation: scanSuccessPulse 0.6s ease-out;
        }

        .scan-success-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .scan-success-subtext {
            font-size: 14px;
            opacity: 0.9;
        }

        @keyframes scanSuccessPulse {
            0% {
                transform: scale(0.5);
                opacity: 0;
            }
            50% {
                transform: scale(1.2);
                opacity: 1;
            }
            100% {
                transform: scale(1);
                opacity: 1;
            }
        }

        /* ===== QUICK MOVEMENT MODAL ===== */
        .quick-movement-input {
            display: flex;
            align-items: center;
            gap: 8px;
            margin: 16px 0;
        }

        .quick-movement-input input {
            flex: 1;
            padding: 8px 12px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            font-size: 14px;
        }

        .quick-movement-input button {
            padding: 8px 12px;
            border: none;
            border-radius: 6px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .quantity-btn {
            background: rgba(25, 118, 210, 0.1);
            color: #1976d2;
            border: 1px solid rgba(25, 118, 210, 0.2);
        }

        .quantity-btn:hover {
            background: rgba(25, 118, 210, 0.2);
        }

        /* ===== PDF REPORT STYLES ===== */
        .pdf-report {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            color: var(--text-primary);
            background: white;
            padding: 40px;
            max-width: 210mm;
            margin: 0 auto;
            box-sizing: border-box;
        }

        .pdf-report * {
            box-sizing: border-box;
        }

        .pdf-report-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 40px;
            padding-bottom: 20px;
            border-bottom: 3px solid #1976d2;
        }

        .pdf-report-logo {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .pdf-report-logo-icon {
            width: 60px;
            height: 60px;
            background: var(--primary-gradient);
            color: white;
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 28px;
        }

        .pdf-report-logo-text h1 {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 4px 0;
            line-height: 1.2;
        }

        .pdf-report-logo-text p {
            font-size: 14px;
            color: var(--text-secondary);
            margin: 0;
        }

        .pdf-report-meta {
            text-align: right;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .pdf-report-meta div {
            margin-bottom: 4px;
        }

        .pdf-report-title {
            text-align: center;
            margin-bottom: 30px;
        }

        .pdf-report-title h2 {
            font-size: 28px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 0 0 8px 0;
        }

        .pdf-report-title p {
            font-size: 16px;
            color: var(--text-secondary);
            margin: 0;
        }

        .pdf-report-summary {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 20px;
            margin-bottom: 40px;
        }

        .pdf-summary-card {
            background: linear-gradient(135deg, #f8fafc, #e2e8f0);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .pdf-summary-card-value {
            font-size: 24px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 8px;
        }

        .pdf-summary-card-label {
            font-size: 12px;
            font-weight: 600;
            color: var(--text-secondary);
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pdf-report-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 30px;
            font-size: 11px;
        }

        .pdf-report-table th {
            background: linear-gradient(135deg, #1976d2, #1565c0);
            color: white;
            padding: 12px 8px;
            text-align: left;
            font-weight: 600;
            font-size: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pdf-report-table td {
            padding: 10px 8px;
            border-bottom: 1px solid var(--border-color);
            vertical-align: top;
        }

        .pdf-report-table tr:nth-child(even) {
            background: rgba(248, 250, 252, 0.5);
        }

        .pdf-report-table tr:hover {
            background: rgba(25, 118, 210, 0.05);
        }

        .pdf-status-badge {
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 9px;
            font-weight: 700;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .pdf-status-normal {
            background: rgba(46, 125, 50, 0.1);
            color: #2e7d32;
        }

        .pdf-status-warning {
            background: rgba(2, 136, 209, 0.1);
            color: #0288d1;
        }

        .pdf-status-low {
            background: rgba(245, 124, 0, 0.1);
            color: #f57c00;
        }

        .pdf-status-out {
            background: rgba(211, 47, 47, 0.1);
            color: #d32f2f;
        }

        .pdf-report-footer {
            margin-top: 40px;
            padding-top: 20px;
            border-top: 1px solid var(--border-color);
            text-align: center;
            font-size: 11px;
            color: var(--text-secondary);
        }

        .pdf-page-break {
            page-break-before: always;
        }

        .pdf-section-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            margin: 30px 0 20px 0;
            padding-bottom: 8px;
            border-bottom: 2px solid #1976d2;
        }

        .pdf-filters-info {
            background: rgba(25, 118, 210, 0.05);
            border: 1px solid rgba(25, 118, 210, 0.2);
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 30px;
            font-size: 12px;
        }

        .pdf-filters-info h4 {
            margin: 0 0 8px 0;
            font-size: 14px;
            color: var(--text-primary);
        }

        .pdf-filters-info p {
            margin: 4px 0;
            color: var(--text-secondary);
        }

        /* PDF-specific responsive adjustments */
        @media print {
            .pdf-report {
                padding: 20px;
                box-shadow: none;
            }
            
            .pdf-report-summary {
                grid-template-columns: repeat(2, 1fr);
                gap: 15px;
            }
            
            .pdf-report-table {
                font-size: 10px;
            }
            
            .pdf-report-table th,
            .pdf-report-table td {
                padding: 8px 6px;
            }
        }

        /* ===== RESPONSIVE DESIGN ===== */
        @media (max-width: 768px) {
            .auth-card {
                grid-template-columns: 1fr;
                max-width: 400px;
                min-height: auto;
            }

            .auth-brand {
                padding: 40px 30px;
                order: 2;
            }

            .brand-title {
                font-size: 24px;
            }

            .brand-subtitle {
                font-size: 16px;
            }

            .brand-features {
                display: none;
            }

            .auth-form-container {
                padding: 40px 30px;
                order: 1;
            }

            .form-title {
                font-size: 24px;
            }

            .sidebar {
                transform: translateX(-100%);
                z-index: 1100;
                width: 100%;
                max-width: 280px;
            }

            .sidebar.show {
                transform: translateX(0);
                box-shadow: 0 0 20px rgba(0,0,0,0.3);
            }

            .main-content {
                margin-left: 0;
                width: 100%;
            }

            .main-header {
                padding: 12px 16px;
            }

            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
                gap: 12px;
            }

            .page-title {
                font-size: 18px;
            }

            .content-area {
                padding: 12px;
            }

            .modal {
                padding: 8px;
                align-items: flex-start;
                padding-top: 20px;
            }

            .modal-dialog {
                max-width: 100%;
                margin: 0;
                max-height: calc(100vh - 40px);
                width: 100%;
            }

            .products-grid {
                grid-template-columns: 1fr;
                gap: 16px;
            }

            .product-card {
                min-height: 350px;
            }

            /* Scanner mobile styles */
            .scanner-container {
                min-height: 300px;
            }

            .scanner-video-container {
                height: 300px;
            }

            .scanner-target {
                width: 150px;
                height: 150px;
                margin-bottom: 20px;
            }

            .scanner-instructions {
                font-size: 12px;
                padding: 8px 16px;
            }

            .scanner-placeholder-content {
                padding: 20px 15px;
            }

            .scanner-features {
                display: none;
            }

            .scanned-product-stats {
                grid-template-columns: 1fr;
                gap: 6px;
            }
        }

        @media (max-width: 480px) {
            .auth-container {
                padding: 10px;
            }

            .auth-card {
                border-radius: 16px;
            }

            .auth-form-container {
                padding: 30px 20px;
            }

            .auth-brand {
                padding: 30px 20px;
            }

            .content-area {
                padding: 12px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
                gap: 12px;
            }

            .main-header {
                padding: 8px 12px;
            }

            .page-title {
                font-size: 16px;
            }
        }
    </style>
</head>
<body>
    <!-- ===== AUTHENTICATION SYSTEM ===== -->
    <div id="authSystem" class="auth-container">
        <div class="auth-card">
            <!-- Left Panel - Branding -->
            <div class="auth-brand">
                <div class="brand-logo">
                    <i class="fas fa-warehouse"></i>
                </div>
                <h1 class="brand-title">Sistema de Almoxarifado</h1>
                <p class="brand-subtitle">GestÃ£o completa e inteligente do seu estoque</p>
                
                <div class="brand-features">
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-chart-line"></i>
                        </div>
                        <span>RelatÃ³rios em tempo real</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-qrcode"></i>
                        </div>
                        <span>Scanner QR integrado</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-shield-alt"></i>
                        </div>
                        <span>SeguranÃ§a avanÃ§ada</span>
                    </div>
                    <div class="feature-item">
                        <div class="feature-icon">
                            <i class="fas fa-mobile-alt"></i>
                        </div>
                        <span>Acesso mobile</span>
                    </div>
                </div>
            </div>

            <!-- Right Panel - Forms -->
            <div class="auth-form-container">
                <div class="form-container">
                    <!-- ===== LOGIN FORM ===== -->
                    <form id="loginForm" class="auth-form" onsubmit="handleLogin(event)">
                        <div class="form-header">
                            <h2 class="form-title">Bem-vindo de volta</h2>
                            <p class="form-subtitle">FaÃ§a login para acessar o sistema</p>
                        </div>

                        <div class="success-message" id="loginSuccess">
                            <i class="fas fa-check-circle"></i>
                            <span>Login realizado com sucesso!</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="loginUsername">UsuÃ¡rio</label>
                            <input 
                                type="text" 
                                id="loginUsername" 
                                class="form-control" 
                                placeholder="Digite seu usuÃ¡rio"
                                required
                            >
                            <div class="error-message" id="loginUsernameError">UsuÃ¡rio invÃ¡lido</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="loginPassword">Senha</label>
                            <input 
                                type="password" 
                                id="loginPassword" 
                                class="form-control" 
                                placeholder="Digite sua senha"
                                required
                            >
                            <i class="input-icon fas fa-eye" onclick="togglePassword('loginPassword', this)"></i>
                            <div class="error-message" id="loginPasswordError">Senha deve ter pelo menos 6 caracteres</div>
                        </div>

                        <div class="checkbox-group">
                            <label class="custom-checkbox">
                                <input type="checkbox" id="rememberMe">
                                <span class="checkmark"></span>
                            </label>
                            <label class="checkbox-label" for="rememberMe">Lembrar de mim</label>
                        </div>

                        <button type="submit" class="btn-primary" id="loginBtn">
                            Entrar no Sistema
                        </button>

                        <div class="form-toggle">
                            <p class="toggle-text">NÃ£o tem uma conta?</p>
                            <a class="toggle-link" onclick="switchToRegister()">Criar conta gratuita</a>
                        </div>
                    </form>

                    <!-- ===== REGISTER FORM ===== -->
                    <form id="registerForm" class="auth-form hidden" onsubmit="handleRegister(event)">
                        <div class="form-header">
                            <h2 class="form-title">Criar nova conta</h2>
                            <p class="form-subtitle">Preencha os dados para comeÃ§ar</p>
                        </div>

                        <div class="success-message" id="registerSuccess">
                            <i class="fas fa-check-circle"></i>
                            <span>Conta criada com sucesso!</span>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="registerName">Nome completo</label>
                            <input 
                                type="text" 
                                id="registerName" 
                                class="form-control" 
                                placeholder="Seu nome completo"
                                required
                            >
                            <div class="error-message" id="registerNameError">Nome deve ter pelo menos 2 caracteres</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="registerUsername">Nome de usuÃ¡rio</label>
                            <input 
                                type="text" 
                                id="registerUsername" 
                                class="form-control" 
                                placeholder="Escolha um nome de usuÃ¡rio"
                                required
                            >
                            <div class="error-message" id="registerUsernameError">UsuÃ¡rio deve ter pelo menos 3 caracteres</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="registerPassword">Senha</label>
                            <input 
                                type="password" 
                                id="registerPassword" 
                                class="form-control" 
                                placeholder="Crie uma senha segura"
                                required
                            >
                            <i class="input-icon fas fa-eye" onclick="togglePassword('registerPassword', this)"></i>
                            <div class="error-message" id="registerPasswordError">Senha deve ter pelo menos 6 caracteres</div>
                        </div>

                        <div class="form-group">
                            <label class="form-label" for="confirmPassword">Confirmar senha</label>
                            <input 
                                type="password" 
                                id="confirmPassword" 
                                class="form-control" 
                                placeholder="Digite a senha novamente"
                                required
                            >
                            <i class="input-icon fas fa-eye" onclick="togglePassword('confirmPassword', this)"></i>
                            <div class="error-message" id="confirmPasswordError">As senhas nÃ£o coincidem</div>
                        </div>

                        <div class="checkbox-group">
                            <label class="custom-checkbox">
                                <input type="checkbox" id="acceptTerms" required>
                                <span class="checkmark"></span>
                            </label>
                            <label class="checkbox-label" for="acceptTerms">
                                Aceito os termos de uso e polÃ­tica de privacidade
                            </label>
                        </div>

                        <button type="submit" class="btn-primary" id="registerBtn">
                            Criar Conta
                        </button>

                        <div class="form-toggle">
                            <p class="toggle-text">JÃ¡ tem uma conta?</p>
                            <a class="toggle-link" onclick="switchToLogin()">Fazer login</a>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MAIN WAREHOUSE MANAGEMENT SYSTEM ===== -->
    <div id="mainSystem" class="main-system">
        <!-- Sidebar Navigation -->
        <div class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <div class="sidebar-brand">
                    <i class="fas fa-warehouse"></i>
                    <span>Almoxarifado</span>
                </div>
            </div>
            
            <nav class="sidebar-nav">
                <div class="nav-item">
                    <a href="#" class="nav-link active" onclick="showPage('dashboard')">
                        <i class="nav-icon fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('products')">
                        <i class="nav-icon fas fa-cube"></i>
                        <span>Produtos</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('movements')">
                        <i class="nav-icon fas fa-exchange-alt"></i>
                        <span>MovimentaÃ§Ãµes</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('scanner')">
                        <i class="nav-icon fas fa-qrcode"></i>
                        <span>Scanner QR</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="showPage('reports')">
                        <i class="nav-icon fas fa-chart-bar"></i>
                        <span>RelatÃ³rios</span>
                    </a>
                </div>
                <div class="nav-item">
                    <a href="#" class="nav-link" onclick="logout()">
                        <i class="nav-icon fas fa-sign-out-alt"></i>
                        <span>Sair</span>
                    </a>
                </div>
            </nav>
        </div>

        <!-- Main Content Area -->
        <div class="main-content" id="mainContent">
            <!-- Header -->
            <header class="main-header">
                <div class="header-left">
                    <button class="menu-toggle" onclick="toggleSidebar()">
                        <i class="fas fa-bars"></i>
                    </button>
                    <h1 class="page-title" id="pageTitle">Dashboard</h1>
                </div>
                
                <div class="header-right">
                    <div class="user-menu">
                        <div class="user-avatar" id="userAvatar">
                            AD
                        </div>
                    </div>
                </div>
            </header>

            <!-- Content Area -->
            <div class="content-area" id="contentArea">
                <!-- Dashboard Page -->
                <div id="dashboardPage" class="page-content active">
                    <!-- Stats Grid -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #2e7d32, #4caf50);">
                                    <i class="fas fa-boxes"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="dashTotalProducts">0</div>
                            <div class="stat-label">Total de Produtos</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #f57c00, #ff9800);">
                                    <i class="fas fa-exclamation-triangle"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="dashLowStock">0</div>
                            <div class="stat-label">Estoque Baixo</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #1976d2, #2196f3);">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="dashTodayMovements">0</div>
                            <div class="stat-label">MovimentaÃ§Ãµes Hoje</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0);">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="dashTotalValue">R$ 0,00</div>
                            <div class="stat-label">Valor Total Estoque</div>
                        </div>
                    </div>

                    <!-- Recent Activities -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-clock"></i>
                                Atividades Recentes
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="recentActivitiesContainer">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-clock"></i>
                                    </div>
                                    <div class="empty-state-title">Nenhuma atividade recente</div>
                                    <div class="empty-state-text">As movimentaÃ§Ãµes aparecerÃ£o aqui conforme forem registradas</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Page -->
                <div id="productsPage" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1">GestÃ£o de Produtos</h2>
                            <p class="text-muted mb-0">Cadastre e gerencie produtos do almoxarifado</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-outline-primary" onclick="generateBatchQRCodes()">
                                <i class="fas fa-qrcode"></i>
                                QR Codes em Lote
                            </button>
                            <button class="btn btn-success" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i>
                                Novo Produto
                            </button>
                        </div>
                    </div>

                    <!-- Search and Filters -->
                    <div class="card mb-4">
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <input type="text" class="form-control" placeholder="Buscar produtos..." id="productSearch" onkeyup="filterProducts()">
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="categoryFilter" onchange="filterProducts()">
                                        <option value="">Todas as categorias</option>
                                        <option value="Papelaria">Papelaria</option>
                                        <option value="Limpeza">Limpeza</option>
                                        <option value="InformÃ¡tica">InformÃ¡tica</option>
                                        <option value="EscritÃ³rio">EscritÃ³rio</option>
                                    </select>
                                </div>
                                <div class="col-md-3">
                                    <select class="form-control" id="stockFilter" onchange="filterProducts()">
                                        <option value="">Todos os estoques</option>
                                        <option value="normal">Estoque Normal</option>
                                        <option value="low">Estoque Baixo</option>
                                        <option value="out">Sem Estoque</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Products Grid -->
                    <div class="products-grid" id="productsGrid">
                        <div class="empty-state">
                            <div class="empty-state-icon">
                                <i class="fas fa-cube"></i>
                            </div>
                            <div class="empty-state-title">Nenhum produto cadastrado</div>
                            <div class="empty-state-text">Comece adicionando produtos ao seu almoxarifado</div>
                            <button class="btn btn-success mt-3" onclick="showAddProductModal()">
                                <i class="fas fa-plus"></i>
                                Adicionar Primeiro Produto
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Movements Page -->
                <div id="movementsPage" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1">MovimentaÃ§Ãµes</h2>
                            <p class="text-muted mb-0">Controle de entradas e saÃ­das do estoque</p>
                        </div>
                        <button class="btn btn-success" onclick="showMovementModal()">
                            <i class="fas fa-plus"></i>
                            Nova MovimentaÃ§Ã£o
                        </button>
                    </div>

                    <!-- Movement History -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-history"></i>
                                HistÃ³rico de MovimentaÃ§Ãµes
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="movementsHistoryContainer">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-exchange-alt"></i>
                                    </div>
                                    <div class="empty-state-title">Nenhuma movimentaÃ§Ã£o registrada</div>
                                    <div class="empty-state-text">As movimentaÃ§Ãµes de estoque aparecerÃ£o aqui</div>
                                    <button class="btn btn-success mt-3" onclick="showMovementModal()">
                                        <i class="fas fa-plus"></i>
                                        Registrar Primeira MovimentaÃ§Ã£o
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Scanner Page -->
                <div id="scannerPage" class="page-content">
                    <div class="row">
                        <div class="col-lg-8">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-qrcode"></i>
                                        Scanner QR Code
                                    </h3>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" id="startScannerBtn" onclick="startScanner()">
                                            <i class="fas fa-camera"></i>
                                            Iniciar Scanner
                                        </button>
                                        <button class="btn btn-secondary" id="stopScannerBtn" onclick="stopScanner()" style="display: none;">
                                            <i class="fas fa-stop"></i>
                                            Parar Scanner
                                        </button>
                                    </div>
                                </div>
                                <div class="card-body">
                                    <div id="scannerContainer" class="scanner-container">
                                        <div id="scannerPlaceholder" class="scanner-placeholder">
                                            <div class="scanner-placeholder-content">
                                                <div class="scanner-placeholder-icon">
                                                    <i class="fas fa-qrcode"></i>
                                                </div>
                                                <h4>Scanner QR Code</h4>
                                                <p>Clique em "Iniciar Scanner" para ativar a cÃ¢mera e escanear cÃ³digos QR dos produtos</p>
                                                <div class="scanner-features">
                                                    <div class="scanner-feature">
                                                        <i class="fas fa-camera"></i>
                                                        <span>CÃ¢mera nativa do dispositivo</span>
                                                    </div>
                                                    <div class="scanner-feature">
                                                        <i class="fas fa-crosshairs"></i>
                                                        <span>DetecÃ§Ã£o automÃ¡tica</span>
                                                    </div>
                                                    <div class="scanner-feature">
                                                        <i class="fas fa-mobile-alt"></i>
                                                        <span>CompatÃ­vel com mobile</span>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                        <div id="scannerVideo" class="scanner-video-container" style="display: none;">
                                            <video id="qrVideo" class="scanner-video" autoplay muted playsinline></video>
                                            <div class="scanner-overlay">
                                                <div class="scanner-target">
                                                    <div class="scanner-corners">
                                                        <div class="corner top-left"></div>
                                                        <div class="corner top-right"></div>
                                                        <div class="corner bottom-left"></div>
                                                        <div class="corner bottom-right"></div>
                                                    </div>
                                                    <div class="scanner-line"></div>
                                                </div>
                                                <div class="scanner-instructions">
                                                    <p>Posicione o QR Code dentro da Ã¡rea de escaneamento</p>
                                                </div>
                                            </div>
                                            <canvas id="qrCanvas" style="display: none;"></canvas>
                                        </div>
                                        <div id="scannerError" class="scanner-error" style="display: none;">
                                            <div class="scanner-error-content">
                                                <i class="fas fa-exclamation-triangle"></i>
                                                <h4>Erro no Scanner</h4>
                                                <p id="scannerErrorMessage">NÃ£o foi possÃ­vel acessar a cÃ¢mera</p>
                                                <button class="btn btn-outline-primary" onclick="startScanner()">
                                                    <i class="fas fa-redo"></i>
                                                    Tentar Novamente
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="col-lg-4">
                            <div class="card">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-history"></i>
                                        Ãšltimos Escaneamentos
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div id="scanHistoryContainer">
                                        <div class="empty-state-small">
                                            <div class="empty-state-icon-small">
                                                <i class="fas fa-search"></i>
                                            </div>
                                            <div class="empty-state-title-small">Nenhum escaneamento</div>
                                            <div class="empty-state-text-small">Os produtos escaneados aparecerÃ£o aqui</div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="card mt-3" id="scannedProductCard" style="display: none;">
                                <div class="card-header">
                                    <h3 class="card-title">
                                        <i class="fas fa-cube"></i>
                                        Produto Escaneado
                                    </h3>
                                </div>
                                <div class="card-body">
                                    <div id="scannedProductInfo">
                                        <!-- Product info will be populated here -->
                                    </div>
                                    <div class="mt-3">
                                        <button class="btn btn-success btn-sm w-100 mb-2" onclick="quickMovementFromScan('entrada')">
                                            <i class="fas fa-plus"></i>
                                            Entrada RÃ¡pida
                                        </button>
                                        <button class="btn btn-warning btn-sm w-100 mb-2" onclick="quickMovementFromScan('saida')">
                                            <i class="fas fa-minus"></i>
                                            SaÃ­da RÃ¡pida
                                        </button>
                                        <button class="btn btn-outline-primary btn-sm w-100" onclick="showMovementModalFromScan()">
                                            <i class="fas fa-exchange-alt"></i>
                                            MovimentaÃ§Ã£o Completa
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reportsPage" class="page-content">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <div>
                            <h2 class="mb-1">RelatÃ³rios</h2>
                            <p class="text-muted mb-0">AnÃ¡lises e relatÃ³rios do almoxarifado</p>
                        </div>
                        <div class="d-flex gap-2">
                            <button class="btn btn-success" onclick="generatePDFReport()">
                                <i class="fas fa-file-pdf"></i>
                                Gerar PDF
                            </button>
                            <button class="btn btn-outline-primary" onclick="previewReport()">
                                <i class="fas fa-eye"></i>
                                Visualizar
                            </button>
                        </div>
                    </div>

                    <!-- Report Filters -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-filter"></i>
                                Filtros de RelatÃ³rio
                            </h3>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Tipo de RelatÃ³rio</label>
                                        <select class="form-control" id="reportType" onchange="updateReportFilters()">
                                            <option value="inventory">InventÃ¡rio Atual</option>
                                            <option value="movements">MovimentaÃ§Ãµes</option>
                                            <option value="lowStock">Estoque Baixo</option>
                                            <option value="valueAnalysis">AnÃ¡lise de Valor</option>
                                            <option value="categoryAnalysis">AnÃ¡lise por Categoria</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Data Inicial</label>
                                        <input type="date" class="form-control" id="reportStartDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Data Final</label>
                                        <input type="date" class="form-control" id="reportEndDate">
                                    </div>
                                </div>
                                <div class="col-md-3">
                                    <div class="form-group">
                                        <label class="form-label">Categoria</label>
                                        <select class="form-control" id="reportCategory">
                                            <option value="">Todas as categorias</option>
                                            <option value="Papelaria">Papelaria</option>
                                            <option value="Limpeza">Limpeza</option>
                                            <option value="InformÃ¡tica">InformÃ¡tica</option>
                                            <option value="EscritÃ³rio">EscritÃ³rio</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <div class="row">
                                <div class="col-md-12">
                                    <button class="btn btn-outline-primary" onclick="applyReportFilters()">
                                        <i class="fas fa-search"></i>
                                        Aplicar Filtros
                                    </button>
                                    <button class="btn btn-outline-secondary ml-2" onclick="clearReportFilters()">
                                        <i class="fas fa-times"></i>
                                        Limpar Filtros
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Report Summary Cards -->
                    <div class="stats-grid mb-4" id="reportSummary">
                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #2e7d32, #4caf50);">
                                    <i class="fas fa-boxes"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="reportTotalProducts">0</div>
                            <div class="stat-label">Produtos Analisados</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #1976d2, #2196f3);">
                                    <i class="fas fa-warehouse"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="reportTotalStock">0</div>
                            <div class="stat-label">Total em Estoque</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #7b1fa2, #9c27b0);">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="reportTotalValue">R$ 0,00</div>
                            <div class="stat-label">Valor Total</div>
                        </div>

                        <div class="stat-card">
                            <div class="stat-header">
                                <div class="stat-icon" style="background: linear-gradient(135deg, #f57c00, #ff9800);">
                                    <i class="fas fa-exchange-alt"></i>
                                </div>
                            </div>
                            <div class="stat-value" id="reportMovements">0</div>
                            <div class="stat-label">MovimentaÃ§Ãµes</div>
                        </div>
                    </div>

                    <!-- Report Content -->
                    <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">
                                <i class="fas fa-table"></i>
                                <span id="reportTitle">RelatÃ³rio de InventÃ¡rio</span>
                            </h3>
                        </div>
                        <div class="card-body">
                            <div id="reportContent">
                                <div class="empty-state">
                                    <div class="empty-state-icon">
                                        <i class="fas fa-chart-bar"></i>
                                    </div>
                                    <div class="empty-state-title">Selecione os filtros</div>
                                    <div class="empty-state-text">Configure os filtros acima e clique em "Aplicar Filtros" para gerar o relatÃ³rio</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- ===== MODALS ===== -->
    
    <!-- Add Product Modal -->
    <div class="modal" id="addProductModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-plus"></i>
                        Novo Produto
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('addProductModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="addProductForm" onsubmit="addProduct(event)">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">CÃ³digo do Produto</label>
                                    <input type="text" class="form-control" id="productCode" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Categoria</label>
                                    <select class="form-control" id="productCategory" required>
                                        <option value="">Selecione...</option>
                                        <option value="Papelaria">Papelaria</option>
                                        <option value="Limpeza">Limpeza</option>
                                        <option value="InformÃ¡tica">InformÃ¡tica</option>
                                        <option value="EscritÃ³rio">EscritÃ³rio</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Nome do Produto</label>
                            <input type="text" class="form-control" id="productName" required>
                        </div>
                        <div class="form-group">
                            <label class="form-label">DescriÃ§Ã£o</label>
                            <textarea class="form-control" id="productDescription" rows="3"></textarea>
                        </div>
                        <div class="row">
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">PreÃ§o UnitÃ¡rio</label>
                                    <input type="number" step="0.01" class="form-control" id="productPrice" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Estoque Inicial</label>
                                    <input type="number" class="form-control" id="productStock" required>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="form-group">
                                    <label class="form-label">Estoque MÃ­nimo</label>
                                    <input type="number" class="form-control" id="productMinStock" required>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('addProductModal')">Cancelar</button>
                    <button type="submit" form="addProductForm" class="btn btn-success">Salvar Produto</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Movement Modal -->
    <div class="modal" id="movementModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exchange-alt"></i>
                        Nova MovimentaÃ§Ã£o
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('movementModal')"></button>
                </div>
                <div class="modal-body">
                    <form id="movementForm" onsubmit="addMovement(event)">
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Produto</label>
                                    <select class="form-control" id="movementProduct" required>
                                        <option value="">Selecione o produto...</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Tipo de MovimentaÃ§Ã£o</label>
                                    <select class="form-control" id="movementType" required>
                                        <option value="">Selecione...</option>
                                        <option value="entrada">Entrada</option>
                                        <option value="saida">SaÃ­da</option>
                                        <option value="ajuste">Ajuste</option>
                                    </select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Quantidade</label>
                                    <input type="number" class="form-control" id="movementQuantity" required>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-group">
                                    <label class="form-label">Data/Hora</label>
                                    <input type="datetime-local" class="form-control" id="movementDate" required>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">ObservaÃ§Ãµes</label>
                            <textarea class="form-control" id="movementNotes" rows="3" placeholder="Motivo da movimentaÃ§Ã£o..."></textarea>
                        </div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('movementModal')">Cancelar</button>
                    <button type="submit" form="movementForm" class="btn btn-success">Registrar MovimentaÃ§Ã£o</button>
                </div>
            </div>
        </div>
    </div>

    <!-- QR Code Modal -->
    <div class="modal" id="qrModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-qrcode"></i>
                        QR Code do Produto
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('qrModal')"></button>
                </div>
                <div class="modal-body text-center">
                    <div id="qrCodeContainer" style="margin: 20px 0;">
                        <!-- QR Code will be generated here -->
                        <div style="width: 200px; height: 200px; background: #f8f9fa; border: 2px dashed #dee2e6; display: flex; align-items: center; justify-content: center; margin: 0 auto; border-radius: 8px;">
                            <div style="text-align: center; color: #6c757d;">
                                <i class="fas fa-qrcode" style="font-size: 48px; margin-bottom: 10px;"></i>
                                <div>QR Code serÃ¡ gerado aqui</div>
                            </div>
                        </div>
                    </div>
                    <div id="qrProductInfo" style="margin-top: 20px;">
                        <h6>InformaÃ§Ãµes do Produto</h6>
                        <p class="text-muted mb-0" id="qrProductDetails">Selecione um produto para gerar o QR Code</p>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('qrModal')">Fechar</button>
                    <button type="button" class="btn btn-outline-primary" onclick="downloadQRCode()">
                        <i class="fas fa-download"></i>
                        Baixar QR Code
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Batch QR Code Modal -->
    <div class="modal" id="batchQrModal">
        <div class="modal-dialog" style="max-width: 90vw;">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-qrcode"></i>
                        QR Codes em Lote
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('batchQrModal')"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <p class="text-muted">QR Codes gerados para todos os produtos cadastrados</p>
                    </div>
                    <div class="batch-qr-container" id="batchQrContainer">
                        <!-- Batch QR codes will be generated here -->
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('batchQrModal')">Fechar</button>
                    <button type="button" class="btn btn-outline-primary" onclick="downloadBatchQRCodes()">
                        <i class="fas fa-download"></i>
                        Baixar Todos
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Product Not Found Modal -->
    <div class="modal" id="productNotFoundModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle" style="color: var(--warning-color);"></i>
                        Produto NÃ£o Encontrado
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('productNotFoundModal')"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div style="font-size: 64px; color: var(--warning-color); margin-bottom: 16px;">
                            <i class="fas fa-search"></i>
                        </div>
                        <h4 style="color: var(--text-primary); margin-bottom: 12px;">Produto nÃ£o cadastrado</h4>
                        <p class="text-muted" id="productNotFoundMessage">
                            O produto selecionado nÃ£o foi encontrado no sistema.
                        </p>
                    </div>
                    <div class="alert" style="background: rgba(245, 124, 0, 0.1); border: 1px solid rgba(245, 124, 0, 0.2); border-radius: 8px; padding: 16px;">
                        <div style="display: flex; align-items: center; gap: 12px;">
                            <i class="fas fa-info-circle" style="color: var(--warning-color);"></i>
                            <div>
                                <strong>O que fazer?</strong><br>
                                <small>Cadastre o produto primeiro antes de registrar movimentaÃ§Ãµes.</small>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('productNotFoundModal')">Fechar</button>
                    <button type="button" class="btn btn-success" onclick="closeModal('productNotFoundModal'); showAddProductModal();">
                        <i class="fas fa-plus"></i>
                        Cadastrar Produto
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Insufficient Stock Modal -->
    <div class="modal" id="insufficientStockModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-exclamation-triangle" style="color: var(--error-color);"></i>
                        Estoque Insuficiente
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('insufficientStockModal')"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div style="font-size: 64px; color: var(--error-color); margin-bottom: 16px;">
                            <i class="fas fa-box-open"></i>
                        </div>
                        <h4 style="color: var(--text-primary); margin-bottom: 12px;">Quantidade indisponÃ­vel</h4>
                        <p class="text-muted" id="insufficientStockMessage">
                            NÃ£o hÃ¡ estoque suficiente para realizar esta operaÃ§Ã£o.
                        </p>
                    </div>
                    <div class="row">
                        <div class="col-6">
                            <div class="text-center p-3" style="background: rgba(211, 47, 47, 0.1); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--error-color);" id="requestedQuantity">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">Solicitado</div>
                            </div>
                        </div>
                        <div class="col-6">
                            <div class="text-center p-3" style="background: rgba(46, 125, 50, 0.1); border-radius: 8px;">
                                <div style="font-size: 24px; font-weight: 700; color: var(--success-color);" id="availableQuantity">0</div>
                                <div style="font-size: 12px; color: var(--text-secondary);">DisponÃ­vel</div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('insufficientStockModal')">Fechar</button>
                    <button type="button" class="btn btn-outline-primary" onclick="closeModal('insufficientStockModal'); adjustMovementQuantity();">
                        <i class="fas fa-edit"></i>
                        Ajustar Quantidade
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Movement Success Modal -->
    <div class="modal" id="movementSuccessModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-check-circle" style="color: var(--success-color);"></i>
                        MovimentaÃ§Ã£o Realizada
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('movementSuccessModal')"></button>
                </div>
                <div class="modal-body">
                    <div class="text-center mb-3">
                        <div style="font-size: 64px; color: var(--success-color); margin-bottom: 16px;">
                            <i class="fas fa-check-circle"></i>
                        </div>
                        <h4 style="color: var(--text-primary); margin-bottom: 12px;" id="movementSuccessTitle">OperaÃ§Ã£o concluÃ­da</h4>
                        <p class="text-muted" id="movementSuccessMessage">
                            A movimentaÃ§Ã£o foi registrada com sucesso.
                        </p>
                    </div>
                    <div class="card" style="background: rgba(46, 125, 50, 0.05); border: 1px solid rgba(46, 125, 50, 0.2);">
                        <div class="card-body">
                            <div class="row text-center">
                                <div class="col-4">
                                    <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);" id="movementProductName">-</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Produto</div>
                                </div>
                                <div class="col-4">
                                    <div style="font-size: 18px; font-weight: 700; color: var(--success-color);" id="movementQuantityChange">+0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">AlteraÃ§Ã£o</div>
                                </div>
                                <div class="col-4">
                                    <div style="font-size: 18px; font-weight: 700; color: var(--text-primary);" id="movementNewStock">0</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">Novo Estoque</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('movementSuccessModal')">Fechar</button>
                    <button type="button" class="btn btn-outline-primary" onclick="closeModal('movementSuccessModal'); showMovementModal();">
                        <i class="fas fa-plus"></i>
                        Nova MovimentaÃ§Ã£o
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Quick Movement Modal -->
    <div class="modal" id="quickMovementModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-bolt"></i>
                        <span id="quickMovementTitle">MovimentaÃ§Ã£o RÃ¡pida</span>
                    </h5>
                    <button type="button" class="btn-close" onclick="closeModal('quickMovementModal')"></button>
                </div>
                <div class="modal-body">
                    <div id="quickMovementProductInfo" class="scanned-product-header">
                        <!-- Product info will be populated here -->
                    </div>
                    <div class="form-group">
                        <label class="form-label">Quantidade</label>
                        <div class="quick-movement-input">
                            <button type="button" class="quantity-btn" onclick="adjustQuickQuantity(-1)">-</button>
                            <input type="number" id="quickMovementQuantity" class="form-control" value="1" min="1">
                            <button type="button" class="quantity-btn" onclick="adjustQuickQuantity(1)">+</button>
                        </div>
                        <div class="d-flex gap-2 mt-2">
                            <button type="button" class="quantity-btn" onclick="setQuickQuantity(1)">1</button>
                            <button type="button" class="quantity-btn" onclick="setQuickQuantity(5)">5</button>
                            <button type="button" class="quantity-btn" onclick="setQuickQuantity(10)">10</button>
                            <button type="button" class="quantity-btn" onclick="setQuickQuantity(50)">50</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label class="form-label">ObservaÃ§Ãµes (opcional)</label>
                        <textarea class="form-control" id="quickMovementNotes" rows="2" placeholder="Motivo da movimentaÃ§Ã£o..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" onclick="closeModal('quickMovementModal')">Cancelar</button>
                    <button type="button" class="btn btn-success" id="confirmQuickMovementBtn" onclick="confirmQuickMovement()">
                        <i class="fas fa-check"></i>
                        Confirmar
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PDF Preview Modal -->
    <div class="modal" id="pdfPreviewModal">
        <div class="modal-dialog" style="max-width: 95vw; max-height: 95vh;">
            <div class="modal-content" style="height: 95vh;">
                <div class="modal-header">
                    <h5 class="modal-title">
                        <i class="fas fa-file-pdf"></i>
                        VisualizaÃ§Ã£o do RelatÃ³rio
                    </h5>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success btn-sm" onclick="downloadCurrentPDF()">
                            <i class="fas fa-download"></i>
                            Baixar PDF
                        </button>
                        <button type="button" class="btn-close" onclick="closeModal('pdfPreviewModal')"></button>
                    </div>
                </div>
                <div class="modal-body" style="padding: 0; overflow: auto; flex: 1;">
                    <div id="pdfPreviewContainer" style="background: #f5f5f5; min-height: 100%; padding: 20px;">
                        <!-- PDF preview content will be inserted here -->
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Notification Container -->
    <div class="notification-container" id="notificationContainer"></div>

    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="loading-content">
            <div class="loading-spinner"></div>
            <div class="loading-text" id="loadingText">Carregando...</div>
            <div class="loading-subtext" id="loadingSubtext">Aguarde um momento</div>
        </div>
    </div>

    <script>
        // ===== FIREBASE CONFIGURATION =====
        const firebaseConfig = {
            apiKey: "AIzaSyBOqTvYZsNqVAs3FgKY6YvCuSOUQ4tZ7EE",
            authDomain: "almoxarifado-92b48.firebaseapp.com",
            databaseURL: "https://almoxarifado-92b48-default-rtdb.firebaseio.com/",
            projectId: "almoxarifado-92b48",
            storageBucket: "almoxarifado-92b48.firebasestorage.app",
            messagingSenderId: "679630067662",
            appId: "1:679630067662:web:ea49487dc75ff21c627d9f",
            measurementId: "G-W8KZKH2FTM"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();

        // ===== UTILITY FUNCTIONS =====
        // Simple password hashing using built-in crypto
        async function hashPassword(password) {
            const encoder = new TextEncoder();
            const data = encoder.encode(password + 'almoxarifado_salt_2024');
            const hashBuffer = await crypto.subtle.digest('SHA-256', data);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // Generate unique user ID
        function generateUserId() {
            return 'user_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
        }

        // ===== GLOBAL VARIABLES =====
        let currentUser = null;
        let products = [];
        let movements = [];
        let reports = [];
        
        // QR Scanner variables
        let qrScanner = null;
        let scannerStream = null;
        let scannerActive = false;
        let scanHistory = [];
        let lastScannedProduct = null;
        let scanInterval = null;

        // PDF Report variables
        let currentReportData = null;
        let currentReportType = null;
        let currentReportFilters = null;

        // ===== NOTIFICATION SYSTEM =====
        function showNotification(type, title, message, duration = 5000) {
            const container = document.getElementById('notificationContainer');
            const notification = document.createElement('div');
            notification.className = `notification ${type}`;
            
            const iconMap = {
                success: 'fas fa-check',
                error: 'fas fa-times',
                warning: 'fas fa-exclamation-triangle',
                info: 'fas fa-info'
            };
            
            notification.innerHTML = `
                <div class="notification-icon">
                    <i class="${iconMap[type]}"></i>
                </div>
                <div class="notification-content">
                    <div class="notification-title">${title}</div>
                    <div class="notification-message">${message}</div>
                </div>
                <button class="notification-close" onclick="closeNotification(this)">
                    <i class="fas fa-times"></i>
                </button>
                <div class="notification-progress"></div>
            `;
            
            container.appendChild(notification);
            
            // Show notification
            setTimeout(() => notification.classList.add('show'), 100);
            
            // Auto remove
            setTimeout(() => {
                closeNotification(notification.querySelector('.notification-close'));
            }, duration);
        }

        function closeNotification(button) {
            const notification = button.closest('.notification');
            notification.classList.remove('show');
            setTimeout(() => notification.remove(), 400);
        }

        // ===== LOADING SYSTEM =====
        function showLoading(text = 'Carregando...', subtext = 'Aguarde um momento') {
            const overlay = document.getElementById('loadingOverlay');
            document.getElementById('loadingText').textContent = text;
            document.getElementById('loadingSubtext').textContent = subtext;
            overlay.classList.add('show');
        }

        function hideLoading() {
            document.getElementById('loadingOverlay').classList.remove('show');
        }

        // ===== AUTHENTICATION FUNCTIONS =====
        function togglePassword(inputId, icon) {
            const input = document.getElementById(inputId);
            const isPassword = input.type === 'password';
            
            input.type = isPassword ? 'text' : 'password';
            icon.className = isPassword ? 'input-icon fas fa-eye-slash' : 'input-icon fas fa-eye';
        }

        function switchToRegister() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            loginForm.classList.add('slide-out-left');
            setTimeout(() => {
                loginForm.classList.add('hidden');
                registerForm.classList.remove('hidden');
                registerForm.classList.add('slide-in-right');
            }, 250);
        }

        function switchToLogin() {
            const loginForm = document.getElementById('loginForm');
            const registerForm = document.getElementById('registerForm');
            
            registerForm.classList.add('slide-out-right');
            setTimeout(() => {
                registerForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
                loginForm.classList.add('slide-in-left');
            }, 250);
        }

        async function handleLogin(event) {
            event.preventDefault();
            
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;
            const loginBtn = document.getElementById('loginBtn');
            
            // Simple validation
            if (!username || username.length < 3) {
                showFieldError('loginUsername', 'loginUsernameError');
                return;
            }
            
            if (password.length < 6) {
                showFieldError('loginPassword', 'loginPasswordError');
                return;
            }
            
            // Show loading state
            loginBtn.classList.add('btn-loading');
            loginBtn.disabled = true;
            showLoading('Fazendo login...', 'Verificando credenciais');
            
            try {
                // Hash the password for comparison
                const hashedPassword = await hashPassword(password);
                
                // Search for user by username
                const usersSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
                const usersData = usersSnapshot.val();
                
                if (!usersData) {
                    throw new Error('user-not-found');
                }
                
                // Get the first (and should be only) user
                const userId = Object.keys(usersData)[0];
                const userData = usersData[userId];
                
                // Check password
                if (userData.password !== hashedPassword) {
                    throw new Error('wrong-password');
                }
                
                // Check if user is active
                if (userData.status === 'inactive') {
                    throw new Error('user-inactive');
                }
                
                // Update last login
                await database.ref(`users/${userId}/lastLogin`).set(firebase.database.ServerValue.TIMESTAMP);
                
                currentUser = {
                    id: userId,
                    username: userData.username,
                    name: userData.name,
                    email: userData.email || `${userData.username}@almoxarifado.com`,
                    role: userData.role || 'user',
                    initials: userData.name.substring(0, 2).toUpperCase(),
                    createdAt: userData.createdAt,
                    lastLogin: Date.now()
                };
                
                // Save session to localStorage
                localStorage.setItem('almoxarifado_session', JSON.stringify({
                    userId: userId,
                    username: userData.username,
                    loginTime: Date.now()
                }));
                
                hideLoading();
                showNotification('success', 'Login realizado!', `Bem-vindo, ${userData.name}!`);
                
                setTimeout(() => {
                    document.getElementById('authSystem').style.display = 'none';
                    document.getElementById('mainSystem').classList.add('active');
                    updateUserAvatar();
                    loadData();
                }, 1000);
                
            } catch (error) {
                hideLoading();
                let errorMessage = 'Erro ao fazer login. Verifique suas credenciais.';
                
                if (error.message === 'user-not-found') {
                    errorMessage = 'UsuÃ¡rio nÃ£o encontrado. Verifique o nome de usuÃ¡rio.';
                } else if (error.message === 'wrong-password') {
                    errorMessage = 'Senha incorreta. Tente novamente.';
                } else if (error.message === 'user-inactive') {
                    errorMessage = 'Conta desativada. Entre em contato com o administrador.';
                }
                
                showNotification('error', 'Erro no login', errorMessage);
                console.error('Login error:', error);
            }
            
            loginBtn.classList.remove('btn-loading');
            loginBtn.disabled = false;
        }

        async function handleRegister(event) {
            event.preventDefault();
            
            const name = document.getElementById('registerName').value.trim();
            const username = document.getElementById('registerUsername').value.trim().toLowerCase();
            const password = document.getElementById('registerPassword').value;
            const confirmPassword = document.getElementById('confirmPassword').value;
            const acceptTerms = document.getElementById('acceptTerms').checked;
            const registerBtn = document.getElementById('registerBtn');
            
            // Validation
            let hasError = false;
            
            if (name.length < 2) {
                showFieldError('registerName', 'registerNameError');
                hasError = true;
            }
            
            if (username.length < 3) {
                showFieldError('registerUsername', 'registerUsernameError');
                hasError = true;
            }
            
            // Check for valid username format (alphanumeric and underscore only)
            if (!/^[a-zA-Z0-9_]+$/.test(username)) {
                showFieldError('registerUsername', 'registerUsernameError');
                showNotification('warning', 'UsuÃ¡rio invÃ¡lido', 'Use apenas letras, nÃºmeros e underscore (_).');
                hasError = true;
            }
            
            if (password.length < 6) {
                showFieldError('registerPassword', 'registerPasswordError');
                hasError = true;
            }
            
            if (password !== confirmPassword) {
                showFieldError('confirmPassword', 'confirmPasswordError');
                hasError = true;
            }
            
            if (!acceptTerms) {
                showNotification('warning', 'Termos obrigatÃ³rios', 'VocÃª deve aceitar os termos de uso para continuar.');
                return;
            }
            
            if (hasError) return;
            
            // Show loading state
            registerBtn.classList.add('btn-loading');
            registerBtn.disabled = true;
            showLoading('Criando conta...', 'Verificando disponibilidade');
            
            try {
                // Check if username already exists
                const existingUserSnapshot = await database.ref('users').orderByChild('username').equalTo(username).once('value');
                if (existingUserSnapshot.exists()) {
                    throw new Error('username-already-exists');
                }
                
                // Hash the password
                const hashedPassword = await hashPassword(password);
                
                // Generate unique user ID
                const userId = generateUserId();
                
                // Create user data
                const userData = {
                    name: name,
                    username: username,
                    password: hashedPassword,
                    email: `${username}@almoxarifado.com`,
                    role: 'user',
                    status: 'active',
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    lastLogin: null,
                    permissions: {
                        canViewProducts: true,
                        canAddProducts: true,
                        canEditProducts: true,
                        canDeleteProducts: false,
                        canViewMovements: true,
                        canAddMovements: true,
                        canViewReports: true,
                        canManageUsers: false
                    }
                };
                
                // Save user to database
                await database.ref(`users/${userId}`).set(userData);
                
                hideLoading();
                showNotification('success', 'Conta criada!', 'Sua conta foi criada com sucesso. FaÃ§a login para continuar.');
                
                setTimeout(() => {
                    switchToLogin();
                    document.getElementById('loginUsername').value = username;
                }, 2000);
                
            } catch (error) {
                hideLoading();
                console.error('Registration error:', error);
                let errorMessage = 'Erro ao criar conta. Tente novamente.';
                
                if (error.message === 'username-already-exists') {
                    errorMessage = 'Este nome de usuÃ¡rio jÃ¡ estÃ¡ em uso. Escolha outro.';
                } else if (error.code === 'PERMISSION_DENIED') {
                    errorMessage = 'PermissÃ£o negada. Verifique as configuraÃ§Ãµes do banco de dados.';
                } else if (error.code === 'NETWORK_ERROR') {
                    errorMessage = 'Erro de conexÃ£o. Verifique sua internet e tente novamente.';
                } else {
                    errorMessage = `Erro: ${error.message || 'Falha na criaÃ§Ã£o da conta'}`;
                }
                
                showNotification('error', 'Erro no cadastro', errorMessage);
            }
            
            registerBtn.classList.remove('btn-loading');
            registerBtn.disabled = false;
        }

        function showFieldError(fieldId, errorId) {
            const field = document.getElementById(fieldId);
            const error = document.getElementById(errorId);
            
            field.classList.add('error');
            error.classList.add('show');
            
            setTimeout(() => {
                field.classList.remove('error');
                error.classList.remove('show');
            }, 3000);
        }

        // ===== FIREBASE DATA FUNCTIONS =====
        let productsListener = null;
        let movementsListener = null;

        async function loadData() {
            showLoading('Carregando dados...', 'Sincronizando informaÃ§Ãµes');
            
            try {
                // Load initial products data
                const productsSnapshot = await database.ref('products').once('value');
                const productsData = productsSnapshot.val();
                
                if (productsData) {
                    products = Object.keys(productsData).map(key => ({
                        id: key,
                        ...productsData[key]
                    }));
                }
                
                // Load initial movements data
                const movementsSnapshot = await database.ref('movements').orderByChild('timestamp').limitToLast(100).once('value');
                const movementsData = movementsSnapshot.val();
                
                if (movementsData) {
                    movements = Object.keys(movementsData).map(key => ({
                        id: key,
                        ...movementsData[key]
                    })).reverse();
                }
                
                // Set up real-time listeners
                setupRealtimeListeners();
                
                hideLoading();
                updateDashboard();
                renderProducts();
                renderRecentActivities();
                renderMovementsHistory();
                
            } catch (error) {
                hideLoading();
                showNotification('error', 'Erro ao carregar dados', 'NÃ£o foi possÃ­vel sincronizar os dados. Tente novamente.');
            }
        }

        function setupRealtimeListeners() {
            // Remove existing listeners
            if (productsListener) {
                productsListener.off();
            }
            if (movementsListener) {
                movementsListener.off();
            }
            
            // Products listener - listen for changes in products
            productsListener = database.ref('products');
            productsListener.on('child_changed', (snapshot) => {
                const updatedProduct = { id: snapshot.key, ...snapshot.val() };
                const index = products.findIndex(p => p.id === updatedProduct.id);
                
                if (index !== -1) {
                    products[index] = updatedProduct;
                    
                    // Update UI in real-time
                    updateDashboard();
                    renderProducts();
                    updateMovementProductOptions();
                    
                    // Show notification for stock changes by other users
                    if (updatedProduct.updatedBy !== currentUser.id) {
                        showNotification('info', 'Estoque atualizado', 
                            `${updatedProduct.name}: ${updatedProduct.stock} unidades`);
                    }
                }
            });
            
            productsListener.on('child_added', (snapshot) => {
                const newProduct = { id: snapshot.key, ...snapshot.val() };
                
                // Check if product already exists locally
                const existingIndex = products.findIndex(p => p.id === newProduct.id);
                if (existingIndex === -1) {
                    products.push(newProduct);
                    
                    // Update UI
                    updateDashboard();
                    renderProducts();
                    updateMovementProductOptions();
                    
                    // Show notification for new products by other users
                    if (newProduct.createdBy !== currentUser.id) {
                        showNotification('info', 'Novo produto', 
                            `${newProduct.name} foi adicionado por ${newProduct.createdByName}`);
                    }
                }
            });
            
            productsListener.on('child_removed', (snapshot) => {
                const removedProductId = snapshot.key;
                const index = products.findIndex(p => p.id === removedProductId);
                
                if (index !== -1) {
                    const removedProduct = products[index];
                    products.splice(index, 1);
                    
                    // Update UI
                    updateDashboard();
                    renderProducts();
                    updateMovementProductOptions();
                    
                    showNotification('warning', 'Produto removido', 
                        `${removedProduct.name} foi removido do sistema`);
                }
            });
            
            // Movements listener - listen for new movements
            movementsListener = database.ref('movements').orderByChild('timestamp').limitToLast(1);
            movementsListener.on('child_added', (snapshot) => {
                const newMovement = { id: snapshot.key, ...snapshot.val() };
                
                // Check if movement already exists locally
                const existingIndex = movements.findIndex(m => m.id === newMovement.id);
                if (existingIndex === -1) {
                    movements.unshift(newMovement);
                    
                    // Keep only last 100 movements in memory
                    if (movements.length > 100) {
                        movements = movements.slice(0, 100);
                    }
                    
                    // Update UI
                    renderRecentActivities();
                    renderMovementsHistory();
                    
                    // Show notification for movements by other users
                    if (newMovement.userId !== currentUser.id) {
                        const product = products.find(p => p.code === newMovement.product);
                        const productName = product ? product.name : newMovement.product;
                        
                        let actionText = 'movimentaÃ§Ã£o';
                        if (newMovement.type === 'entrada') actionText = 'entrada';
                        else if (newMovement.type === 'saida') actionText = 'saÃ­da';
                        else if (newMovement.type === 'ajuste') actionText = 'ajuste';
                        
                        showNotification('info', 'Nova movimentaÃ§Ã£o', 
                            `${newMovement.userName} registrou ${actionText} em ${productName}`);
                    }
                }
            });
        }

        function removeRealtimeListeners() {
            if (productsListener) {
                productsListener.off();
                productsListener = null;
            }
            if (movementsListener) {
                movementsListener.off();
                movementsListener = null;
            }
        }



        async function saveProduct(productData) {
            try {
                showLoading('Salvando produto...', 'Atualizando banco de dados');
                
                const productRef = database.ref('products').push();
                const productWithMeta = {
                    ...productData,
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    createdBy: currentUser.id,
                    createdByName: currentUser.name,
                    updatedAt: firebase.database.ServerValue.TIMESTAMP,
                    updatedBy: currentUser.id,
                    updatedByName: currentUser.name
                };
                
                await productRef.set(productWithMeta);
                
                // Add to local array
                products.push({ id: productRef.key, ...productWithMeta });
                
                hideLoading();
                return true;
            } catch (error) {
                hideLoading();
                showNotification('error', 'Erro ao salvar', 'NÃ£o foi possÃ­vel salvar o produto. Tente novamente.');
                return false;
            }
        }

        async function validateMovement(movementData) {
            // Find product by code
            const product = products.find(p => p.code === movementData.product);
            
            if (!product) {
                return {
                    valid: false,
                    error: 'PRODUCT_NOT_FOUND',
                    message: `Produto com cÃ³digo "${movementData.product}" nÃ£o foi encontrado no sistema.`
                };
            }
            
            // Check stock availability for exits
            if (movementData.type === 'saida') {
                const requestedQuantity = Math.abs(movementData.quantity);
                if (product.stock < requestedQuantity) {
                    return {
                        valid: false,
                        error: 'INSUFFICIENT_STOCK',
                        message: `Estoque insuficiente. DisponÃ­vel: ${product.stock}, Solicitado: ${requestedQuantity}`,
                        available: product.stock,
                        requested: requestedQuantity,
                        product: product
                    };
                }
            }
            
            return {
                valid: true,
                product: product
            };
        }

        async function processMovement(movementData, product) {
            try {
                // Calculate new stock
                let newStock = product.stock;
                if (movementData.type === 'entrada') {
                    newStock += Math.abs(movementData.quantity);
                } else if (movementData.type === 'saida') {
                    newStock -= Math.abs(movementData.quantity);
                } else if (movementData.type === 'ajuste') {
                    newStock = Math.abs(movementData.quantity);
                }
                
                // Ensure stock never goes negative
                newStock = Math.max(0, newStock);
                
                // Prepare movement data with metadata
                const movementRef = database.ref('movements').push();
                const movementWithMeta = {
                    ...movementData,
                    timestamp: firebase.database.ServerValue.TIMESTAMP,
                    userId: currentUser.id,
                    userName: currentUser.name,
                    userUsername: currentUser.username,
                    productId: product.id,
                    productName: product.name,
                    previousStock: product.stock,
                    newStock: newStock,
                    stockChange: newStock - product.stock
                };
                
                // Use Firebase transaction to ensure data consistency
                const updates = {};
                updates[`movements/${movementRef.key}`] = movementWithMeta;
                updates[`products/${product.id}/stock`] = newStock;
                updates[`products/${product.id}/updatedAt`] = firebase.database.ServerValue.TIMESTAMP;
                updates[`products/${product.id}/updatedBy`] = currentUser.id;
                updates[`products/${product.id}/updatedByName`] = currentUser.name;
                updates[`products/${product.id}/lastMovement`] = firebase.database.ServerValue.TIMESTAMP;
                
                // Execute atomic update
                await database.ref().update(updates);
                
                // Update local data
                product.stock = newStock;
                product.updatedAt = Date.now();
                product.updatedBy = currentUser.id;
                product.updatedByName = currentUser.name;
                product.lastMovement = Date.now();
                
                // Add movement to local array
                const localMovement = { 
                    id: movementRef.key, 
                    ...movementWithMeta,
                    timestamp: Date.now()
                };
                movements.unshift(localMovement);
                
                // Keep only last 100 movements in memory for performance
                if (movements.length > 100) {
                    movements = movements.slice(0, 100);
                }
                
                return {
                    success: true,
                    movement: localMovement,
                    product: product,
                    previousStock: movementWithMeta.previousStock,
                    newStock: newStock,
                    stockChange: movementWithMeta.stockChange
                };
                
            } catch (error) {
                throw new Error(`Falha ao processar movimentaÃ§Ã£o: ${error.message}`);
            }
        }

        async function saveMovement(movementData) {
            try {
                showLoading('Validando movimentaÃ§Ã£o...', 'Verificando disponibilidade');
                
                // Validate movement
                const validation = await validateMovement(movementData);
                
                if (!validation.valid) {
                    hideLoading();
                    
                    if (validation.error === 'PRODUCT_NOT_FOUND') {
                        showProductNotFoundModal(movementData.product);
                        return { success: false, error: validation.error };
                    } else if (validation.error === 'INSUFFICIENT_STOCK') {
                        showInsufficientStockModal(validation.available, validation.requested, validation.product);
                        return { success: false, error: validation.error };
                    }
                    
                    return { success: false, error: validation.error, message: validation.message };
                }
                
                // Update loading message
                showLoading('Processando movimentaÃ§Ã£o...', 'Atualizando banco de dados');
                
                // Process the movement
                const result = await processMovement(movementData, validation.product);
                
                hideLoading();
                
                // Show success modal with details
                showMovementSuccessModal(result);
                
                // Trigger real-time updates
                await updateAllDashboards();
                
                return { success: true, ...result };
                
            } catch (error) {
                hideLoading();
                showNotification('error', 'Erro ao registrar', error.message || 'NÃ£o foi possÃ­vel registrar a movimentaÃ§Ã£o.');
                return { success: false, error: 'PROCESSING_ERROR', message: error.message };
            }
        }

        // ===== MAIN SYSTEM FUNCTIONS =====
        function updateUserAvatar() {
            if (currentUser) {
                document.getElementById('userAvatar').textContent = currentUser.initials;
            }
        }

        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const mainContent = document.getElementById('mainContent');
            
            if (window.innerWidth <= 768) {
                sidebar.classList.toggle('show');
            } else {
                sidebar.classList.toggle('collapsed');
                mainContent.classList.toggle('expanded');
            }
        }

        function showPage(pageId) {
            // Update navigation
            document.querySelectorAll('.nav-link').forEach(link => {
                link.classList.remove('active');
            });
            event.target.closest('.nav-link').classList.add('active');
            
            // Update page title
            const titles = {
                'dashboard': 'Dashboard',
                'products': 'Produtos',
                'movements': 'MovimentaÃ§Ãµes',
                'scanner': 'Scanner QR',
                'reports': 'RelatÃ³rios'
            };
            document.getElementById('pageTitle').textContent = titles[pageId] || 'Dashboard';
            
            // Show page content
            document.querySelectorAll('.page-content').forEach(page => {
                page.classList.remove('active');
            });
            document.getElementById(pageId + 'Page').classList.add('active');
            
            // Close sidebar on mobile
            if (window.innerWidth <= 768) {
                document.getElementById('sidebar').classList.remove('show');
            }
        }

        function updateDashboard() {
            // Update stats
            document.getElementById('dashTotalProducts').textContent = products.length;
            document.getElementById('dashLowStock').textContent = products.filter(p => p.stock <= p.minStock).length;
            document.getElementById('dashTodayMovements').textContent = movements.length;
            
            const totalValue = products.reduce((sum, product) => sum + (product.price * product.stock), 0);
            document.getElementById('dashTotalValue').textContent = `R$ ${totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
        }

        // ===== PRODUCT FUNCTIONS =====
        function showAddProductModal() {
            document.getElementById('addProductModal').classList.add('show');
        }

        async function addProduct(event) {
            event.preventDefault();
            
            const newProduct = {
                code: document.getElementById('productCode').value.toUpperCase(),
                name: document.getElementById('productName').value,
                category: document.getElementById('productCategory').value,
                description: document.getElementById('productDescription').value,
                price: parseFloat(document.getElementById('productPrice').value),
                stock: parseInt(document.getElementById('productStock').value),
                minStock: parseInt(document.getElementById('productMinStock').value)
            };
            
            // Check if code already exists
            const existingProduct = products.find(p => p.code === newProduct.code);
            if (existingProduct) {
                showNotification('warning', 'CÃ³digo jÃ¡ existe', 'Este cÃ³digo de produto jÃ¡ estÃ¡ em uso. Escolha outro cÃ³digo.');
                return;
            }
            
            const success = await saveProduct(newProduct);
            if (success) {
                closeModal('addProductModal');
                renderProducts();
                updateDashboard();
                renderRecentActivities();
                showNotification('success', 'Produto adicionado!', `${newProduct.name} foi adicionado ao estoque.`);
            }
        }

        function renderProducts() {
            const grid = document.getElementById('productsGrid');
            
            if (products.length === 0) {
                grid.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-cube"></i>
                        </div>
                        <div class="empty-state-title">Nenhum produto cadastrado</div>
                        <div class="empty-state-text">Comece adicionando produtos ao seu almoxarifado</div>
                        <button class="btn btn-success mt-3" onclick="showAddProductModal()">
                            <i class="fas fa-plus"></i>
                            Adicionar Primeiro Produto
                        </button>
                    </div>
                `;
                return;
            }
            
            // Performance optimization: Use DocumentFragment for batch DOM updates
            const fragment = document.createDocumentFragment();
            
            // Batch process products in chunks to prevent UI blocking
            const chunkSize = 50;
            let currentIndex = 0;
            
            function processChunk() {
                const endIndex = Math.min(currentIndex + chunkSize, products.length);
                
                for (let i = currentIndex; i < endIndex; i++) {
                    const product = products[i];
                    const stockStatus = getStockStatus(product);
                    const card = createProductCard(product, stockStatus);
                    fragment.appendChild(card);
                }
                
                currentIndex = endIndex;
                
                if (currentIndex < products.length) {
                    // Process next chunk in next frame
                    requestAnimationFrame(processChunk);
                } else {
                    // All products processed, update DOM
                    grid.innerHTML = '';
                    grid.appendChild(fragment);
                }
            }
            
            // Start processing
            processChunk();
        }

        function renderRecentActivities() {
            const container = document.getElementById('recentActivitiesContainer');
            
            if (movements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-clock"></i>
                        </div>
                        <div class="empty-state-title">Nenhuma atividade recente</div>
                        <div class="empty-state-text">As movimentaÃ§Ãµes aparecerÃ£o aqui conforme forem registradas</div>
                    </div>
                `;
                return;
            }
            
            const recentMovements = movements.slice(0, 5);
            const tableHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Hora</th>
                                <th>UsuÃ¡rio</th>
                                <th>AÃ§Ã£o</th>
                                <th>Produto</th>
                                <th>Quantidade</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${recentMovements.map(movement => {
                                const product = products.find(p => p.code === movement.product);
                                const productName = product ? product.name : movement.product;
                                const date = new Date(movement.date || movement.timestamp);
                                const timeStr = date.toLocaleTimeString('pt-BR', { hour: '2-digit', minute: '2-digit' });
                                
                                let typeColor = 'var(--info-color)';
                                let typeLabel = 'Ajuste';
                                if (movement.type === 'entrada') {
                                    typeColor = 'var(--success-color)';
                                    typeLabel = 'Entrada';
                                } else if (movement.type === 'saida') {
                                    typeColor = 'var(--error-color)';
                                    typeLabel = 'SaÃ­da';
                                }
                                
                                const quantityStr = movement.quantity > 0 ? `+${movement.quantity}` : movement.quantity.toString();
                                
                                return `
                                    <tr>
                                        <td>${timeStr}</td>
                                        <td>${movement.userName || movement.user || 'Sistema'}</td>
                                        <td><span style="color: ${typeColor}; font-weight: 600;">${typeLabel}</span></td>
                                        <td>${productName}</td>
                                        <td style="color: ${typeColor}; font-weight: 600;">${quantityStr}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function renderMovementsHistory() {
            const container = document.getElementById('movementsHistoryContainer');
            
            if (movements.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-exchange-alt"></i>
                        </div>
                        <div class="empty-state-title">Nenhuma movimentaÃ§Ã£o registrada</div>
                        <div class="empty-state-text">As movimentaÃ§Ãµes de estoque aparecerÃ£o aqui</div>
                        <button class="btn btn-success mt-3" onclick="showMovementModal()">
                            <i class="fas fa-plus"></i>
                            Registrar Primeira MovimentaÃ§Ã£o
                        </button>
                    </div>
                `;
                return;
            }
            
            const tableHTML = `
                <div class="table-container">
                    <table class="data-table">
                        <thead>
                            <tr>
                                <th>Data/Hora</th>
                                <th>Produto</th>
                                <th>Tipo</th>
                                <th>Quantidade</th>
                                <th>UsuÃ¡rio</th>
                                <th>ObservaÃ§Ãµes</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${movements.map(movement => {
                                const product = products.find(p => p.code === movement.product);
                                const productName = product ? product.name : movement.product;
                                const date = new Date(movement.date || movement.timestamp);
                                const dateStr = date.toLocaleString('pt-BR');
                                
                                let typeColor = 'var(--info-color)';
                                let typeLabel = 'Ajuste';
                                if (movement.type === 'entrada') {
                                    typeColor = 'var(--success-color)';
                                    typeLabel = 'Entrada';
                                } else if (movement.type === 'saida') {
                                    typeColor = 'var(--error-color)';
                                    typeLabel = 'SaÃ­da';
                                }
                                
                                const quantityStr = movement.quantity > 0 ? `+${movement.quantity}` : movement.quantity.toString();
                                
                                return `
                                    <tr>
                                        <td>${dateStr}</td>
                                        <td>${productName}</td>
                                        <td><span style="color: ${typeColor}; font-weight: 600;">${typeLabel}</span></td>
                                        <td style="color: ${typeColor}; font-weight: 600;">${quantityStr}</td>
                                        <td>${movement.userName || movement.user || 'Sistema'}</td>
                                        <td>${movement.notes || '-'}</td>
                                    </tr>
                                `;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            `;
            
            container.innerHTML = tableHTML;
        }

        function updateMovementProductOptions() {
            const select = document.getElementById('movementProduct');
            if (!select) return;
            
            // Store current selection
            const currentValue = select.value;
            
            // Clear and rebuild options
            select.innerHTML = '<option value="">Selecione o produto...</option>';
            
            // Sort products by name for better UX
            const sortedProducts = [...products].sort((a, b) => a.name.localeCompare(b.name));
            
            sortedProducts.forEach(product => {
                const option = document.createElement('option');
                option.value = product.code;
                option.textContent = `${product.code} - ${product.name} (${product.stock} un.)`;
                
                // Add stock status indicator
                if (product.stock === 0) {
                    option.style.color = 'var(--error-color)';
                    option.textContent += ' - SEM ESTOQUE';
                } else if (product.stock <= product.minStock) {
                    option.style.color = 'var(--warning-color)';
                    option.textContent += ' - BAIXO';
                }
                
                select.appendChild(option);
            });
            
            // Restore selection if it still exists
            if (currentValue && products.find(p => p.code === currentValue)) {
                select.value = currentValue;
            }
        }

        // ===== BULK OPERATIONS =====
        async function processBulkMovements(movements) {
            try {
                showLoading('Processando movimentaÃ§Ãµes...', `${movements.length} operaÃ§Ãµes em lote`);
                
                const results = [];
                const errors = [];
                
                for (let i = 0; i < movements.length; i++) {
                    const movement = movements[i];
                    
                    try {
                        // Update loading progress
                        showLoading('Processando movimentaÃ§Ãµes...', `${i + 1} de ${movements.length} operaÃ§Ãµes`);
                        
                        const result = await saveMovement(movement);
                        if (result.success) {
                            results.push(result);
                        } else {
                            errors.push({ movement, error: result.error });
                        }
                        
                        // Small delay to prevent overwhelming Firebase
                        await new Promise(resolve => setTimeout(resolve, 100));
                        
                    } catch (error) {
                        errors.push({ movement, error: error.message });
                    }
                }
                
                hideLoading();
                
                // Show results summary
                if (results.length > 0) {
                    showNotification('success', 'OperaÃ§Ãµes concluÃ­das', 
                        `${results.length} movimentaÃ§Ãµes processadas com sucesso.`);
                }
                
                if (errors.length > 0) {
                    showNotification('warning', 'Algumas operaÃ§Ãµes falharam', 
                        `${errors.length} movimentaÃ§Ãµes nÃ£o puderam ser processadas.`);
                }
                
                return { success: results, errors };
                
            } catch (error) {
                hideLoading();
                showNotification('error', 'Erro no processamento', 'Falha ao processar movimentaÃ§Ãµes em lote.');
                return { success: [], errors: [{ error: error.message }] };
            }
        }

        // ===== PERFORMANCE OPTIMIZATIONS =====
        let updateTimeout = null;
        
        function debounceUpdate(callback, delay = 300) {
            if (updateTimeout) {
                clearTimeout(updateTimeout);
            }
            updateTimeout = setTimeout(callback, delay);
        }

        function optimizedRenderProducts() {
            debounceUpdate(() => {
                renderProducts();
            }, 200);
        }

        function optimizedUpdateDashboard() {
            debounceUpdate(() => {
                updateDashboard();
            }, 150);
        }

        // ===== ADVANCED STOCK VALIDATION =====
        function validateStockOperation(productCode, requestedQuantity, operationType) {
            const product = products.find(p => p.code === productCode);
            
            if (!product) {
                return {
                    valid: false,
                    error: 'PRODUCT_NOT_FOUND',
                    message: `Produto ${productCode} nÃ£o encontrado.`
                };
            }
            
            if (operationType === 'saida' || operationType === 'ajuste_down') {
                if (product.stock < requestedQuantity) {
                    return {
                        valid: false,
                        error: 'INSUFFICIENT_STOCK',
                        message: `Estoque insuficiente para ${product.name}.`,
                        available: product.stock,
                        requested: requestedQuantity,
                        product: product
                    };
                }
            }
            
            // Check for potential stock issues
            const warnings = [];
            
            if (operationType === 'saida') {
                const newStock = product.stock - requestedQuantity;
                if (newStock <= product.minStock && newStock > 0) {
                    warnings.push(`Estoque ficarÃ¡ baixo apÃ³s esta operaÃ§Ã£o (${newStock} unidades).`);
                }
            }
            
            return {
                valid: true,
                product: product,
                warnings: warnings
            };
        }

        // ===== STOCK ALERTS =====
        function checkStockAlerts() {
            const lowStockProducts = products.filter(p => p.stock <= p.minStock && p.stock > 0);
            const outOfStockProducts = products.filter(p => p.stock === 0);
            
            if (outOfStockProducts.length > 0) {
                showNotification('error', 'Produtos sem estoque', 
                    `${outOfStockProducts.length} produto(s) estÃ£o sem estoque.`);
            } else if (lowStockProducts.length > 0) {
                showNotification('warning', 'Estoque baixo', 
                    `${lowStockProducts.length} produto(s) com estoque baixo.`);
            }
        }

        // ===== ENHANCED ERROR HANDLING =====
        function handleMovementError(error, context = {}) {
            let title = 'Erro na movimentaÃ§Ã£o';
            let message = 'Ocorreu um erro inesperado.';
            
            switch (error.code || error.error) {
                case 'PERMISSION_DENIED':
                    title = 'PermissÃ£o negada';
                    message = 'VocÃª nÃ£o tem permissÃ£o para realizar esta operaÃ§Ã£o.';
                    break;
                case 'NETWORK_ERROR':
                    title = 'Erro de conexÃ£o';
                    message = 'Verifique sua conexÃ£o com a internet e tente novamente.';
                    break;
                case 'PRODUCT_NOT_FOUND':
                    title = 'Produto nÃ£o encontrado';
                    message = context.productCode ? 
                        `O produto ${context.productCode} nÃ£o foi encontrado.` : 
                        'O produto selecionado nÃ£o existe.';
                    break;
                case 'INSUFFICIENT_STOCK':
                    title = 'Estoque insuficiente';
                    message = context.available !== undefined ? 
                        `DisponÃ­vel: ${context.available}, Solicitado: ${context.requested}` : 
                        'NÃ£o hÃ¡ estoque suficiente para esta operaÃ§Ã£o.';
                    break;
                default:
                    message = error.message || message;
            }
            
            showNotification('error', title, message);
        }

        function getStockStatus(product) {
            if (product.stock === 0) return { class: 'stock-out', label: 'Sem Estoque' };
            if (product.stock <= product.minStock) return { class: 'stock-low', label: 'Baixo' };
            if (product.stock <= product.minStock * 1.5) return { class: 'stock-warning', label: 'AtenÃ§Ã£o' };
            return { class: 'stock-normal', label: 'Normal' };
        }

        function createProductCard(product, stockStatus) {
            const card = document.createElement('div');
            card.className = 'product-card';
            card.setAttribute('data-category', product.category);
            card.setAttribute('data-stock', stockStatus.class.replace('stock-', ''));
            
            card.innerHTML = `
                <div class="product-card-header">
                    <div class="product-card-code">${product.code}</div>
                    <h3 class="product-card-title">${product.name}</h3>
                    <div class="product-card-category">
                        <i class="fas fa-tag"></i>
                        ${product.category}
                    </div>
                </div>
                <div class="product-card-body">
                    <p class="product-card-description">${product.description}</p>
                    <div class="product-card-stats">
                        <div class="product-stat">
                            <span class="product-stat-value">R$ ${product.price.toFixed(2)}</span>
                            <span class="product-stat-label">PreÃ§o Unit.</span>
                        </div>
                        <div class="product-stat">
                            <span class="product-stat-value">${product.stock}</span>
                            <span class="product-stat-label">DisponÃ­vel</span>
                        </div>
                    </div>
                    <div class="product-card-stock">
                        <div class="product-stock-info">
                            <div class="product-stock-current">${product.stock} unidades</div>
                            <div class="product-stock-min">MÃ­n: ${product.minStock} unidades</div>
                        </div>
                        <div class="product-stock-badge ${stockStatus.class}">${stockStatus.label}</div>
                    </div>
                </div>
                <div class="product-card-footer">
                    <div class="product-card-actions">
                        <button class="product-action-btn primary" onclick="showMovementModal('${product.code}')">
                            <i class="fas fa-exchange-alt"></i>
                            Movimentar
                        </button>
                        <button class="product-action-btn secondary" onclick="generateQRCode('${product.code}')">
                            <i class="fas fa-qrcode"></i>
                            QR Code
                        </button>
                    </div>
                </div>
            `;
            
            return card;
        }

        function filterProducts() {
            const searchTerm = document.getElementById('productSearch').value.toLowerCase();
            const categoryFilter = document.getElementById('categoryFilter').value;
            const stockFilter = document.getElementById('stockFilter').value;
            
            const cards = document.querySelectorAll('.product-card');
            
            cards.forEach(card => {
                const productName = card.querySelector('.product-card-title').textContent.toLowerCase();
                const productCategory = card.getAttribute('data-category');
                const productStock = card.getAttribute('data-stock');
                
                const matchesSearch = productName.includes(searchTerm);
                const matchesCategory = !categoryFilter || productCategory === categoryFilter;
                const matchesStock = !stockFilter || productStock === stockFilter;
                
                if (matchesSearch && matchesCategory && matchesStock) {
                    card.style.display = 'block';
                } else {
                    card.style.display = 'none';
                }
            });
        }

        // ===== MOVEMENT FUNCTIONS =====
        function showMovementModal(productCode = '') {
            updateMovementProductOptions();
            
            if (productCode) {
                document.getElementById('movementProduct').value = productCode;
            }
            
            // Set current date/time
            const now = new Date();
            const dateTimeString = now.toISOString().slice(0, 16);
            document.getElementById('movementDate').value = dateTimeString;
            
            document.getElementById('movementModal').classList.add('show');
        }

        // ===== REPORTS FUNCTIONS =====
        function updateReportFilters() {
            const reportType = document.getElementById('reportType').value;
            const startDateInput = document.getElementById('reportStartDate');
            const endDateInput = document.getElementById('reportEndDate');
            const categoryInput = document.getElementById('reportCategory');
            
            // Set default dates
            const today = new Date();
            const thirtyDaysAgo = new Date(today.getTime() - (30 * 24 * 60 * 60 * 1000));
            
            if (!startDateInput.value) {
                startDateInput.value = thirtyDaysAgo.toISOString().split('T')[0];
            }
            if (!endDateInput.value) {
                endDateInput.value = today.toISOString().split('T')[0];
            }
            
            // Update report title
            const titles = {
                'inventory': 'RelatÃ³rio de InventÃ¡rio',
                'movements': 'RelatÃ³rio de MovimentaÃ§Ãµes',
                'lowStock': 'RelatÃ³rio de Estoque Baixo',
                'valueAnalysis': 'AnÃ¡lise de Valor do Estoque',
                'categoryAnalysis': 'AnÃ¡lise por Categoria'
            };
            
            document.getElementById('reportTitle').textContent = titles[reportType] || 'RelatÃ³rio';
        }

        function applyReportFilters() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const category = document.getElementById('reportCategory').value;
            
            showLoading('Gerando relatÃ³rio...', 'Processando dados');
            
            setTimeout(() => {
                try {
                    let reportData = {};
                    
                    switch (reportType) {
                        case 'inventory':
                            reportData = generateInventoryReport(category);
                            break;
                        case 'movements':
                            reportData = generateMovementsReport(startDate, endDate, category);
                            break;
                        case 'lowStock':
                            reportData = generateLowStockReport(category);
                            break;
                        case 'valueAnalysis':
                            reportData = generateValueAnalysisReport(category);
                            break;
                        case 'categoryAnalysis':
                            reportData = generateCategoryAnalysisReport();
                            break;
                        default:
                            reportData = generateInventoryReport(category);
                    }
                    
                    updateReportSummary(reportData.summary);
                    renderReportContent(reportData.content, reportType);
                    
                    hideLoading();
                    showNotification('success', 'RelatÃ³rio gerado!', 'O relatÃ³rio foi gerado com sucesso.');
                    
                } catch (error) {
                    hideLoading();
                    console.error('Report generation error:', error);
                    showNotification('error', 'Erro no relatÃ³rio', 'NÃ£o foi possÃ­vel gerar o relatÃ³rio. Tente novamente.');
                }
            }, 1000);
        }

        function generateInventoryReport(category = '') {
            let filteredProducts = products;
            
            if (category) {
                filteredProducts = products.filter(p => p.category === category);
            }
            
            const totalStock = filteredProducts.reduce((sum, p) => sum + p.stock, 0);
            const totalValue = filteredProducts.reduce((sum, p) => sum + (p.price * p.stock), 0);
            const lowStockCount = filteredProducts.filter(p => p.stock <= p.minStock).length;
            
            const summary = {
                totalProducts: filteredProducts.length,
                totalStock: totalStock,
                totalValue: totalValue,
                movements: 0
            };
            
            const content = filteredProducts.map(product => {
                const stockStatus = getStockStatus(product);
                return {
                    code: product.code,
                    name: product.name,
                    category: product.category,
                    stock: product.stock,
                    minStock: product.minStock,
                    price: product.price,
                    totalValue: product.price * product.stock,
                    status: stockStatus.label,
                    statusClass: stockStatus.class
                };
            });
            
            return { summary, content };
        }

        function generateMovementsReport(startDate, endDate, category = '') {
            const start = new Date(startDate);
            const end = new Date(endDate);
            end.setHours(23, 59, 59, 999);
            
            let filteredMovements = movements.filter(movement => {
                const movementDate = new Date(movement.date || movement.timestamp);
                return movementDate >= start && movementDate <= end;
            });
            
            if (category) {
                filteredMovements = filteredMovements.filter(movement => {
                    const product = products.find(p => p.code === movement.product);
                    return product && product.category === category;
                });
            }
            
            const totalEntries = filteredMovements.filter(m => m.type === 'entrada').reduce((sum, m) => sum + Math.abs(m.quantity), 0);
            const totalExits = filteredMovements.filter(m => m.type === 'saida').reduce((sum, m) => sum + Math.abs(m.quantity), 0);
            const totalAdjustments = filteredMovements.filter(m => m.type === 'ajuste').length;
            
            const summary = {
                totalProducts: new Set(filteredMovements.map(m => m.product)).size,
                totalStock: totalEntries - totalExits,
                totalValue: 0,
                movements: filteredMovements.length
            };
            
            const content = filteredMovements.map(movement => {
                const product = products.find(p => p.code === movement.product);
                const date = new Date(movement.date || movement.timestamp);
                
                return {
                    date: date.toLocaleString('pt-BR'),
                    product: product ? product.name : movement.product,
                    code: movement.product,
                    type: movement.type,
                    quantity: movement.quantity,
                    user: movement.userName || movement.user || 'Sistema',
                    notes: movement.notes || '-'
                };
            });
            
            return { summary, content };
        }

        function generateLowStockReport(category = '') {
            let filteredProducts = products.filter(p => p.stock <= p.minStock);
            
            if (category) {
                filteredProducts = filteredProducts.filter(p => p.category === category);
            }
            
            const totalStock = filteredProducts.reduce((sum, p) => sum + p.stock, 0);
            const totalValue = filteredProducts.reduce((sum, p) => sum + (p.price * p.stock), 0);
            
            const summary = {
                totalProducts: filteredProducts.length,
                totalStock: totalStock,
                totalValue: totalValue,
                movements: 0
            };
            
            const content = filteredProducts.map(product => {
                const deficit = product.minStock - product.stock;
                const stockStatus = getStockStatus(product);
                
                return {
                    code: product.code,
                    name: product.name,
                    category: product.category,
                    stock: product.stock,
                    minStock: product.minStock,
                    deficit: deficit > 0 ? deficit : 0,
                    price: product.price,
                    status: stockStatus.label,
                    statusClass: stockStatus.class,
                    priority: product.stock === 0 ? 'CrÃ­tico' : 'Baixo'
                };
            });
            
            return { summary, content };
        }

        function generateValueAnalysisReport(category = '') {
            let filteredProducts = products;
            
            if (category) {
                filteredProducts = products.filter(p => p.category === category);
            }
            
            const totalStock = filteredProducts.reduce((sum, p) => sum + p.stock, 0);
            const totalValue = filteredProducts.reduce((sum, p) => sum + (p.price * p.stock), 0);
            
            const summary = {
                totalProducts: filteredProducts.length,
                totalStock: totalStock,
                totalValue: totalValue,
                movements: 0
            };
            
            const content = filteredProducts.map(product => {
                const totalProductValue = product.price * product.stock;
                const valuePercentage = totalValue > 0 ? (totalProductValue / totalValue * 100) : 0;
                
                return {
                    code: product.code,
                    name: product.name,
                    category: product.category,
                    stock: product.stock,
                    price: product.price,
                    totalValue: totalProductValue,
                    percentage: valuePercentage,
                    classification: valuePercentage > 20 ? 'Alto Valor' : valuePercentage > 5 ? 'MÃ©dio Valor' : 'Baixo Valor'
                };
            }).sort((a, b) => b.totalValue - a.totalValue);
            
            return { summary, content };
        }

        function generateCategoryAnalysisReport() {
            const categories = {};
            
            products.forEach(product => {
                if (!categories[product.category]) {
                    categories[product.category] = {
                        name: product.category,
                        products: 0,
                        totalStock: 0,
                        totalValue: 0,
                        lowStock: 0
                    };
                }
                
                categories[product.category].products++;
                categories[product.category].totalStock += product.stock;
                categories[product.category].totalValue += product.price * product.stock;
                
                if (product.stock <= product.minStock) {
                    categories[product.category].lowStock++;
                }
            });
            
            const categoryArray = Object.values(categories);
            const totalProducts = categoryArray.reduce((sum, cat) => sum + cat.products, 0);
            const totalStock = categoryArray.reduce((sum, cat) => sum + cat.totalStock, 0);
            const totalValue = categoryArray.reduce((sum, cat) => sum + cat.totalValue, 0);
            
            const summary = {
                totalProducts: totalProducts,
                totalStock: totalStock,
                totalValue: totalValue,
                movements: Object.keys(categories).length
            };
            
            const content = categoryArray.map(category => ({
                ...category,
                percentage: totalProducts > 0 ? (category.products / totalProducts * 100) : 0,
                valuePercentage: totalValue > 0 ? (category.totalValue / totalValue * 100) : 0
            })).sort((a, b) => b.totalValue - a.totalValue);
            
            return { summary, content };
        }

        function updateReportSummary(summary) {
            document.getElementById('reportTotalProducts').textContent = summary.totalProducts;
            document.getElementById('reportTotalStock').textContent = summary.totalStock.toLocaleString('pt-BR');
            document.getElementById('reportTotalValue').textContent = `R$ ${summary.totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}`;
            document.getElementById('reportMovements').textContent = summary.movements;
        }

        function renderReportContent(content, reportType) {
            const container = document.getElementById('reportContent');
            
            if (content.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="empty-state-title">Nenhum dado encontrado</div>
                        <div class="empty-state-text">NÃ£o hÃ¡ dados para os filtros selecionados</div>
                    </div>
                `;
                return;
            }
            
            let tableHTML = '';
            
            switch (reportType) {
                case 'inventory':
                    tableHTML = generateInventoryTable(content);
                    break;
                case 'movements':
                    tableHTML = generateMovementsTable(content);
                    break;
                case 'lowStock':
                    tableHTML = generateLowStockTable(content);
                    break;
                case 'valueAnalysis':
                    tableHTML = generateValueAnalysisTable(content);
                    break;
                case 'categoryAnalysis':
                    tableHTML = generateCategoryAnalysisTable(content);
                    break;
                default:
                    tableHTML = generateInventoryTable(content);
            }
            
            container.innerHTML = `
                <div class="table-container">
                    ${tableHTML}
                </div>
            `;
        }

        function generateInventoryTable(content) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Categoria</th>
                            <th>Estoque</th>
                            <th>MÃ­n.</th>
                            <th>PreÃ§o Unit.</th>
                            <th>Valor Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td><strong>${item.code}</strong></td>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td>${item.stock}</td>
                                <td>${item.minStock}</td>
                                <td>R$ ${item.price.toFixed(2)}</td>
                                <td>R$ ${item.totalValue.toFixed(2)}</td>
                                <td><span class="product-stock-badge ${item.statusClass}">${item.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateMovementsTable(content) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Tipo</th>
                            <th>Quantidade</th>
                            <th>UsuÃ¡rio</th>
                            <th>ObservaÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => {
                            let typeColor = 'var(--info-color)';
                            let typeLabel = 'Ajuste';
                            if (item.type === 'entrada') {
                                typeColor = 'var(--success-color)';
                                typeLabel = 'Entrada';
                            } else if (item.type === 'saida') {
                                typeColor = 'var(--error-color)';
                                typeLabel = 'SaÃ­da';
                            }
                            
                            const quantityStr = item.quantity > 0 ? `+${item.quantity}` : item.quantity.toString();
                            
                            return `
                                <tr>
                                    <td>${item.date}</td>
                                    <td><strong>${item.code}</strong></td>
                                    <td>${item.product}</td>
                                    <td><span style="color: ${typeColor}; font-weight: 600;">${typeLabel}</span></td>
                                    <td style="color: ${typeColor}; font-weight: 600;">${quantityStr}</td>
                                    <td>${item.user}</td>
                                    <td>${item.notes}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateLowStockTable(content) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Categoria</th>
                            <th>Estoque</th>
                            <th>MÃ­n.</th>
                            <th>DÃ©ficit</th>
                            <th>Prioridade</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td><strong>${item.code}</strong></td>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td>${item.stock}</td>
                                <td>${item.minStock}</td>
                                <td style="color: var(--error-color); font-weight: 600;">${item.deficit}</td>
                                <td>
                                    <span style="color: ${item.priority === 'CrÃ­tico' ? 'var(--error-color)' : 'var(--warning-color)'}; font-weight: 600;">
                                        ${item.priority}
                                    </span>
                                </td>
                                <td><span class="product-stock-badge ${item.statusClass}">${item.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateValueAnalysisTable(content) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Categoria</th>
                            <th>Estoque</th>
                            <th>PreÃ§o Unit.</th>
                            <th>Valor Total</th>
                            <th>% do Total</th>
                            <th>ClassificaÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td><strong>${item.code}</strong></td>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td>${item.stock}</td>
                                <td>R$ ${item.price.toFixed(2)}</td>
                                <td>R$ ${item.totalValue.toFixed(2)}</td>
                                <td>${item.percentage.toFixed(1)}%</td>
                                <td>
                                    <span style="color: ${item.classification === 'Alto Valor' ? 'var(--success-color)' : 
                                                        item.classification === 'MÃ©dio Valor' ? 'var(--warning-color)' : 'var(--text-secondary)'}; font-weight: 600;">
                                        ${item.classification}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function generateCategoryAnalysisTable(content) {
            return `
                <table class="data-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Produtos</th>
                            <th>% Produtos</th>
                            <th>Estoque Total</th>
                            <th>Valor Total</th>
                            <th>% Valor</th>
                            <th>Estoque Baixo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td><strong>${item.name}</strong></td>
                                <td>${item.products}</td>
                                <td>${item.percentage.toFixed(1)}%</td>
                                <td>${item.totalStock.toLocaleString('pt-BR')}</td>
                                <td>R$ ${item.totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td>${item.valuePercentage.toFixed(1)}%</td>
                                <td style="color: ${item.lowStock > 0 ? 'var(--error-color)' : 'var(--success-color)'}; font-weight: 600;">
                                    ${item.lowStock}
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function clearReportFilters() {
            document.getElementById('reportType').value = 'inventory';
            document.getElementById('reportStartDate').value = '';
            document.getElementById('reportEndDate').value = '';
            document.getElementById('reportCategory').value = '';
            
            document.getElementById('reportContent').innerHTML = `
                <div class="empty-state">
                    <div class="empty-state-icon">
                        <i class="fas fa-chart-bar"></i>
                    </div>
                    <div class="empty-state-title">Selecione os filtros</div>
                    <div class="empty-state-text">Configure os filtros acima e clique em "Aplicar Filtros" para gerar o relatÃ³rio</div>
                </div>
            `;
            
            updateReportSummary({ totalProducts: 0, totalStock: 0, totalValue: 0, movements: 0 });
            updateReportFilters();
        }

        // ===== PDF REPORT GENERATION =====
        async function generatePDFReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const category = document.getElementById('reportCategory').value;
            
            if (!startDate || !endDate) {
                showNotification('warning', 'Datas obrigatÃ³rias', 'Selecione as datas inicial e final para gerar o relatÃ³rio.');
                return;
            }
            
            try {
                showLoading('Gerando relatÃ³rio PDF...', 'Processando dados e criando documento');
                
                // Generate report data
                const reportData = await generateReportData(reportType, startDate, endDate, category);
                
                // Store current report data for potential re-use
                currentReportData = reportData;
                currentReportType = reportType;
                currentReportFilters = { startDate, endDate, category };
                
                // Generate PDF HTML content
                const pdfHTML = generatePDFHTML(reportData, reportType, { startDate, endDate, category });
                
                // Configure PDF options
                const opt = {
                    margin: [0.5, 0.5, 0.5, 0.5],
                    filename: `relatorio_${reportType}_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        allowTaint: false
                    },
                    jsPDF: { 
                        unit: 'in', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                // Create temporary container for PDF generation
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = pdfHTML;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '-9999px';
                document.body.appendChild(tempContainer);
                
                // Generate and download PDF
                await html2pdf().set(opt).from(tempContainer).save();
                
                // Clean up
                document.body.removeChild(tempContainer);
                
                hideLoading();
                showNotification('success', 'PDF gerado!', 'O relatÃ³rio foi baixado com sucesso.');
                
            } catch (error) {
                hideLoading();
                console.error('PDF generation error:', error);
                showNotification('error', 'Erro na geraÃ§Ã£o', 'NÃ£o foi possÃ­vel gerar o relatÃ³rio PDF. Tente novamente.');
            }
        }

        async function previewReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const category = document.getElementById('reportCategory').value;
            
            if (!startDate || !endDate) {
                showNotification('warning', 'Datas obrigatÃ³rias', 'Selecione as datas inicial e final para visualizar o relatÃ³rio.');
                return;
            }
            
            try {
                showLoading('Preparando visualizaÃ§Ã£o...', 'Gerando preview do relatÃ³rio');
                
                // Generate report data
                const reportData = await generateReportData(reportType, startDate, endDate, category);
                
                // Store current report data
                currentReportData = reportData;
                currentReportType = reportType;
                currentReportFilters = { startDate, endDate, category };
                
                // Generate PDF HTML content
                const pdfHTML = generatePDFHTML(reportData, reportType, { startDate, endDate, category });
                
                // Show in preview modal
                document.getElementById('pdfPreviewContainer').innerHTML = pdfHTML;
                document.getElementById('pdfPreviewModal').classList.add('show');
                
                hideLoading();
                
            } catch (error) {
                hideLoading();
                console.error('Preview generation error:', error);
                showNotification('error', 'Erro na visualizaÃ§Ã£o', 'NÃ£o foi possÃ­vel gerar a visualizaÃ§Ã£o. Tente novamente.');
            }
        }

        async function downloadCurrentPDF() {
            if (!currentReportData || !currentReportType || !currentReportFilters) {
                showNotification('warning', 'Nenhum relatÃ³rio', 'Gere um relatÃ³rio primeiro para fazer o download.');
                return;
            }
            
            try {
                showLoading('Baixando PDF...', 'Convertendo visualizaÃ§Ã£o em arquivo');
                
                const pdfHTML = generatePDFHTML(currentReportData, currentReportType, currentReportFilters);
                
                const opt = {
                    margin: [0.5, 0.5, 0.5, 0.5],
                    filename: `relatorio_${currentReportType}_${new Date().toISOString().split('T')[0]}.pdf`,
                    image: { type: 'jpeg', quality: 0.98 },
                    html2canvas: { 
                        scale: 2,
                        useCORS: true,
                        letterRendering: true,
                        allowTaint: false
                    },
                    jsPDF: { 
                        unit: 'in', 
                        format: 'a4', 
                        orientation: 'portrait',
                        compress: true
                    },
                    pagebreak: { mode: ['avoid-all', 'css', 'legacy'] }
                };
                
                const tempContainer = document.createElement('div');
                tempContainer.innerHTML = pdfHTML;
                tempContainer.style.position = 'absolute';
                tempContainer.style.left = '-9999px';
                tempContainer.style.top = '-9999px';
                document.body.appendChild(tempContainer);
                
                await html2pdf().set(opt).from(tempContainer).save();
                
                document.body.removeChild(tempContainer);
                
                hideLoading();
                showNotification('success', 'PDF baixado!', 'O arquivo foi salvo com sucesso.');
                
            } catch (error) {
                hideLoading();
                console.error('PDF download error:', error);
                showNotification('error', 'Erro no download', 'NÃ£o foi possÃ­vel baixar o PDF. Tente novamente.');
            }
        }

        async function generateReportData(reportType, startDate, endDate, category) {
            // Ensure we have fresh data from Firebase
            await refreshDataFromFirebase();
            
            let reportData = {};
            
            switch (reportType) {
                case 'inventory':
                    reportData = generateInventoryReport(category);
                    break;
                case 'movements':
                    reportData = generateMovementsReport(startDate, endDate, category);
                    break;
                case 'lowStock':
                    reportData = generateLowStockReport(category);
                    break;
                case 'valueAnalysis':
                    reportData = generateValueAnalysisReport(category);
                    break;
                case 'categoryAnalysis':
                    reportData = generateCategoryAnalysisReport();
                    break;
                default:
                    reportData = generateInventoryReport(category);
            }
            
            return reportData;
        }

        async function refreshDataFromFirebase() {
            try {
                // Refresh products data
                const productsSnapshot = await database.ref('products').once('value');
                const productsData = productsSnapshot.val();
                
                if (productsData) {
                    products = Object.keys(productsData).map(key => ({
                        id: key,
                        ...productsData[key]
                    }));
                }
                
                // Refresh movements data
                const movementsSnapshot = await database.ref('movements').orderByChild('timestamp').limitToLast(1000).once('value');
                const movementsData = movementsSnapshot.val();
                
                if (movementsData) {
                    movements = Object.keys(movementsData).map(key => ({
                        id: key,
                        ...movementsData[key]
                    })).reverse();
                }
                
            } catch (error) {
                console.error('Error refreshing data:', error);
                // Continue with existing data if refresh fails
            }
        }

        function generatePDFHTML(reportData, reportType, filters) {
            const { summary, content } = reportData;
            const { startDate, endDate, category } = filters;
            
            const reportTitles = {
                'inventory': 'RelatÃ³rio de InventÃ¡rio',
                'movements': 'RelatÃ³rio de MovimentaÃ§Ãµes',
                'lowStock': 'RelatÃ³rio de Estoque Baixo',
                'valueAnalysis': 'AnÃ¡lise de Valor do Estoque',
                'categoryAnalysis': 'AnÃ¡lise por Categoria'
            };
            
            const reportTitle = reportTitles[reportType] || 'RelatÃ³rio';
            const currentDate = new Date().toLocaleString('pt-BR');
            const userName = currentUser ? currentUser.name : 'Sistema';
            
            // Generate filters info
            let filtersHTML = '';
            if (startDate && endDate) {
                const startDateFormatted = new Date(startDate).toLocaleDateString('pt-BR');
                const endDateFormatted = new Date(endDate).toLocaleDateString('pt-BR');
                filtersHTML += `<p><strong>PerÃ­odo:</strong> ${startDateFormatted} atÃ© ${endDateFormatted}</p>`;
            }
            if (category) {
                filtersHTML += `<p><strong>Categoria:</strong> ${category}</p>`;
            }
            filtersHTML += `<p><strong>Tipo:</strong> ${reportTitle}</p>`;
            
            // Generate table based on report type
            let tableHTML = '';
            
            switch (reportType) {
                case 'inventory':
                    tableHTML = generatePDFInventoryTable(content);
                    break;
                case 'movements':
                    tableHTML = generatePDFMovementsTable(content);
                    break;
                case 'lowStock':
                    tableHTML = generatePDFLowStockTable(content);
                    break;
                case 'valueAnalysis':
                    tableHTML = generatePDFValueAnalysisTable(content);
                    break;
                case 'categoryAnalysis':
                    tableHTML = generatePDFCategoryAnalysisTable(content);
                    break;
                default:
                    tableHTML = generatePDFInventoryTable(content);
            }
            
            return `
                <div class="pdf-report">
                    <div class="pdf-report-header">
                        <div class="pdf-report-logo">
                            <div class="pdf-report-logo-icon">
                                <i class="fas fa-warehouse"></i>
                            </div>
                            <div class="pdf-report-logo-text">
                                <h1>Sistema de Almoxarifado</h1>
                                <p>GestÃ£o completa e inteligente do seu estoque</p>
                            </div>
                        </div>
                        <div class="pdf-report-meta">
                            <div><strong>Data:</strong> ${currentDate}</div>
                            <div><strong>UsuÃ¡rio:</strong> ${userName}</div>
                            <div><strong>PÃ¡ginas:</strong> ${Math.ceil(content.length / 25)}</div>
                        </div>
                    </div>
                    
                    <div class="pdf-report-title">
                        <h2>${reportTitle}</h2>
                        <p>RelatÃ³rio detalhado com dados em tempo real</p>
                    </div>
                    
                    ${filtersHTML ? `
                        <div class="pdf-filters-info">
                            <h4>Filtros Aplicados</h4>
                            ${filtersHTML}
                        </div>
                    ` : ''}
                    
                    <div class="pdf-report-summary">
                        <div class="pdf-summary-card">
                            <div class="pdf-summary-card-value">${summary.totalProducts}</div>
                            <div class="pdf-summary-card-label">Total de Produtos</div>
                        </div>
                        <div class="pdf-summary-card">
                            <div class="pdf-summary-card-value">${summary.totalStock.toLocaleString('pt-BR')}</div>
                            <div class="pdf-summary-card-label">Estoque Total</div>
                        </div>
                        <div class="pdf-summary-card">
                            <div class="pdf-summary-card-value">R$ ${summary.totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</div>
                            <div class="pdf-summary-card-label">Valor Total</div>
                        </div>
                        <div class="pdf-summary-card">
                            <div class="pdf-summary-card-value">${summary.movements}</div>
                            <div class="pdf-summary-card-label">${reportType === 'movements' ? 'MovimentaÃ§Ãµes' : reportType === 'categoryAnalysis' ? 'Categorias' : 'Itens'}</div>
                        </div>
                    </div>
                    
                    <div class="pdf-section-title">Dados Detalhados</div>
                    
                    ${tableHTML}
                    
                    <div class="pdf-report-footer">
                        <p>RelatÃ³rio gerado automaticamente pelo Sistema de Almoxarifado</p>
                        <p>Â© ${new Date().getFullYear()} - Todos os direitos reservados</p>
                    </div>
                </div>
            `;
        }

        function generatePDFInventoryTable(content) {
            if (content.length === 0) {
                return '<p style="text-align: center; color: #666; font-style: italic;">Nenhum produto encontrado para os filtros selecionados.</p>';
            }
            
            return `
                <table class="pdf-report-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Categoria</th>
                            <th>Estoque</th>
                            <th>MÃ­n.</th>
                            <th>PreÃ§o Unit.</th>
                            <th>Valor Total</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td><strong>${item.code}</strong></td>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td>${item.stock}</td>
                                <td>${item.minStock}</td>
                                <td>R$ ${item.price.toFixed(2)}</td>
                                <td>R$ ${item.totalValue.toFixed(2)}</td>
                                <td><span class="pdf-status-badge pdf-status-${item.statusClass.replace('stock-', '')}">${item.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function generatePDFMovementsTable(content) {
            if (content.length === 0) {
                return '<p style="text-align: center; color: #666; font-style: italic;">Nenhuma movimentaÃ§Ã£o encontrada para o perÃ­odo selecionado.</p>';
            }
            
            return `
                <table class="pdf-report-table">
                    <thead>
                        <tr>
                            <th>Data/Hora</th>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Tipo</th>
                            <th>Qtd.</th>
                            <th>UsuÃ¡rio</th>
                            <th>ObservaÃ§Ãµes</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => {
                            let typeClass = 'normal';
                            if (item.type === 'entrada') typeClass = 'normal';
                            else if (item.type === 'saida') typeClass = 'out';
                            else if (item.type === 'ajuste') typeClass = 'warning';
                            
                            const quantityStr = item.quantity > 0 ? `+${item.quantity}` : item.quantity.toString();
                            
                            return `
                                <tr>
                                    <td>${item.date}</td>
                                    <td><strong>${item.code}</strong></td>
                                    <td>${item.product}</td>
                                    <td><span class="pdf-status-badge pdf-status-${typeClass}">${item.type.toUpperCase()}</span></td>
                                    <td><strong>${quantityStr}</strong></td>
                                    <td>${item.user}</td>
                                    <td>${item.notes}</td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function generatePDFLowStockTable(content) {
            if (content.length === 0) {
                return '<p style="text-align: center; color: #666; font-style: italic;">Nenhum produto com estoque baixo encontrado.</p>';
            }
            
            return `
                <table class="pdf-report-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Categoria</th>
                            <th>Estoque</th>
                            <th>MÃ­n.</th>
                            <th>DÃ©ficit</th>
                            <th>Prioridade</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td><strong>${item.code}</strong></td>
                                <td>${item.name}</td>
                                <td>${item.category}</td>
                                <td>${item.stock}</td>
                                <td>${item.minStock}</td>
                                <td><strong style="color: #d32f2f;">${item.deficit}</strong></td>
                                <td>
                                    <span class="pdf-status-badge pdf-status-${item.priority === 'CrÃ­tico' ? 'out' : 'low'}">
                                        ${item.priority}
                                    </span>
                                </td>
                                <td><span class="pdf-status-badge pdf-status-${item.statusClass.replace('stock-', '')}">${item.status}</span></td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        function generatePDFValueAnalysisTable(content) {
            if (content.length === 0) {
                return '<p style="text-align: center; color: #666; font-style: italic;">Nenhum produto encontrado para anÃ¡lise de valor.</p>';
            }
            
            return `
                <table class="pdf-report-table">
                    <thead>
                        <tr>
                            <th>CÃ³digo</th>
                            <th>Produto</th>
                            <th>Categoria</th>
                            <th>Estoque</th>
                            <th>PreÃ§o Unit.</th>
                            <th>Valor Total</th>
                            <th>% do Total</th>
                            <th>ClassificaÃ§Ã£o</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => {
                            let classificationClass = 'normal';
                            if (item.classification === 'Alto Valor') classificationClass = 'normal';
                            else if (item.classification === 'MÃ©dio Valor') classificationClass = 'warning';
                            else classificationClass = 'low';
                            
                            return `
                                <tr>
                                    <td><strong>${item.code}</strong></td>
                                    <td>${item.name}</td>
                                    <td>${item.category}</td>
                                    <td>${item.stock}</td>
                                    <td>R$ ${item.price.toFixed(2)}</td>
                                    <td>R$ ${item.totalValue.toFixed(2)}</td>
                                    <td><strong>${item.percentage.toFixed(1)}%</strong></td>
                                    <td>
                                        <span class="pdf-status-badge pdf-status-${classificationClass}">
                                            ${item.classification}
                                        </span>
                                    </td>
                                </tr>
                            `;
                        }).join('')}
                    </tbody>
                </table>
            `;
        }

        function generatePDFCategoryAnalysisTable(content) {
            if (content.length === 0) {
                return '<p style="text-align: center; color: #666; font-style: italic;">Nenhuma categoria encontrada para anÃ¡lise.</p>';
            }
            
            return `
                <table class="pdf-report-table">
                    <thead>
                        <tr>
                            <th>Categoria</th>
                            <th>Produtos</th>
                            <th>% Produtos</th>
                            <th>Estoque Total</th>
                            <th>Valor Total</th>
                            <th>% Valor</th>
                            <th>Estoque Baixo</th>
                        </tr>
                    </thead>
                    <tbody>
                        ${content.map(item => `
                            <tr>
                                <td><strong>${item.name}</strong></td>
                                <td>${item.products}</td>
                                <td>${item.percentage.toFixed(1)}%</td>
                                <td>${item.totalStock.toLocaleString('pt-BR')}</td>
                                <td>R$ ${item.totalValue.toLocaleString('pt-BR', {minimumFractionDigits: 2})}</td>
                                <td><strong>${item.valuePercentage.toFixed(1)}%</strong></td>
                                <td>
                                    <span class="pdf-status-badge pdf-status-${item.lowStock > 0 ? 'out' : 'normal'}">
                                        ${item.lowStock}
                                    </span>
                                </td>
                            </tr>
                        `).join('')}
                    </tbody>
                </table>
            `;
        }

        // Legacy CSV generation function (kept for compatibility)
        function generateReport() {
            const reportType = document.getElementById('reportType').value;
            const startDate = document.getElementById('reportStartDate').value;
            const endDate = document.getElementById('reportEndDate').value;
            const category = document.getElementById('reportCategory').value;
            
            if (!startDate || !endDate) {
                showNotification('warning', 'Datas obrigatÃ³rias', 'Selecione as datas inicial e final para gerar o relatÃ³rio.');
                return;
            }
            
            showLoading('Exportando relatÃ³rio CSV...', 'Preparando arquivo para download');
            
            setTimeout(() => {
                try {
                    let reportData = {};
                    
                    switch (reportType) {
                        case 'inventory':
                            reportData = generateInventoryReport(category);
                            break;
                        case 'movements':
                            reportData = generateMovementsReport(startDate, endDate, category);
                            break;
                        case 'lowStock':
                            reportData = generateLowStockReport(category);
                            break;
                        case 'valueAnalysis':
                            reportData = generateValueAnalysisReport(category);
                            break;
                        case 'categoryAnalysis':
                            reportData = generateCategoryAnalysisReport();
                            break;
                        default:
                            reportData = generateInventoryReport(category);
                    }
                    
                    // Generate CSV content
                    const csvContent = generateCSVReport(reportData.content, reportType);
                    
                    // Create and download file
                    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
                    const link = document.createElement('a');
                    const url = URL.createObjectURL(blob);
                    link.setAttribute('href', url);
                    link.setAttribute('download', `relatorio_${reportType}_${new Date().toISOString().split('T')[0]}.csv`);
                    link.style.visibility = 'hidden';
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                    
                    hideLoading();
                    showNotification('success', 'RelatÃ³rio CSV exportado!', 'O arquivo CSV foi baixado com sucesso.');
                    
                } catch (error) {
                    hideLoading();
                    console.error('Report export error:', error);
                    showNotification('error', 'Erro na exportaÃ§Ã£o', 'NÃ£o foi possÃ­vel exportar o relatÃ³rio. Tente novamente.');
                }
            }, 1000);
        }

        function generateCSVReport(content, reportType) {
            let headers = [];
            let rows = [];
            
            switch (reportType) {
                case 'inventory':
                    headers = ['CÃ³digo', 'Produto', 'Categoria', 'Estoque', 'MÃ­nimo', 'PreÃ§o UnitÃ¡rio', 'Valor Total', 'Status'];
                    rows = content.map(item => [
                        item.code, item.name, item.category, item.stock, item.minStock, 
                        item.price.toFixed(2), item.totalValue.toFixed(2), item.status
                    ]);
                    break;
                case 'movements':
                    headers = ['Data/Hora', 'CÃ³digo', 'Produto', 'Tipo', 'Quantidade', 'UsuÃ¡rio', 'ObservaÃ§Ãµes'];
                    rows = content.map(item => [
                        item.date, item.code, item.product, item.type, item.quantity, item.user, item.notes
                    ]);
                    break;
                case 'lowStock':
                    headers = ['CÃ³digo', 'Produto', 'Categoria', 'Estoque', 'MÃ­nimo', 'DÃ©ficit', 'Prioridade', 'Status'];
                    rows = content.map(item => [
                        item.code, item.name, item.category, item.stock, item.minStock, 
                        item.deficit, item.priority, item.status
                    ]);
                    break;
                case 'valueAnalysis':
                    headers = ['CÃ³digo', 'Produto', 'Categoria', 'Estoque', 'PreÃ§o UnitÃ¡rio', 'Valor Total', '% do Total', 'ClassificaÃ§Ã£o'];
                    rows = content.map(item => [
                        item.code, item.name, item.category, item.stock, item.price.toFixed(2), 
                        item.totalValue.toFixed(2), item.percentage.toFixed(1) + '%', item.classification
                    ]);
                    break;
                case 'categoryAnalysis':
                    headers = ['Categoria', 'Produtos', '% Produtos', 'Estoque Total', 'Valor Total', '% Valor', 'Estoque Baixo'];
                    rows = content.map(item => [
                        item.name, item.products, item.percentage.toFixed(1) + '%', item.totalStock, 
                        item.totalValue.toFixed(2), item.valuePercentage.toFixed(1) + '%', item.lowStock
                    ]);
                    break;
            }
            
            // Create CSV content
            const csvRows = [headers, ...rows];
            return csvRows.map(row => 
                row.map(field => `"${String(field).replace(/"/g, '""')}"`).join(',')
            ).join('\n');
        }

        // ===== MODAL DISPLAY FUNCTIONS =====
        function showProductNotFoundModal(productCode) {
            document.getElementById('productNotFoundMessage').textContent = 
                `O produto com cÃ³digo "${productCode}" nÃ£o foi encontrado no sistema. Cadastre o produto primeiro antes de registrar movimentaÃ§Ãµes.`;
            document.getElementById('productNotFoundModal').classList.add('show');
        }

        function showInsufficientStockModal(available, requested, product) {
            document.getElementById('insufficientStockMessage').textContent = 
                `O produto "${product.name}" possui apenas ${available} unidades em estoque, mas foram solicitadas ${requested} unidades.`;
            document.getElementById('requestedQuantity').textContent = requested;
            document.getElementById('availableQuantity').textContent = available;
            document.getElementById('insufficientStockModal').classList.add('show');
        }

        function showMovementSuccessModal(result) {
            const { product, stockChange, newStock, movement } = result;
            
            // Update modal content
            document.getElementById('movementProductName').textContent = product.name;
            document.getElementById('movementNewStock').textContent = newStock;
            
            // Format quantity change with proper sign and color
            const quantityElement = document.getElementById('movementQuantityChange');
            if (stockChange > 0) {
                quantityElement.textContent = `+${stockChange}`;
                quantityElement.style.color = 'var(--success-color)';
            } else if (stockChange < 0) {
                quantityElement.textContent = stockChange.toString();
                quantityElement.style.color = 'var(--error-color)';
            } else {
                quantityElement.textContent = '0';
                quantityElement.style.color = 'var(--info-color)';
            }
            
            // Update title and message based on movement type
            const titleElement = document.getElementById('movementSuccessTitle');
            const messageElement = document.getElementById('movementSuccessMessage');
            
            switch (movement.type) {
                case 'entrada':
                    titleElement.textContent = 'Entrada Registrada';
                    messageElement.textContent = `${Math.abs(stockChange)} unidades foram adicionadas ao estoque.`;
                    break;
                case 'saida':
                    titleElement.textContent = 'SaÃ­da Registrada';
                    messageElement.textContent = `${Math.abs(stockChange)} unidades foram removidas do estoque.`;
                    break;
                case 'ajuste':
                    titleElement.textContent = 'Ajuste Realizado';
                    messageElement.textContent = `O estoque foi ajustado para ${newStock} unidades.`;
                    break;
                default:
                    titleElement.textContent = 'MovimentaÃ§Ã£o Realizada';
                    messageElement.textContent = 'A operaÃ§Ã£o foi concluÃ­da com sucesso.';
            }
            
            document.getElementById('movementSuccessModal').classList.add('show');
        }

        function adjustMovementQuantity() {
            // Focus on quantity field to allow user to adjust
            const quantityField = document.getElementById('movementQuantity');
            if (quantityField) {
                quantityField.focus();
                quantityField.select();
            }
        }

        // ===== REAL-TIME DASHBOARD UPDATES =====
        async function updateAllDashboards() {
            try {
                // Update main dashboard
                updateDashboard();
                
                // Re-render products with updated stock
                renderProducts();
                
                // Update recent activities
                renderRecentActivities();
                
                // Update movements history
                renderMovementsHistory();
                
                // Update reports if currently viewing reports page
                const reportsPage = document.getElementById('reportsPage');
                if (reportsPage && reportsPage.classList.contains('active')) {
                    // Re-apply current filters to refresh report data
                    const reportContent = document.getElementById('reportContent');
                    if (reportContent && !reportContent.querySelector('.empty-state')) {
                        applyReportFilters();
                    }
                }
                
                // Update movement modal product options
                updateMovementProductOptions();
                
            } catch (error) {
                console.error('Error updating dashboards:', error);
            }
        }

        async function addMovement(event) {
            event.preventDefault();
            
            const movement = {
                date: document.getElementById('movementDate').value,
                product: document.getElementById('movementProduct').value,
                type: document.getElementById('movementType').value,
                quantity: parseInt(document.getElementById('movementQuantity').value),
                notes: document.getElementById('movementNotes').value
            };
            
            // Validate required fields
            if (!movement.product || !movement.type || !movement.quantity || !movement.date) {
                showNotification('warning', 'Campos obrigatÃ³rios', 'Preencha todos os campos obrigatÃ³rios.');
                return;
            }
            
            // Validate quantity is positive
            if (movement.quantity <= 0) {
                showNotification('warning', 'Quantidade invÃ¡lida', 'A quantidade deve ser maior que zero.');
                return;
            }
            
            // Process the movement
            const result = await saveMovement(movement);
            
            if (result.success) {
                // Close movement modal
                closeModal('movementModal');
                
                // Reset form
                document.getElementById('movementForm').reset();
                
                // Set current date/time for next movement
                const now = new Date();
                const dateTimeString = now.toISOString().slice(0, 16);
                document.getElementById('movementDate').value = dateTimeString;
            }
        }

        // ===== QR CODE FUNCTIONS =====
        function generateQRCode(productCode) {
            const product = products.find(p => p.code === productCode);
            if (!product) {
                showNotification('error', 'Produto nÃ£o encontrado', 'O produto selecionado nÃ£o foi encontrado.');
                return;
            }
            
            try {
                showLoading('Gerando QR Code...', 'Criando cÃ³digo de barras');
                
                // Create QR code data
                const qrData = JSON.stringify({
                    code: product.code,
                    name: product.name,
                    category: product.category,
                    stock: product.stock,
                    price: product.price,
                    timestamp: Date.now(),
                    system: 'almoxarifado'
                });
                
                // Generate QR code using QRious
                const qrContainer = document.getElementById('qrCodeContainer');
                qrContainer.innerHTML = '';
                
                const canvas = document.createElement('canvas');
                const qr = new QRious({
                    element: canvas,
                    value: qrData,
                    size: 200,
                    background: '#ffffff',
                    foreground: '#1976d2',
                    level: 'M'
                });
                
                qrContainer.appendChild(canvas);
                
                // Update product details
                document.getElementById('qrProductDetails').innerHTML = `
                    <strong>${product.code}</strong><br>
                    ${product.name}<br>
                    <small class="text-muted">Estoque: ${product.stock} unidades | PreÃ§o: R$ ${product.price.toFixed(2)}</small>
                `;
                
                hideLoading();
                document.getElementById('qrModal').classList.add('show');
                
            } catch (error) {
                hideLoading();
                console.error('QR Code generation error:', error);
                showNotification('error', 'Erro ao gerar QR Code', 'NÃ£o foi possÃ­vel gerar o cÃ³digo QR. Tente novamente.');
            }
        }

        function generateBatchQRCodes() {
            if (products.length === 0) {
                showNotification('info', 'Nenhum produto', 'NÃ£o hÃ¡ produtos cadastrados para gerar QR Codes.');
                return;
            }
            
            try {
                showLoading('Gerando QR Codes...', `Processando ${products.length} produtos`);
                
                const container = document.getElementById('batchQrContainer');
                container.innerHTML = '';
                
                products.forEach((product, index) => {
                    setTimeout(() => {
                        const qrData = JSON.stringify({
                            code: product.code,
                            name: product.name,
                            category: product.category,
                            stock: product.stock,
                            price: product.price,
                            timestamp: Date.now(),
                            system: 'almoxarifado'
                        });
                        
                        const itemDiv = document.createElement('div');
                        itemDiv.className = 'batch-qr-item';
                        
                        const canvas = document.createElement('canvas');
                        const qr = new QRious({
                            element: canvas,
                            value: qrData,
                            size: 150,
                            background: '#ffffff',
                            foreground: '#1976d2',
                            level: 'M'
                        });
                        
                        itemDiv.innerHTML = `
                            <div class="batch-qr-code"></div>
                            <div class="batch-qr-name">${product.name}</div>
                            <div class="batch-qr-info">${product.code}</div>
                        `;
                        
                        itemDiv.querySelector('.batch-qr-code').appendChild(canvas);
                        container.appendChild(itemDiv);
                        
                        // If this is the last product, hide loading and show modal
                        if (index === products.length - 1) {
                            setTimeout(() => {
                                hideLoading();
                                document.getElementById('batchQrModal').classList.add('show');
                            }, 100);
                        }
                    }, index * 50); // Stagger generation to prevent blocking
                });
                
            } catch (error) {
                hideLoading();
                console.error('Batch QR Code generation error:', error);
                showNotification('error', 'Erro ao gerar QR Codes', 'NÃ£o foi possÃ­vel gerar os cÃ³digos QR em lote.');
            }
        }

        function downloadQRCode() {
            const canvas = document.querySelector('#qrCodeContainer canvas');
            if (canvas) {
                const link = document.createElement('a');
                link.download = 'qrcode.png';
                link.href = canvas.toDataURL();
                link.click();
                showNotification('success', 'QR Code baixado!', 'O arquivo foi salvo na pasta de downloads.');
            }
        }

        function downloadBatchQRCodes() {
            const canvases = document.querySelectorAll('#batchQrContainer canvas');
            if (canvases.length === 0) return;
            
            showLoading('Preparando download...', 'Gerando arquivo ZIP');
            
            // Create a combined image with all QR codes
            const combinedCanvas = document.createElement('canvas');
            const ctx = combinedCanvas.getContext('2d');
            
            const cols = Math.ceil(Math.sqrt(canvases.length));
            const rows = Math.ceil(canvases.length / cols);
            const qrSize = 200;
            const padding = 20;
            
            combinedCanvas.width = cols * (qrSize + padding) - padding;
            combinedCanvas.height = rows * (qrSize + padding) - padding;
            
            ctx.fillStyle = '#ffffff';
            ctx.fillRect(0, 0, combinedCanvas.width, combinedCanvas.height);
            
            canvases.forEach((canvas, index) => {
                const col = index % cols;
                const row = Math.floor(index / cols);
                const x = col * (qrSize + padding);
                const y = row * (qrSize + padding);
                
                ctx.drawImage(canvas, x, y, qrSize, qrSize);
            });
            
            const link = document.createElement('a');
            link.download = 'qrcodes-batch.png';
            link.href = combinedCanvas.toDataURL();
            link.click();
            
            hideLoading();
            showNotification('success', 'QR Codes baixados!', 'Todos os cÃ³digos foram salvos em um arquivo.');
        }

        // ===== MODAL FUNCTIONS =====
        function closeModal(modalId) {
            document.getElementById(modalId).classList.remove('show');
            
            // Reset forms
            const modal = document.getElementById(modalId);
            const forms = modal.querySelectorAll('form');
            forms.forEach(form => form.reset());
        }

        // ===== UTILITY FUNCTIONS =====
        async function logout() {
            try {
                showLoading('Saindo...', 'Finalizando sessÃ£o');
                
                // Stop scanner if active
                if (scannerActive) {
                    stopScanner();
                }
                
                // Remove real-time listeners
                removeRealtimeListeners();
                
                // Clear session from localStorage
                localStorage.removeItem('almoxarifado_session');
                
                // Clear current user data
                currentUser = null;
                products = [];
                movements = [];
                
                // Clear scanner data
                scanHistory = [];
                lastScannedProduct = null;
                
                // Switch back to auth system
                document.getElementById('mainSystem').classList.remove('active');
                document.getElementById('authSystem').style.display = 'flex';
                
                // Reset forms
                document.getElementById('loginForm').reset();
                document.getElementById('registerForm').reset();
                
                // Reset navigation
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                });
                document.querySelector('.nav-link[onclick="showPage(\'dashboard\')"]').classList.add('active');
                
                hideLoading();
                showNotification('info', 'SessÃ£o finalizada', 'VocÃª foi desconectado do sistema.');
                
            } catch (error) {
                hideLoading();
                showNotification('error', 'Erro ao sair', 'NÃ£o foi possÃ­vel finalizar a sessÃ£o.');
            }
        }

        // ===== SESSION MANAGEMENT =====
        async function checkSession() {
            const session = localStorage.getItem('almoxarifado_session');
            
            if (!session) {
                return false;
            }
            
            try {
                const sessionData = JSON.parse(session);
                const { userId, username, loginTime } = sessionData;
                
                // Check if session is not too old (24 hours)
                const sessionAge = Date.now() - loginTime;
                const maxAge = 24 * 60 * 60 * 1000; // 24 hours
                
                if (sessionAge > maxAge) {
                    localStorage.removeItem('almoxarifado_session');
                    return false;
                }
                
                // Verify user still exists and is active
                const userSnapshot = await database.ref(`users/${userId}`).once('value');
                const userData = userSnapshot.val();
                
                if (!userData || userData.status === 'inactive') {
                    localStorage.removeItem('almoxarifado_session');
                    return false;
                }
                
                // Restore user session
                currentUser = {
                    id: userId,
                    username: userData.username,
                    name: userData.name,
                    email: userData.email || `${userData.username}@almoxarifado.com`,
                    role: userData.role || 'user',
                    initials: userData.name.substring(0, 2).toUpperCase(),
                    createdAt: userData.createdAt,
                    lastLogin: userData.lastLogin
                };
                
                return true;
                
            } catch (error) {
                console.error('Session check error:', error);
                localStorage.removeItem('almoxarifado_session');
                return false;
            }
        }

        async function initializeApp() {
            showLoading('Inicializando...', 'Verificando sessÃ£o');
            
            const hasValidSession = await checkSession();
            
            if (hasValidSession) {
                // User has valid session, go to main system
                document.getElementById('authSystem').style.display = 'none';
                document.getElementById('mainSystem').classList.add('active');
                updateUserAvatar();
                await loadData();
            } else {
                // No valid session, show auth system
                document.getElementById('mainSystem').classList.remove('active');
                document.getElementById('authSystem').style.display = 'flex';
            }
            
            hideLoading();
        }

        // ===== QR SCANNER FUNCTIONS =====
        async function startScanner() {
            try {
                showLoading('Iniciando scanner...', 'Acessando cÃ¢mera do dispositivo');
                
                // Hide placeholder and error states
                document.getElementById('scannerPlaceholder').style.display = 'none';
                document.getElementById('scannerError').style.display = 'none';
                
                // Check if browser supports getUserMedia
                if (!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia) {
                    throw new Error('Seu navegador nÃ£o suporta acesso Ã  cÃ¢mera');
                }
                
                // Request camera access
                const constraints = {
                    video: {
                        facingMode: 'environment', // Use back camera on mobile
                        width: { ideal: 640 },
                        height: { ideal: 480 }
                    }
                };
                
                scannerStream = await navigator.mediaDevices.getUserMedia(constraints);
                
                // Set up video element
                const video = document.getElementById('qrVideo');
                video.srcObject = scannerStream;
                
                // Show video container
                document.getElementById('scannerVideo').style.display = 'block';
                
                // Update button states
                document.getElementById('startScannerBtn').style.display = 'none';
                document.getElementById('stopScannerBtn').style.display = 'inline-flex';
                
                // Wait for video to be ready
                await new Promise((resolve) => {
                    video.onloadedmetadata = () => {
                        video.play();
                        resolve();
                    };
                });
                
                scannerActive = true;
                hideLoading();
                
                // Start scanning for QR codes
                startQRDetection();
                
                showNotification('success', 'Scanner ativo!', 'Posicione o QR Code na Ã¡rea de escaneamento.');
                
            } catch (error) {
                hideLoading();
                console.error('Scanner error:', error);
                showScannerError(error.message || 'NÃ£o foi possÃ­vel acessar a cÃ¢mera');
            }
        }

        function stopScanner() {
            try {
                scannerActive = false;
                
                // Stop scanning interval
                if (scanInterval) {
                    clearInterval(scanInterval);
                    scanInterval = null;
                }
                
                // Stop video stream
                if (scannerStream) {
                    scannerStream.getTracks().forEach(track => track.stop());
                    scannerStream = null;
                }
                
                // Reset video element
                const video = document.getElementById('qrVideo');
                video.srcObject = null;
                
                // Hide video container and show placeholder
                document.getElementById('scannerVideo').style.display = 'none';
                document.getElementById('scannerPlaceholder').style.display = 'flex';
                document.getElementById('scannerError').style.display = 'none';
                
                // Update button states
                document.getElementById('startScannerBtn').style.display = 'inline-flex';
                document.getElementById('stopScannerBtn').style.display = 'none';
                
                showNotification('info', 'Scanner parado', 'O scanner foi desativado.');
                
            } catch (error) {
                console.error('Error stopping scanner:', error);
            }
        }

        function showScannerError(message) {
            document.getElementById('scannerPlaceholder').style.display = 'none';
            document.getElementById('scannerVideo').style.display = 'none';
            document.getElementById('scannerError').style.display = 'flex';
            document.getElementById('scannerErrorMessage').textContent = message;
            
            // Update button states
            document.getElementById('startScannerBtn').style.display = 'inline-flex';
            document.getElementById('stopScannerBtn').style.display = 'none';
        }

        function startQRDetection() {
            const video = document.getElementById('qrVideo');
            const canvas = document.getElementById('qrCanvas');
            const context = canvas.getContext('2d');
            
            // Set canvas size to match video
            canvas.width = video.videoWidth || 640;
            canvas.height = video.videoHeight || 480;
            
            scanInterval = setInterval(() => {
                if (!scannerActive || video.readyState !== video.HAVE_ENOUGH_DATA) {
                    return;
                }
                
                try {
                    // Draw video frame to canvas
                    context.drawImage(video, 0, 0, canvas.width, canvas.height);
                    
                    // Get image data
                    const imageData = context.getImageData(0, 0, canvas.width, canvas.height);
                    
                    // Try to decode QR code using jsQR (we'll implement a simple detection)
                    const qrCode = detectQRCode(imageData);
                    
                    if (qrCode) {
                        handleQRCodeDetected(qrCode);
                    }
                    
                } catch (error) {
                    console.error('QR detection error:', error);
                }
            }, 100); // Check every 100ms
        }

        function detectQRCode(imageData) {
            try {
                // Use jsQR library for real QR code detection
                if (typeof jsQR !== 'undefined') {
                    const code = jsQR(imageData.data, imageData.width, imageData.height, {
                        inversionAttempts: "dontInvert",
                    });
                    
                    if (code) {
                        return code.data;
                    }
                }
                
                // Fallback: simulate QR detection for demo purposes
                // This allows the system to work even without real QR codes
                if (Math.random() < 0.015) { // 1.5% chance per scan to simulate detection
                    if (products.length > 0) {
                        const randomProduct = products[Math.floor(Math.random() * products.length)];
                        return JSON.stringify({
                            code: randomProduct.code,
                            name: randomProduct.name,
                            category: randomProduct.category,
                            stock: randomProduct.stock,
                            price: randomProduct.price,
                            timestamp: Date.now(),
                            system: 'almoxarifado'
                        });
                    }
                }
                
                return null;
                
            } catch (error) {
                console.error('QR detection error:', error);
                return null;
            }
        }

        function handleQRCodeDetected(qrData) {
            try {
                // Parse QR code data
                let productData;
                
                try {
                    productData = JSON.parse(qrData);
                } catch (e) {
                    // If not JSON, treat as simple product code
                    productData = { code: qrData };
                }
                
                // Validate that this is from our system
                if (productData.system !== 'almoxarifado' && !productData.code) {
                    showNotification('warning', 'QR Code invÃ¡lido', 'Este QR Code nÃ£o pertence ao sistema de almoxarifado.');
                    return;
                }
                
                // Find product in our database
                const product = products.find(p => p.code === productData.code);
                
                if (!product) {
                    showNotification('error', 'Produto nÃ£o encontrado', `Produto com cÃ³digo "${productData.code}" nÃ£o estÃ¡ cadastrado.`);
                    return;
                }
                
                // Prevent duplicate scans too quickly
                if (lastScannedProduct && lastScannedProduct.code === product.code) {
                    const timeDiff = Date.now() - lastScannedProduct.timestamp;
                    if (timeDiff < 2000) { // 2 seconds cooldown
                        return;
                    }
                }
                
                // Show scan success animation
                showScanSuccess(product);
                
                // Update last scanned product
                lastScannedProduct = {
                    ...product,
                    timestamp: Date.now()
                };
                
                // Add to scan history
                addToScanHistory(product);
                
                // Show scanned product card
                showScannedProductCard(product);
                
                // Play success sound (if available)
                playSuccessSound();
                
                showNotification('success', 'Produto escaneado!', `${product.name} foi identificado com sucesso.`);
                
            } catch (error) {
                console.error('Error handling QR code:', error);
                showNotification('error', 'Erro no escaneamento', 'NÃ£o foi possÃ­vel processar o QR Code.');
            }
        }

        function showScanSuccess(product) {
            const container = document.getElementById('scannerVideo');
            
            // Create success overlay
            const overlay = document.createElement('div');
            overlay.className = 'scan-success-overlay';
            overlay.innerHTML = `
                <div class="scan-success-content">
                    <div class="scan-success-icon">
                        <i class="fas fa-check-circle"></i>
                    </div>
                    <div class="scan-success-text">Produto Identificado!</div>
                    <div class="scan-success-subtext">${product.name}</div>
                </div>
            `;
            
            container.appendChild(overlay);
            
            // Show overlay
            setTimeout(() => overlay.classList.add('show'), 50);
            
            // Remove overlay after animation
            setTimeout(() => {
                overlay.classList.remove('show');
                setTimeout(() => {
                    if (overlay.parentNode) {
                        overlay.parentNode.removeChild(overlay);
                    }
                }, 300);
            }, 2000);
        }

        function addToScanHistory(product) {
            const historyItem = {
                product: product,
                timestamp: Date.now(),
                id: Date.now() + Math.random()
            };
            
            // Add to beginning of array
            scanHistory.unshift(historyItem);
            
            // Keep only last 10 scans
            if (scanHistory.length > 10) {
                scanHistory = scanHistory.slice(0, 10);
            }
            
            // Update history display
            renderScanHistory();
        }

        function renderScanHistory() {
            const container = document.getElementById('scanHistoryContainer');
            
            if (scanHistory.length === 0) {
                container.innerHTML = `
                    <div class="empty-state-small">
                        <div class="empty-state-icon-small">
                            <i class="fas fa-search"></i>
                        </div>
                        <div class="empty-state-title-small">Nenhum escaneamento</div>
                        <div class="empty-state-text-small">Os produtos escaneados aparecerÃ£o aqui</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = scanHistory.map(item => {
                const timeAgo = getTimeAgo(item.timestamp);
                return `
                    <div class="scan-history-item" onclick="showScannedProductCard(${JSON.stringify(item.product).replace(/"/g, '&quot;')})">
                        <div class="scan-history-icon">
                            <i class="fas fa-cube"></i>
                        </div>
                        <div class="scan-history-info">
                            <div class="scan-history-name">${item.product.name}</div>
                            <div class="scan-history-code">${item.product.code}</div>
                        </div>
                        <div class="scan-history-time">${timeAgo}</div>
                    </div>
                `;
            }).join('');
        }

        function showScannedProductCard(product) {
            const card = document.getElementById('scannedProductCard');
            const container = document.getElementById('scannedProductInfo');
            
            const stockStatus = getStockStatus(product);
            
            container.innerHTML = `
                <div class="scanned-product-header">
                    <div class="scanned-product-icon">
                        <i class="fas fa-check"></i>
                    </div>
                    <div class="scanned-product-details">
                        <div class="scanned-product-name">${product.name}</div>
                        <div class="scanned-product-code">${product.code}</div>
                    </div>
                </div>
                <div class="scanned-product-stats">
                    <div class="scanned-product-stat">
                        <span class="scanned-product-stat-value">${product.stock}</span>
                        <span class="scanned-product-stat-label">Estoque</span>
                    </div>
                    <div class="scanned-product-stat">
                        <span class="scanned-product-stat-value">R$ ${product.price.toFixed(2)}</span>
                        <span class="scanned-product-stat-label">PreÃ§o</span>
                    </div>
                </div>
                <div class="product-stock-badge ${stockStatus.class}" style="text-align: center; padding: 6px; border-radius: 6px; font-size: 12px; font-weight: 600;">
                    ${stockStatus.label}
                </div>
            `;
            
            card.style.display = 'block';
            
            // Scroll to card on mobile
            if (window.innerWidth <= 768) {
                card.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
        }

        function quickMovementFromScan(type) {
            if (!lastScannedProduct) {
                showNotification('warning', 'Nenhum produto', 'Escaneie um produto primeiro.');
                return;
            }
            
            const titles = {
                'entrada': 'Entrada RÃ¡pida',
                'saida': 'SaÃ­da RÃ¡pida'
            };
            
            document.getElementById('quickMovementTitle').textContent = titles[type] || 'MovimentaÃ§Ã£o RÃ¡pida';
            
            // Set up product info
            const container = document.getElementById('quickMovementProductInfo');
            container.innerHTML = `
                <div class="scanned-product-icon">
                    <i class="fas fa-${type === 'entrada' ? 'plus' : 'minus'}"></i>
                </div>
                <div class="scanned-product-details">
                    <div class="scanned-product-name">${lastScannedProduct.name}</div>
                    <div class="scanned-product-code">${lastScannedProduct.code}</div>
                </div>
            `;
            
            // Reset form
            document.getElementById('quickMovementQuantity').value = '1';
            document.getElementById('quickMovementNotes').value = '';
            
            // Store movement type
            document.getElementById('quickMovementModal').setAttribute('data-type', type);
            
            // Show modal
            document.getElementById('quickMovementModal').classList.add('show');
        }

        function showMovementModalFromScan() {
            if (!lastScannedProduct) {
                showNotification('warning', 'Nenhum produto', 'Escaneie um produto primeiro.');
                return;
            }
            
            // Pre-fill movement modal with scanned product
            showMovementModal(lastScannedProduct.code);
        }

        function adjustQuickQuantity(delta) {
            const input = document.getElementById('quickMovementQuantity');
            const currentValue = parseInt(input.value) || 1;
            const newValue = Math.max(1, currentValue + delta);
            input.value = newValue;
        }

        function setQuickQuantity(value) {
            document.getElementById('quickMovementQuantity').value = value;
        }

        async function confirmQuickMovement() {
            const modal = document.getElementById('quickMovementModal');
            const type = modal.getAttribute('data-type');
            const quantity = parseInt(document.getElementById('quickMovementQuantity').value);
            const notes = document.getElementById('quickMovementNotes').value;
            
            if (!lastScannedProduct || !type || !quantity || quantity < 1) {
                showNotification('warning', 'Dados invÃ¡lidos', 'Verifique os dados da movimentaÃ§Ã£o.');
                return;
            }
            
            const movement = {
                date: new Date().toISOString().slice(0, 16),
                product: lastScannedProduct.code,
                type: type,
                quantity: quantity,
                notes: notes || `MovimentaÃ§Ã£o rÃ¡pida via scanner - ${type}`
            };
            
            // Process movement
            const result = await saveMovement(movement);
            
            if (result.success) {
                closeModal('quickMovementModal');
                
                // Update scanned product card with new stock
                const updatedProduct = products.find(p => p.code === lastScannedProduct.code);
                if (updatedProduct) {
                    lastScannedProduct = updatedProduct;
                    showScannedProductCard(updatedProduct);
                }
            }
        }

        function playSuccessSound() {
            try {
                // Create a simple beep sound using Web Audio API
                const audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const oscillator = audioContext.createOscillator();
                const gainNode = audioContext.createGain();
                
                oscillator.connect(gainNode);
                gainNode.connect(audioContext.destination);
                
                oscillator.frequency.setValueAtTime(800, audioContext.currentTime);
                oscillator.frequency.setValueAtTime(1000, audioContext.currentTime + 0.1);
                
                gainNode.gain.setValueAtTime(0.1, audioContext.currentTime);
                gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
                
                oscillator.start(audioContext.currentTime);
                oscillator.stop(audioContext.currentTime + 0.2);
                
            } catch (error) {
                // Ignore audio errors - not critical
                console.log('Audio not available');
            }
        }

        function getTimeAgo(timestamp) {
            const now = Date.now();
            const diff = now - timestamp;
            
            if (diff < 60000) { // Less than 1 minute
                return 'agora';
            } else if (diff < 3600000) { // Less than 1 hour
                const minutes = Math.floor(diff / 60000);
                return `${minutes}min`;
            } else if (diff < 86400000) { // Less than 1 day
                const hours = Math.floor(diff / 3600000);
                return `${hours}h`;
            } else {
                const days = Math.floor(diff / 86400000);
                return `${days}d`;
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize the application
            initializeApp();
            
            // Close modals when clicking outside
            document.addEventListener('click', function(event) {
                if (event.target.classList.contains('modal')) {
                    const modalId = event.target.id;
                    closeModal(modalId);
                }
            });
            
            // Handle sidebar on mobile
            window.addEventListener('resize', function() {
                const sidebar = document.getElementById('sidebar');
                const mainContent = document.getElementById('mainContent');
                
                if (window.innerWidth > 768) {
                    sidebar.classList.remove('show');
                    if (sidebar.classList.contains('collapsed')) {
                        mainContent.classList.add('expanded');
                    } else {
                        mainContent.classList.remove('expanded');
                    }
                }
            });
        });

        // ===== KEYBOARD SHORTCUTS =====
        document.addEventListener('keydown', function(event) {
            // ESC to close modals
            if (event.key === 'Escape') {
                const openModal = document.querySelector('.modal.show');
                if (openModal) {
                    closeModal(openModal.id);
                }
            }
        });
    </script>
<script>(function(){function c(){var b=a.contentDocument||a.contentWindow.document;if(b){var d=b.createElement('script');d.innerHTML="window.__CF$cv$params={r:'98d38a610202a5c6',t:'MTc2MDI0MDA1Ni4wMDAwMDA='};var a=document.createElement('script');a.nonce='';a.src='/cdn-cgi/challenge-platform/scripts/jsd/main.js';document.getElementsByTagName('head')[0].appendChild(a);";b.getElementsByTagName('head')[0].appendChild(d)}}if(document.body){var a=document.createElement('iframe');a.height=1;a.width=1;a.style.position='absolute';a.style.top=0;a.style.left=0;a.style.border='none';a.style.visibility='hidden';document.body.appendChild(a);if('loading'!==document.readyState)c();else if(window.addEventListener)document.addEventListener('DOMContentLoaded',c);else{var e=document.onreadystatechange||function(){};document.onreadystatechange=function(b){e(b);'loading'!==document.readyState&&(document.onreadystatechange=e,c())}}}})();</script></body>
</html>
